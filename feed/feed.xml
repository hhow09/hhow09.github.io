<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom" xml:base="en">
	<title>hhow09&#39;s Blog</title>
	<subtitle>sofware engineering stuff</subtitle>
	<link href="https://hhow09.github.io/feed/feed.xml" rel="self"/>
	<link href="https://hhow09.github.io/"/>
	<updated>2026-02-01T00:00:00Z</updated>
	<id>https://hhow09.github.io/</id>
	<author>
		<name>HH</name>
		<email>hhow09@gmail.com</email>
	</author>
	
	<entry>
		<title>Incremental Type Safety: Adopting Strict Mode in Large Projects</title>
		<link href="https://hhow09.github.io/blog/incremental-code-quality/"/>
		<updated>2026-02-01T00:00:00Z</updated>
		<id>https://hhow09.github.io/blog/incremental-code-quality/</id>
		<content type="html">&lt;p&gt;In my &lt;a href=&quot;https://hhow09.github.io/blog/code-quality/&quot;&gt;previous post&lt;/a&gt;, I discussed how type checking serves as a primary tool to catch errors at compile time.&lt;/p&gt;
&lt;p&gt;This post explores how I helped my team to ensure type safety &lt;strong&gt;incrementally&lt;/strong&gt; in a large project without disrupting feature development.&lt;/p&gt;
&lt;h2 id=&quot;why-is-type-safety-important&quot; tabindex=&quot;-1&quot;&gt;Why is type safety important? &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/incremental-code-quality/#why-is-type-safety-important&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;Confidence in change&lt;/strong&gt;: When you change code or upgrade dependencies, the compiler will catch missing type errors.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Prevent unexpected runtime errors&lt;/strong&gt;: It prevents an entire class of runtime logic errors by ensuring data structures are handled predictably.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;However, for a legacy codebase, enabling type checking with &lt;code&gt;tsc&lt;/code&gt; often results in thousands of errors. Fixing them all at once is rarely feasible without disrupting feature development. Yet fixing them without actually enabling type checking cannot prevent new type errors from being introduced.&lt;/p&gt;
&lt;h2 id=&quot;the-strategy-incremental-adoption&quot; tabindex=&quot;-1&quot;&gt;The Strategy: Incremental adoption &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/incremental-code-quality/#the-strategy-incremental-adoption&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;For most teams, spending an entire sprint fixing type errors is not practical.&lt;/p&gt;
&lt;p&gt;The goal is to move towards a strict type checking environment without a &amp;quot;big bang&amp;quot; refactor. I followed two principles:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;New code must be strict&lt;/strong&gt;: Stop the broken window.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Existing code is fixed as it&#39;s touched&lt;/strong&gt;: Refactor legacy files during feature updates.&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&quot;initiatives-in-typescript-repo&quot; tabindex=&quot;-1&quot;&gt;Initiatives in typescript repo &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/incremental-code-quality/#initiatives-in-typescript-repo&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;I started my survey with the following issues in typescript repo:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/microsoft/TypeScript/issues/8405&quot;&gt;Issue: Support overriding type-checking compile flags on a per file basis&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/microsoft/TypeScript/issues/28306&quot;&gt;Issue: Strict type-checking on a per-file basis &amp;quot;@ts-strict&amp;quot;&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;They are either not adopted or still open.&lt;/p&gt;
&lt;p&gt;After turning to other open source tools, I found the following the cleanest to use.&lt;/p&gt;
&lt;h2 id=&quot;fixing-frontend-project&quot; tabindex=&quot;-1&quot;&gt;Fixing frontend project &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/incremental-code-quality/#fixing-frontend-project&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;Our project uses webpack as the bundler. With &lt;a href=&quot;https://github.com/TypeStrong/fork-ts-checker-webpack-plugin&quot;&gt;fork-ts-checker-webpack-plugin&lt;/a&gt;, we can run type checking within the webpack build process (&lt;code&gt;npm run build&lt;/code&gt;).&lt;/p&gt;
&lt;h3 id=&quot;1-progressive-allowlist&quot; tabindex=&quot;-1&quot;&gt;1. Progressive allowlist &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/incremental-code-quality/#1-progressive-allowlist&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;Start with an allowlist of files that are already fixed.&lt;/p&gt;
&lt;pre class=&quot;language-js&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-js&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;ForkTsCheckerWebpackPlugin&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token literal-property property&quot;&gt;files&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;src/path/to/safe/file.ts&quot;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;src/path/to/safe-folder/**/*.ts&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;At this point, the listed files are ensured to be type safe.&lt;/p&gt;
&lt;h3 id=&quot;2-track-known-errors&quot; tabindex=&quot;-1&quot;&gt;2. Track &lt;strong&gt;known errors&lt;/strong&gt; &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/incremental-code-quality/#2-track-known-errors&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;At a certain point, most files are already fixed. We can then include all files in the checker and track known errors to catch remaining type errors through issue filtering.&lt;/p&gt;
&lt;pre class=&quot;language-js&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-js&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; knowTSErrors &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;require&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;./knowTSErrors.json&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;/// ...&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;ForkTsCheckerWebpackPlugin&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token literal-property property&quot;&gt;files&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;src/**/*.ts&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token literal-property property&quot;&gt;issue&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token function-variable function&quot;&gt;exclude&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;issue&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt;
            knowTSErrors&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;some&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;item&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
                &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; codeMatches &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; issue&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;code &lt;span class=&quot;token operator&quot;&gt;===&lt;/span&gt; item&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;code
                &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; fileMatches &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; issue&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;file&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;includes&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;item&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;file&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
                &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; severityMatches &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; issue&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;severity &lt;span class=&quot;token operator&quot;&gt;===&lt;/span&gt; item&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;severity
                &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; codeMatches &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; fileMatches &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; severityMatches
            &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;code&gt;knowTSErrors.json&lt;/code&gt;.&lt;/p&gt;
&lt;pre class=&quot;language-json&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-json&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token property&quot;&gt;&quot;code&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;TS2339&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;token property&quot;&gt;&quot;severity&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;error&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;token property&quot;&gt;&quot;file&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;src/path/to/error/file.ts&quot;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token property&quot;&gt;&quot;code&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;TS2564&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;token property&quot;&gt;&quot;severity&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;error&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;token property&quot;&gt;&quot;file&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;src/path/to/error/file.ts&quot;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;At this point, the entire project except the listed files is ensured to be type safe.&lt;/p&gt;
&lt;p&gt;The rest is fixing the remaining type errors.&lt;/p&gt;
&lt;h2 id=&quot;fixing-general-node-js-projects&quot; tabindex=&quot;-1&quot;&gt;Fixing general Node.js projects &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/incremental-code-quality/#fixing-general-node-js-projects&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/allegro/typescript-strict-plugin/tree/master&quot;&gt;typescript-strict-plugin&lt;/a&gt; was created mainly for existing projects that want to incorporate typescript strict mode, but project is so big that refactoring everything would take ages.&lt;/p&gt;
&lt;pre class=&quot;language-json&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-json&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;&quot;compilerOptions&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    ...
    &lt;span class=&quot;token property&quot;&gt;&quot;strict&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;&quot;plugins&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token property&quot;&gt;&quot;name&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;typescript-strict-plugin&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;token property&quot;&gt;&quot;paths&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;
          &lt;span class=&quot;token string&quot;&gt;&quot;./src&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
          &lt;span class=&quot;token string&quot;&gt;&quot;/absolute/path/to/source/&quot;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;token property&quot;&gt;&quot;exclude&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;
          &lt;span class=&quot;token string&quot;&gt;&quot;./src/tests&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
          &lt;span class=&quot;token string&quot;&gt;&quot;./src/fileToExclude.ts&quot;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;token property&quot;&gt;&quot;excludePattern&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;
          &lt;span class=&quot;token string&quot;&gt;&quot;**/*.spec.ts&quot;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Just like the frontend strategy, start with an &lt;strong&gt;allowlist&lt;/strong&gt; in the &lt;code&gt;paths&lt;/code&gt; option.&lt;/p&gt;
&lt;p&gt;Then add an exclude file list in the &lt;code&gt;exclude&lt;/code&gt; or &lt;code&gt;excludePattern&lt;/code&gt; option.&lt;/p&gt;
&lt;h2 id=&quot;alternatives&quot; tabindex=&quot;-1&quot;&gt;Alternatives &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/incremental-code-quality/#alternatives&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;h3 id=&quot;inside-figma-a-case-study-on-strict-null-checks&quot; tabindex=&quot;-1&quot;&gt;&lt;a href=&quot;https://www.figma.com/blog/inside-figma-a-case-study-on-strict-null-checks/&quot;&gt;Inside Figma: a case study on strict null checks&lt;/a&gt; &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/incremental-code-quality/#inside-figma-a-case-study-on-strict-null-checks&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;This article shows how Figma adopted strict mode incrementally. They use standard &lt;code&gt;tsc&lt;/code&gt; to run type checking. Since &amp;quot;compiling a TypeScript file requires compiling all its dependencies (imports)&amp;quot;, &lt;strong&gt;they need to fix files in a specific order: from the leaves of the dependency tree&lt;/strong&gt;. This requires additional work and is not practical to fix alongside feature development.&lt;/p&gt;
&lt;h3 id=&quot;output-parsing&quot; tabindex=&quot;-1&quot;&gt;Output parsing &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/incremental-code-quality/#output-parsing&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;With &lt;a href=&quot;https://github.com/Aiven-Open/tsc-output-parser&quot;&gt;tsc-output-parser&lt;/a&gt;, &lt;code&gt;tsc --strict --noEmit | tsc-output-parser&lt;/code&gt; can parse the output of &lt;code&gt;tsc&lt;/code&gt; to extract type errors.&lt;/p&gt;
&lt;p&gt;This approach enables type checking with &lt;code&gt;tsc&lt;/code&gt; while maintaining a &lt;code&gt;knownErrors.json&lt;/code&gt; to track and incrementally fix known errors.&lt;/p&gt;
&lt;pre class=&quot;language-ts&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-ts&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// typecheck.js&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; knownErrors &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token constant&quot;&gt;JSON&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;parse&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;fs&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;readFileSync&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;path&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;join&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;__dirname&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;knownErrors.json&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;utf8&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; hasErrors &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;false&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;try&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;execSync&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token template-string&quot;&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;tsc --strict --noEmit&lt;/span&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; stdio&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;pipe&quot;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;catch&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;error&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; output &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; error&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;stdout&lt;span class=&quot;token operator&quot;&gt;?.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;toString&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;||&lt;/span&gt; error&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;toString&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; parsedOutput &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;parse&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;output&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; remainingErrors &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; parsedOutput&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;filter&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;item&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token comment&quot;&gt;// filter out the known errors&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;knownErrors&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;some&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;knownError&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; knownError&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;file &lt;span class=&quot;token operator&quot;&gt;===&lt;/span&gt; item&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;value&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;path&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;value &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; knownError&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;code &lt;span class=&quot;token operator&quot;&gt;===&lt;/span&gt; item&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;value&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;tsError&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;value&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;errorString&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;remainingErrors&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;length &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Error&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token template-string&quot;&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;Type errors found!&lt;/span&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

process&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;exit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;hasErrors &lt;span class=&quot;token operator&quot;&gt;?&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;h3 id=&quot;stricter-typescript-compilation-with-betterer&quot; tabindex=&quot;-1&quot;&gt;&lt;a href=&quot;https://dev.to/phenomnominal/stricter-typescript-compilation-with-betterer-dp7&quot;&gt;Stricter TypeScript compilation with Betterer&lt;/a&gt; &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/incremental-code-quality/#stricter-typescript-compilation-with-betterer&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;Betterer is a test runner that helps make incremental improvements to your code! It is based upon Jest&#39;s snapshot testing, but with a twist...&lt;/p&gt;
</content>
	</entry>
	
	<entry>
		<title>Talking about code quality</title>
		<link href="https://hhow09.github.io/blog/code-quality/"/>
		<updated>2025-12-29T00:00:00Z</updated>
		<id>https://hhow09.github.io/blog/code-quality/</id>
		<content type="html">&lt;h2 id=&quot;what-is-code-quality&quot; tabindex=&quot;-1&quot;&gt;What is code quality? &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/code-quality/#what-is-code-quality&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;Definitions of code quality is pretty subjective and different from company to company. Developers also have different opinions on what is good code.&lt;/p&gt;
&lt;p&gt;In general, code quality is a way to talk about how correct, readable, reusable, maintainable and efficient code is.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;correct: free of bugs and errors&lt;/li&gt;
&lt;li&gt;readable: clean and understandable&lt;/li&gt;
&lt;li&gt;reusable: modular and adaptable&lt;/li&gt;
&lt;li&gt;maintainable: easy to &lt;a href=&quot;https://refactoring.guru/refactoring&quot;&gt;refactor&lt;/a&gt; and extend&lt;/li&gt;
&lt;li&gt;efficient: optimal performance&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;why-is-code-quality-important&quot; tabindex=&quot;-1&quot;&gt;Why is code quality important ? &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/code-quality/#why-is-code-quality-important&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;Reduces bugs and errors → faster, more stable releases&lt;/li&gt;
&lt;li&gt;Efficient code scales better → improved UX, reduce compute costs&lt;/li&gt;
&lt;li&gt;Helps developers understand, review, collaborate and build upon their own code → faster iterations&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;how-to-measure-code-quality&quot; tabindex=&quot;-1&quot;&gt;How to measure code quality? &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/code-quality/#how-to-measure-code-quality&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;Quantifying code quality is challenging, but these metrics provide useful signals:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;Test coverage&lt;/strong&gt;
&lt;ul&gt;
&lt;li&gt;Also integrate coverage reports with your platform, e.g. &lt;a href=&quot;https://docs.gitlab.com/ci/testing/code_coverage/&quot;&gt;GitLab Code Coverage&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Production bug count&lt;/strong&gt;
&lt;ul&gt;
&lt;li&gt;E.g. &lt;a href=&quot;https://docs.sentry.io/product/&quot;&gt;Sentry&lt;/a&gt; (Error monitoring tool)&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;&lt;a href=&quot;https://linearb.io/blog/what-is-code-churn&quot;&gt;Code churn&lt;/a&gt;&lt;/strong&gt;: frequency of edits to the same code—high churn often indicates implementation struggles&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;&lt;a href=&quot;https://en.wikipedia.org/wiki/Cyclomatic_complexity&quot;&gt;Cyclomatic complexity&lt;/a&gt;&lt;/strong&gt;: measures code path complexity&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Confidence in &lt;a href=&quot;https://refactoring.guru/refactoring&quot;&gt;refactoring&lt;/a&gt;&lt;/strong&gt;: how comfortable the team feels changing code or upgrading dependencies&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;further-reading&quot; tabindex=&quot;-1&quot;&gt;Further Reading &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/code-quality/#further-reading&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://axify.io/blog/software-quality-metrics&quot;&gt;Software Quality Metrics&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;how-to-maintain-code-quality&quot; tabindex=&quot;-1&quot;&gt;How to maintain code quality? &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/code-quality/#how-to-maintain-code-quality&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;h3 id=&quot;correctness&quot; tabindex=&quot;-1&quot;&gt;Correctness &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/code-quality/#correctness&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;first and important step, engineers need to ensure the code follows the requirements and specifications.&lt;/li&gt;
&lt;li&gt;It also means the code is free of bugs and errors.&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id=&quot;in-practice&quot; tabindex=&quot;-1&quot;&gt;In practice &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/code-quality/#in-practice&quot;&gt;#&lt;/a&gt;&lt;/h4&gt;
&lt;ul&gt;
&lt;li&gt;Enforce &lt;strong&gt;type checking&lt;/strong&gt; for dynamically-typed languages to catch type errors at compile time.&lt;/li&gt;
&lt;li&gt;Setup &lt;strong&gt;unit tests&lt;/strong&gt; and &lt;strong&gt;integration tests&lt;/strong&gt; in CI to catch bugs and errors early.
&lt;ul&gt;
&lt;li&gt;Take &lt;a href=&quot;https://en.wikipedia.org/wiki/Test-driven_development&quot;&gt;Test-driven development (TDD)&lt;/a&gt; as a guide.&lt;/li&gt;
&lt;li&gt;Write unit tests covering edge cases and common scenarios.&lt;/li&gt;
&lt;li&gt;Test integration happy paths at minimum (adjust based on team needs) since it takes more time to write and maintain.&lt;/li&gt;
&lt;li&gt;Still, &lt;strong&gt;race condition&lt;/strong&gt; remain challenging to test: Go has a &lt;a href=&quot;https://go.dev/doc/articles/race_detector&quot;&gt;Race Detector&lt;/a&gt; but for Node.js.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Run linter checks in CI to catch code smells
&lt;ul&gt;
&lt;li&gt;e.g. &lt;a href=&quot;https://eslint.org/&quot;&gt;eslint&lt;/a&gt;, &lt;a href=&quot;https://golangci-lint.run/&quot;&gt;golangci-lint&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;Consider configs from big tech: e.g. &lt;a href=&quot;https://www.npmjs.com/package/eslint-config-airbnb&quot;&gt;eslint-config-airbnb&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Fix &lt;a href=&quot;https://www.datadoghq.com/knowledge-center/flaky-tests/&quot;&gt;flaky integration tests&lt;/a&gt; ASAP.
&lt;ul&gt;
&lt;li&gt;&amp;quot;Don’t live with broken windows.&amp;quot; - &lt;a href=&quot;https://www.amazon.de/Pragmatic-Programmer-Journeyman-Master/dp/020161622X&quot;&gt;The Pragmatic Programmer&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;readability&quot; tabindex=&quot;-1&quot;&gt;Readability &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/code-quality/#readability&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;Code should be easy to understand, review, and maintain.&lt;/p&gt;
&lt;h4 id=&quot;complexity&quot; tabindex=&quot;-1&quot;&gt;Complexity &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/code-quality/#complexity&quot;&gt;#&lt;/a&gt;&lt;/h4&gt;
&lt;p&gt;Complexity directly impacts readability.&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://www.amazon.de/Philosophy-Software-Design-John-Ousterhout/dp/1732102201&quot;&gt;A Philosophy of Software Design&lt;/a&gt; by John Ousterhout explores software complexity (e.g. cognitive load) and strategies to reduce it.&lt;/p&gt;
&lt;h4 id=&quot;in-practice-1&quot; tabindex=&quot;-1&quot;&gt;In practice &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/code-quality/#in-practice-1&quot;&gt;#&lt;/a&gt;&lt;/h4&gt;
&lt;ul&gt;
&lt;li&gt;When writing code, follow &lt;a href=&quot;https://de.wikipedia.org/wiki/Clean_Code&quot;&gt;Clean Code&lt;/a&gt; principles:
&lt;ul&gt;
&lt;li&gt;meaningful naming&lt;/li&gt;
&lt;li&gt;function should do one thing only&lt;/li&gt;
&lt;li&gt;comments should explain why not what.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://web.stanford.edu/~ouster/cgi-bin/cs190-winter18/lecture.php?topic=working&quot;&gt;Strategic Programming over Tactical Programming&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;Use &lt;strong&gt;code formatter&lt;/strong&gt;: e.g. &lt;a href=&quot;https://prettier.io/&quot;&gt;prettier&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;Follow language-specific guides: e.g. &lt;a href=&quot;https://effectivetypescript.com/&quot;&gt;Effective Typescript&lt;/a&gt;, &lt;a href=&quot;https://go.dev/doc/effective_go&quot;&gt;Effective Go&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;reusability&quot; tabindex=&quot;-1&quot;&gt;Reusability &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/code-quality/#reusability&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;When implementing similar logic across entities or services, reusable code becomes valuable.&lt;/li&gt;
&lt;li&gt;However, abstraction should be done with care, premature generalization actually creates complexity. see &lt;a href=&quot;https://en.wikipedia.org/wiki/Rule_of_three_(computer_programming)&quot;&gt;Rule of three&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id=&quot;in-practice-2&quot; tabindex=&quot;-1&quot;&gt;In practice &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/code-quality/#in-practice-2&quot;&gt;#&lt;/a&gt;&lt;/h4&gt;
&lt;ul&gt;
&lt;li&gt;Follow the &lt;a href=&quot;https://en.wikipedia.org/wiki/Don%27t_repeat_yourself&quot;&gt;DRY principle&lt;/a&gt; thoughtfully.&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;maintainability&quot; tabindex=&quot;-1&quot;&gt;Maintainability &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/code-quality/#maintainability&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;Maintainability is about how easy it is to refactor and extend the code.&lt;/p&gt;
&lt;h4 id=&quot;in-practice-3&quot; tabindex=&quot;-1&quot;&gt;In practice &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/code-quality/#in-practice-3&quot;&gt;#&lt;/a&gt;&lt;/h4&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://en.wikipedia.org/wiki/SOLID&quot;&gt;SOLID&lt;/a&gt; principles&lt;/li&gt;
&lt;li&gt;The software is divided into discrete, independent modules or components, each with a clear and specific functionality.
&lt;ul&gt;
&lt;li&gt;&amp;quot;Module should be deep.&amp;quot;  - &lt;a href=&quot;https://www.amazon.de/Philosophy-Software-Design-John-Ousterhout/dp/1732102201&quot;&gt;A Philosophy of Software Design&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Management of dependencies&lt;/strong&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;Prevent Circular dependency&lt;/strong&gt; as much as possible
&lt;ul&gt;
&lt;li&gt;Golang &lt;a href=&quot;https://go.dev/ref/spec#Import_declarations&quot;&gt;prevents circular dependency by design&lt;/a&gt;: &amp;quot;It is illegal for a package to import itself, directly or indirectly&amp;quot;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://www.packtpub.com/en-us/product/nodejs-design-patterns-9781839214110&quot;&gt;Node.js Design Patterns&lt;/a&gt; Chapter 2 The Module System has a good explanation on module loading and circular dependency.&lt;/li&gt;
&lt;li&gt;Use &lt;a href=&quot;https://github.com/import-js/eslint-plugin-import/blob/main/docs/rules/no-cycle.md&quot;&gt;eslint-plugin-import/no-cycle&lt;/a&gt; to catch circular dependency.&lt;/li&gt;
&lt;li&gt;Use &lt;a href=&quot;https://github.com/sverweij/dependency-cruiser&quot;&gt;dependency-cruiser&lt;/a&gt; to validate/visualize dependencies and define fine-grained dependency rules.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Proper scope of external dependency&lt;/strong&gt; into separate modules, e.g. database layer, network layer (http). In this way, change scope of library update could be clearly scoped&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;efficiency&quot; tabindex=&quot;-1&quot;&gt;Efficiency &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/code-quality/#efficiency&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;Efficiency can be defined as, using the resources optimally where resources could be memory, CPU, time, files, connections, databases etc.&lt;/p&gt;
&lt;h4 id=&quot;in-practice-4&quot; tabindex=&quot;-1&quot;&gt;In practice &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/code-quality/#in-practice-4&quot;&gt;#&lt;/a&gt;&lt;/h4&gt;
&lt;ul&gt;
&lt;li&gt;write efficient code, understand and minimize time and space complexity of the code.&lt;/li&gt;
&lt;li&gt;Measure before optimizing: Don&#39;t optimize performance before you measure it. E.g.
&lt;ul&gt;
&lt;li&gt;End-to-end: &lt;a href=&quot;https://docs.sentry.io/product/sentry-basics/performance-monitoring/&quot;&gt;Sentry - Performance Monitoring&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;Database: &lt;a href=&quot;https://www.mongodb.com/docs/atlas/monitor-cluster-metrics/&quot;&gt;Mongo Atlas Monitoring&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;Frontend: &lt;a href=&quot;https://developer.chrome.com/docs/lighthouse&quot;&gt;Lighthouse&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;further-reading-1&quot; tabindex=&quot;-1&quot;&gt;Further Reading &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/code-quality/#further-reading-1&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://lethain.com/quality/&quot;&gt;How to create software quality.&lt;/a&gt; by Will Larson discusses software quality in a broader sense.&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;references&quot; tabindex=&quot;-1&quot;&gt;References &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/code-quality/#references&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://aws.amazon.com/what-is/code-quality/&quot;&gt;AWS:What is code quality?&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://microsoft.github.io/code-with-engineering-playbook/non-functional-requirements/maintainability/&quot;&gt;Microsoft: Engineering Fundamentals Playbook: Maintainability&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://www.amazon.de/Pragmatic-Programmer-Journeyman-Master/dp/020161622X&quot;&gt;The Pragmatic Programmer&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://de.wikipedia.org/wiki/Clean_Code&quot;&gt;Clean Code&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</content>
	</entry>
	
	<entry>
		<title>Handle Implicit Requirements</title>
		<link href="https://hhow09.github.io/blog/implicit-requirements/"/>
		<updated>2025-12-28T00:00:00Z</updated>
		<id>https://hhow09.github.io/blog/implicit-requirements/</id>
		<content type="html">&lt;h2 id=&quot;introduction&quot; tabindex=&quot;-1&quot;&gt;Introduction &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/implicit-requirements/#introduction&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;How to spot the implicit requirements that product team might have overlooked ?&lt;/p&gt;
&lt;p&gt;Implicit requirements are the ones that &lt;strong&gt;nobody wrote down&lt;/strong&gt; during design phase. It hurts the development by unexpected bugs and rework and eventually delays the release.&lt;/p&gt;
&lt;h2 id=&quot;benefits-of-handling-it-early&quot; tabindex=&quot;-1&quot;&gt;Benefits of handling it early &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/implicit-requirements/#benefits-of-handling-it-early&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;Identifying implicit requirements helps to properly manage the deadline and improve the quality of the product.&lt;/li&gt;
&lt;li&gt;Addressing implicit requirements early can help prevent costly rework later.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Here&#39;s some examples I encountered:&lt;/p&gt;
&lt;h2 id=&quot;side-effect-on-other-entities&quot; tabindex=&quot;-1&quot;&gt;Side effect on other entities &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/implicit-requirements/#side-effect-on-other-entities&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;Example: Users can delete their account.
&lt;ul&gt;
&lt;li&gt;What happens to their &lt;strong&gt;Orders&lt;/strong&gt; placed?&lt;/li&gt;
&lt;li&gt;What happens to their &lt;strong&gt;Comments&lt;/strong&gt; on shared documents?&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;uniqueness-constraints&quot; tabindex=&quot;-1&quot;&gt;Uniqueness Constraints &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/implicit-requirements/#uniqueness-constraints&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;Which fields should be unique, and at what scope?&lt;/li&gt;
&lt;li&gt;Should we auto-generate human-friendly unique ID for users ? If so, how to handle the uniqueness constraint ?&lt;/li&gt;
&lt;li&gt;What about soft-deleted records?
&lt;ul&gt;
&lt;li&gt;note: &lt;strong&gt;partial index on only active records&lt;/strong&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;permission-gaps&quot; tabindex=&quot;-1&quot;&gt;Permission Gaps &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/implicit-requirements/#permission-gaps&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;User has permission for Entity A but needs to display data from Entity B they can&#39;t access.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Example: Sales Representative can view and create &lt;strong&gt;orders&lt;/strong&gt; but &lt;strong&gt;cannot access invoice details&lt;/strong&gt;. However, in order page we need to display the &lt;strong&gt;invoice&lt;/strong&gt; details.
&lt;ul&gt;
&lt;li&gt;Question to clarify: Should we define fields in &lt;strong&gt;invoice&lt;/strong&gt; that are public ?&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Example: In UI user is displayed as a name with a link. However for users who cannot access &lt;strong&gt;User&lt;/strong&gt; detail page, it will go to 404 page.&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;realtime-update&quot; tabindex=&quot;-1&quot;&gt;Realtime update &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/implicit-requirements/#realtime-update&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;Especially in financial SaaS, there are requirements that multiple users viewing the same data need to see updates without refreshing.&lt;/li&gt;
&lt;li&gt;Change in settings/permissions (which are usually cached), should we reissue access token or clearup cache in order to reflect the change ?&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;searchable-fields&quot; tabindex=&quot;-1&quot;&gt;Searchable fields &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/implicit-requirements/#searchable-fields&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;Searching for related field would affect data modeling e.g..&lt;/li&gt;
&lt;li&gt;Example: Search order by customer name → it might need to join/denormalize and create index on customer name.
&lt;ul&gt;
&lt;li&gt;Ask product about sorting, filtering, and full-text search needs.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
</content>
	</entry>
	
	<entry>
		<title>E-commerce website with AWS Serverless</title>
		<link href="https://hhow09.github.io/blog/e-commerce-aws-serverless/"/>
		<updated>2025-01-14T00:00:00Z</updated>
		<id>https://hhow09.github.io/blog/e-commerce-aws-serverless/</id>
		<content type="html">&lt;p&gt;An overview of the e-commerce website with AWS Serverless stack developed by me.&lt;/p&gt;
&lt;h2 id=&quot;website&quot; tabindex=&quot;-1&quot;&gt;Website &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/e-commerce-aws-serverless/#website&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;&lt;a href=&quot;https://www.avocadotaiwan.com/&quot;&gt;https://www.avocadotaiwan.com/&lt;/a&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;It is running in production so I cannot share the source code. WIP on share the code template.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;features&quot; tabindex=&quot;-1&quot;&gt;Features &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/e-commerce-aws-serverless/#features&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;User can order products and pay with credit card or ATM transfer.&lt;/li&gt;
&lt;li&gt;User can query the order status with order id on order query page.&lt;/li&gt;
&lt;li&gt;Owner can see the order status (&lt;code&gt;created&lt;/code&gt;, &lt;code&gt;paid&lt;/code&gt;, &lt;code&gt;shipped&lt;/code&gt;) on admin page.&lt;/li&gt;
&lt;li&gt;Owner can configurable product, unitprice, website status with admin interface.&lt;/li&gt;
&lt;li&gt;Owner can query and manage order with admin interface.&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;tech-stack&quot; tabindex=&quot;-1&quot;&gt;Tech Stack &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/e-commerce-aws-serverless/#tech-stack&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;h3 id=&quot;backend-and-admin-service&quot; tabindex=&quot;-1&quot;&gt;Backend &amp;amp; Admin Service &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/e-commerce-aws-serverless/#backend-and-admin-service&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;Written in Golang&lt;/li&gt;
&lt;li&gt;Hosted on &lt;a href=&quot;https://aws.amazon.com/lambda/&quot;&gt;AWS Lambda&lt;/a&gt; for backend business logic.&lt;/li&gt;
&lt;li&gt;AWS &lt;a href=&quot;https://aws.amazon.com/api-gateway/&quot;&gt;API Gateway&lt;/a&gt; for exposing Lambda as REST API.&lt;/li&gt;
&lt;li&gt;AWS &lt;a href=&quot;https://aws.amazon.com/pm/dynamodb/&quot;&gt;DynamoDB&lt;/a&gt; as main database.&lt;/li&gt;
&lt;li&gt;AWS &lt;a href=&quot;https://aws.amazon.com/s3/&quot;&gt;S3&lt;/a&gt; for website status and static contents&lt;/li&gt;
&lt;li&gt;AWS &lt;a href=&quot;https://aws.amazon.com/cloudwatch/&quot;&gt;Cloudwatch&lt;/a&gt; for logging and monitoring.
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-logs-loggroup.html#cfn-logs-loggroup-retentionindays&quot;&gt;set log retention policy&lt;/a&gt; properly.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://corp.ecpay.com.tw/ecpay_en/&quot;&gt;ECPay&lt;/a&gt; for payment integration supporting credit card and ATM transfer.&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;frontend&quot; tabindex=&quot;-1&quot;&gt;Frontend &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/e-commerce-aws-serverless/#frontend&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://nextjs.org/&quot;&gt;Next.js&lt;/a&gt; (in Typescript) hosted on &lt;a href=&quot;https://pages.cloudflare.com/&quot;&gt;Cloudflare pages&lt;/a&gt; with &lt;a href=&quot;https://www.cloudflare.com/application-services/products/dns/&quot;&gt;Cloudflare DNS&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;deployment&quot; tabindex=&quot;-1&quot;&gt;Deployment &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/e-commerce-aws-serverless/#deployment&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;Environment: &lt;code&gt;staging&lt;/code&gt;/ &lt;code&gt;production&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;Tool: &lt;a href=&quot;https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/what-is-sam.html&quot;&gt;AWS Serverless Application Model (AWS SAM)&lt;/a&gt; for fully automated deployment.
&lt;ul&gt;
&lt;li&gt;template is shown in &lt;a href=&quot;https://hhow09.github.io/blog/e-commerce-aws-serverless/#aws-sam-template&quot;&gt;AWS SAM Template&lt;/a&gt; section.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;design-choice&quot; tabindex=&quot;-1&quot;&gt;Design Choice &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/e-commerce-aws-serverless/#design-choice&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;ol&gt;
&lt;li&gt;Use &lt;strong&gt;AWS Lambda&lt;/strong&gt; and &lt;strong&gt;API Gateway&lt;/strong&gt; for API due to
&lt;ul&gt;
&lt;li&gt;cost saving for &lt;strong&gt;low RPS&lt;/strong&gt; website&lt;/li&gt;
&lt;li&gt;low maintenance effort&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Use &lt;strong&gt;AWS DynamoDB&lt;/strong&gt; for database
&lt;ul&gt;
&lt;li&gt;choose NoSQL since there is no join between tables, only &lt;code&gt;order&lt;/code&gt; table.&lt;/li&gt;
&lt;li&gt;choose DynamoDB since it is serverless and easy to scale.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Use &lt;strong&gt;AWS S3&lt;/strong&gt; for static contents and website status.
&lt;ul&gt;
&lt;li&gt;website status is for feature flag or announcement, which does not change frequently.&lt;/li&gt;
&lt;li&gt;static contents rarely change.&lt;/li&gt;
&lt;li&gt;Therefore leveraging &lt;a href=&quot;https://docs.aws.amazon.com/whitepapers/latest/build-static-websites-aws/controlling-how-long-amazon-s3-content-is-cached-by-amazon-cloudfront.html&quot;&gt;cache control&lt;/a&gt; for performance and cost saving.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Use &lt;strong&gt;Next.js&lt;/strong&gt; for &lt;a href=&quot;https://nextjs.org/docs/pages/building-your-application/rendering/static-site-generation&quot;&gt;Static Site Generation&lt;/a&gt;
&lt;ul&gt;
&lt;li&gt;since SEO is important for e-commerce website and server side rendering is an overkill for this project.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&quot;architecture&quot; tabindex=&quot;-1&quot;&gt;Architecture &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/e-commerce-aws-serverless/#architecture&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;important steps are numbered and can be found in the diagram in next section.&lt;/p&gt;
&lt;p&gt;&lt;picture&gt;&lt;source type=&quot;image/avif&quot; srcset=&quot;https://hhow09.github.io/img/OtZCsUKIji-2633.avif 2633w&quot;&gt;&lt;source type=&quot;image/webp&quot; srcset=&quot;https://hhow09.github.io/img/OtZCsUKIji-2633.webp 2633w&quot;&gt;&lt;img alt=&quot;Architecture Diagram&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; src=&quot;https://hhow09.github.io/img/OtZCsUKIji-2633.png&quot; width=&quot;2633&quot; height=&quot;1941&quot;&gt;&lt;/picture&gt;&lt;/p&gt;
&lt;h2 id=&quot;user-story&quot; tabindex=&quot;-1&quot;&gt;User Story &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/e-commerce-aws-serverless/#user-story&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;h3 id=&quot;notes-on-payment-option&quot; tabindex=&quot;-1&quot;&gt;Notes on Payment Option &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/e-commerce-aws-serverless/#notes-on-payment-option&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;ol&gt;
&lt;li&gt;Credit Card: ECPay will callback to backend with payment result, user immediately see the order status updated.&lt;/li&gt;
&lt;li&gt;ATM Transfer: ECPay will asynchronously callback to backend with payment result.&lt;/li&gt;
&lt;li&gt;Pay on Arrive: Payment is collected by logistics, owner can ship as long as order is created.&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&quot;flow-diagram&quot; tabindex=&quot;-1&quot;&gt;Flow Diagram &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/e-commerce-aws-serverless/#flow-diagram&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;pre class=&quot;mermaid&quot;&gt;sequenceDiagram&amp;#10;    participant FE&amp;#10;    participant BE&amp;#10;    participant DB&amp;#10;    participant S3&amp;#10;    participant PaymentGateway&amp;#10;    FE-&amp;gt;&amp;gt;+S3: [1] GET site status and products&amp;#10;    S3--&amp;gt;&amp;gt;-FE: site status&amp;#10;    alt Site Not available&amp;#10;        Note Over FE: user flow END&amp;#10;    else Site Available&amp;#10;        Note Over FE: user browse products, fill in order form.&amp;#10;        FE-&amp;gt;&amp;gt;+BE: [2] POST /order&amp;#10;        BE-&amp;gt;&amp;gt;+DB: Save Order&amp;#10;        alt Payment Method: [Pay on arrive]&amp;#10;            BE--&amp;gt;&amp;gt;FE: Order ID&amp;#10;            FE--&amp;gt;&amp;gt;+BE: [6] GET /order&amp;#10;            BE--&amp;gt;&amp;gt;-FE: Order Result (shipment scheduled)&amp;#10;            Note Over FE: [Pay on arrive] END&amp;#10;        else Payment Method: [Online Payment (ECPay)]&amp;#10;            BE--&amp;gt;&amp;gt;-FE: Redirection&amp;#10;            Note Over FE: [4] redirect to payment gateway&amp;#10;            alt Ecpay [Credit Card]&amp;#10;                FE-&amp;gt;&amp;gt;PaymentGateway: User Payment&amp;#10;                PaymentGateway-&amp;gt;&amp;gt;+BE: [5] Notify Order Payed&amp;#10;                BE--&amp;gt;&amp;gt;DB: Update Order to Payed&amp;#10;                BE--&amp;gt;&amp;gt;-PaymentGateway: OK&amp;#10;            else Ecpay [ATM transfer] (part 1)&amp;#10;                rect rgb(191, 223, 255)&amp;#10;                    PaymentGateway--&amp;gt;&amp;gt;FE: Display ATM payment Info&amp;#10;                    Note Over FE: continue at Ecpay [ATM transfer] (part 2)&amp;#10;                end&amp;#10;            end&amp;#10;            PaymentGateway--&amp;gt;&amp;gt;FE: redirect result page&amp;#10;            Note Over FE: User redirected to show result page (with orderId)&amp;#10;            FE-&amp;gt;&amp;gt;+BE: [6] GET /order&amp;#10;            BE--&amp;gt;&amp;gt;-FE: Order&amp;#10;            alt Ecpay [Credit Card]&amp;#10;                Note Over FE: Display payment result&amp;#10;            else Ecpay [ATM transfer] (part 1)&amp;#10;                Note Over FE: Wait for ATM payment&amp;#10;            end&amp;#10;            Note Over FE: user flow END&amp;#10;        end&amp;#10;&amp;#10;        Note Over FE, PaymentGateway: ASYNC&amp;#10;&amp;#10;        alt Ecpay [ATM transfer] (part 2)&amp;#10;            rect rgb(191, 223, 255)&amp;#10;                Note Over PaymentGateway: User Payed&amp;#10;                PaymentGateway-&amp;gt;&amp;gt;+BE: Order Payed&amp;#10;                BE--&amp;gt;&amp;gt;DB: Update Order Payed&amp;#10;                BE--&amp;gt;&amp;gt;-PaymentGateway: OK&amp;#10;            end&amp;#10;            Note Over FE: Ecpay [ATM transfer] END&amp;#10;        end&amp;#10;    end&amp;#10;&lt;/pre&gt;
&lt;h2 id=&quot;aws-sam-template&quot; tabindex=&quot;-1&quot;&gt;&lt;a href=&quot;https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/what-is-sam.html&quot;&gt;AWS SAM&lt;/a&gt; Template &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/e-commerce-aws-serverless/#aws-sam-template&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;pre class=&quot;language-yaml&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-yaml&quot;&gt;&lt;span class=&quot;token key atrule&quot;&gt;AWSTemplateFormatVersion&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;2010-09-09&quot;&lt;/span&gt;
&lt;span class=&quot;token key atrule&quot;&gt;Transform&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; AWS&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;Serverless&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token datetime number&quot;&gt;2016-10-31&lt;/span&gt;

&lt;span class=&quot;token key atrule&quot;&gt;Parameters&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;# environment&lt;/span&gt;
  &lt;span class=&quot;token key atrule&quot;&gt;Env&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token key atrule&quot;&gt;Type&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; String
    &lt;span class=&quot;token key atrule&quot;&gt;Default&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; prod
    &lt;span class=&quot;token key atrule&quot;&gt;AllowedValues&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; prod
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; stag
    &lt;span class=&quot;token key atrule&quot;&gt;Description&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; env
  &lt;span class=&quot;token comment&quot;&gt;# API Gateway ID&lt;/span&gt;
  &lt;span class=&quot;token key atrule&quot;&gt;ApiID&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token key atrule&quot;&gt;Type&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; String
    &lt;span class=&quot;token key atrule&quot;&gt;Description&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; API ID

&lt;span class=&quot;token key atrule&quot;&gt;Globals&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;token key atrule&quot;&gt;Function&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token key atrule&quot;&gt;MemorySize&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;128&lt;/span&gt;
    &lt;span class=&quot;token key atrule&quot;&gt;Architectures&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;arm64&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
    &lt;span class=&quot;token key atrule&quot;&gt;Handler&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; bootstrap
    &lt;span class=&quot;token key atrule&quot;&gt;Runtime&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; provided.al2
    &lt;span class=&quot;token key atrule&quot;&gt;Timeout&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;5&lt;/span&gt;
    &lt;span class=&quot;token key atrule&quot;&gt;Tracing&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; Active
    &lt;span class=&quot;token key atrule&quot;&gt;Environment&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;token key atrule&quot;&gt;Variables&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;token key atrule&quot;&gt;ENV&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token tag&quot;&gt;!Ref&lt;/span&gt; Env
        &lt;span class=&quot;token key atrule&quot;&gt;TABLE_ORDER&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token tag&quot;&gt;!Join&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;-&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; &amp;lt;table&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;name&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token tag&quot;&gt;!Ref&lt;/span&gt; Env&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
        &lt;span class=&quot;token key atrule&quot;&gt;API_ENDPOINT&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token tag&quot;&gt;!Join&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; https&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;//&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token tag&quot;&gt;!Ref&lt;/span&gt; ApiID&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; .execute&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;api. &lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token tag&quot;&gt;!Ref&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;AWS::Region&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; .amazonaws.com&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;# edit 2nd parameter&lt;/span&gt;
        &lt;span class=&quot;token key atrule&quot;&gt;LOG_DYNAMODB_REQ&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token boolean important&quot;&gt;false&lt;/span&gt;
        &lt;span class=&quot;token key atrule&quot;&gt;S3URL&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &amp;lt;bucket&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;name&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;.s3.amazonaws.com

&lt;span class=&quot;token key atrule&quot;&gt;Resources&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;token key atrule&quot;&gt;Api&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token comment&quot;&gt;# API Gateway&lt;/span&gt;
    &lt;span class=&quot;token comment&quot;&gt;# https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/sam-resource-httpapi.html&lt;/span&gt;
    &lt;span class=&quot;token key atrule&quot;&gt;Type&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; AWS&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;Serverless&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;HttpApi
    &lt;span class=&quot;token key atrule&quot;&gt;Properties&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;token key atrule&quot;&gt;CorsConfiguration&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;token key atrule&quot;&gt;AllowOrigins&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
          &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;*&quot;&lt;/span&gt;
        &lt;span class=&quot;token key atrule&quot;&gt;AllowMethods&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; 
          &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; GET
          &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; POST
          &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; OPTIONS
        &lt;span class=&quot;token key atrule&quot;&gt;AllowHeaders&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
          &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; Content&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;Type
          &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; Accept
          &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; Access&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;Control&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;Allow&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;Headers
          &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; Access&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;Control&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;Request&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;Method
          &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; Access&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;Control&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;Request&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;Headers
          &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; Authorization
  
  &lt;span class=&quot;token comment&quot;&gt;# Lambda ping handler&lt;/span&gt;
  &lt;span class=&quot;token key atrule&quot;&gt;RootFunction&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token key atrule&quot;&gt;Type&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; AWS&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;Serverless&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;Function
    &lt;span class=&quot;token key atrule&quot;&gt;Properties&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;token key atrule&quot;&gt;CodeUri&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; functions/root/
      &lt;span class=&quot;token key atrule&quot;&gt;Events&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;token key atrule&quot;&gt;Api&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
          &lt;span class=&quot;token key atrule&quot;&gt;Type&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; HttpApi
          &lt;span class=&quot;token key atrule&quot;&gt;Properties&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;token key atrule&quot;&gt;Path&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; /
            &lt;span class=&quot;token key atrule&quot;&gt;Method&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; GET
            &lt;span class=&quot;token key atrule&quot;&gt;ApiId&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token tag&quot;&gt;!Ref&lt;/span&gt; Api            
    &lt;span class=&quot;token key atrule&quot;&gt;Metadata&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;token key atrule&quot;&gt;BuildMethod&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; makefile

  &lt;span class=&quot;token comment&quot;&gt;# Lambda get order handler&lt;/span&gt;
  &lt;span class=&quot;token key atrule&quot;&gt;GetOrderFunction&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token key atrule&quot;&gt;Type&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; AWS&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;Serverless&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;Function
    &lt;span class=&quot;token key atrule&quot;&gt;Properties&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;token key atrule&quot;&gt;CodeUri&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; functions/get&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;order/
      &lt;span class=&quot;token key atrule&quot;&gt;Events&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;token key atrule&quot;&gt;Api&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
          &lt;span class=&quot;token key atrule&quot;&gt;Type&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; HttpApi
          &lt;span class=&quot;token key atrule&quot;&gt;Properties&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;token key atrule&quot;&gt;Path&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; /order
            &lt;span class=&quot;token key atrule&quot;&gt;Method&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; GET
            &lt;span class=&quot;token key atrule&quot;&gt;ApiId&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token tag&quot;&gt;!Ref&lt;/span&gt; Api
      &lt;span class=&quot;token key atrule&quot;&gt;Policies&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;Version&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;2012-10-17&quot;&lt;/span&gt;
          &lt;span class=&quot;token key atrule&quot;&gt;Statement&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;Effect&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; Allow
              &lt;span class=&quot;token key atrule&quot;&gt;Action&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; dynamodb&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;GetItem
              &lt;span class=&quot;token key atrule&quot;&gt;Resource&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token tag&quot;&gt;!GetAtt&lt;/span&gt; OrdersTable.Arn
            &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;Effect&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; Allow
              &lt;span class=&quot;token key atrule&quot;&gt;Action&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; dynamodb&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;Scan
              &lt;span class=&quot;token key atrule&quot;&gt;Resource&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token tag&quot;&gt;!GetAtt&lt;/span&gt; OrdersTable.Arn
            &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;Effect&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; Allow
              &lt;span class=&quot;token key atrule&quot;&gt;Action&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; dynamodb&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;Query
              &lt;span class=&quot;token key atrule&quot;&gt;Resource&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; 
                &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token tag&quot;&gt;!GetAtt&lt;/span&gt; OrdersTable.Arn
                &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token tag&quot;&gt;!Join&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;token tag&quot;&gt;!GetAtt&lt;/span&gt; OrdersTable.Arn&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; /index/*&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;# index&lt;/span&gt;
    &lt;span class=&quot;token key atrule&quot;&gt;Metadata&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;token key atrule&quot;&gt;BuildMethod&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; makefile

  &lt;span class=&quot;token comment&quot;&gt;# post order handler&lt;/span&gt;
  &lt;span class=&quot;token key atrule&quot;&gt;PostOrderFunction&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token key atrule&quot;&gt;Type&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; AWS&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;Serverless&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;Function
    &lt;span class=&quot;token key atrule&quot;&gt;Properties&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;token key atrule&quot;&gt;CodeUri&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; functions/post&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;order/
      &lt;span class=&quot;token key atrule&quot;&gt;Events&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;token key atrule&quot;&gt;Api&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
          &lt;span class=&quot;token key atrule&quot;&gt;Type&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; HttpApi
          &lt;span class=&quot;token key atrule&quot;&gt;Properties&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;token key atrule&quot;&gt;Path&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; /order
            &lt;span class=&quot;token key atrule&quot;&gt;Method&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; POST
            &lt;span class=&quot;token key atrule&quot;&gt;ApiId&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token tag&quot;&gt;!Ref&lt;/span&gt; Api            
      &lt;span class=&quot;token key atrule&quot;&gt;Policies&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;Version&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;2012-10-17&quot;&lt;/span&gt;
          &lt;span class=&quot;token key atrule&quot;&gt;Statement&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;Effect&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; Allow
              &lt;span class=&quot;token key atrule&quot;&gt;Action&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; dynamodb&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;PutItem
              &lt;span class=&quot;token key atrule&quot;&gt;Resource&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token tag&quot;&gt;!GetAtt&lt;/span&gt; OrdersTable.Arn
    &lt;span class=&quot;token key atrule&quot;&gt;Metadata&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;token key atrule&quot;&gt;BuildMethod&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; makefile

  &lt;span class=&quot;token comment&quot;&gt;# payment callback handler&lt;/span&gt;
  &lt;span class=&quot;token key atrule&quot;&gt;EcpayFunction&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token key atrule&quot;&gt;Type&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; AWS&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;Serverless&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;Function
    &lt;span class=&quot;token key atrule&quot;&gt;Properties&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;token key atrule&quot;&gt;CodeUri&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; functions/ecpay&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;order/
      &lt;span class=&quot;token key atrule&quot;&gt;Events&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;token key atrule&quot;&gt;Api&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
          &lt;span class=&quot;token key atrule&quot;&gt;Type&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; HttpApi
          &lt;span class=&quot;token key atrule&quot;&gt;Properties&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;token key atrule&quot;&gt;Path&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; /ecpay
            &lt;span class=&quot;token key atrule&quot;&gt;Method&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; POST
            &lt;span class=&quot;token key atrule&quot;&gt;ApiId&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token tag&quot;&gt;!Ref&lt;/span&gt; Api            
      &lt;span class=&quot;token key atrule&quot;&gt;Policies&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;Version&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;2012-10-17&quot;&lt;/span&gt;
          &lt;span class=&quot;token key atrule&quot;&gt;Statement&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;Effect&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; Allow
              &lt;span class=&quot;token key atrule&quot;&gt;Action&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; dynamodb&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;UpdateItem
              &lt;span class=&quot;token key atrule&quot;&gt;Resource&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token tag&quot;&gt;!GetAtt&lt;/span&gt; OrdersTable.Arn
    &lt;span class=&quot;token key atrule&quot;&gt;Metadata&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;token key atrule&quot;&gt;BuildMethod&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; makefile      

  &lt;span class=&quot;token key atrule&quot;&gt;OrdersTable&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token key atrule&quot;&gt;Type&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; AWS&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;DynamoDB&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;Table
    &lt;span class=&quot;token key atrule&quot;&gt;Properties&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;token key atrule&quot;&gt;TableName&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token tag&quot;&gt;!Join&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;-&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; &amp;lt;table&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;name&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token tag&quot;&gt;!Ref&lt;/span&gt; Env&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
      &lt;span class=&quot;token key atrule&quot;&gt;AttributeDefinitions&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;AttributeName&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; ordertype
          &lt;span class=&quot;token key atrule&quot;&gt;AttributeType&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; S
        &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;AttributeName&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; idsk
          &lt;span class=&quot;token key atrule&quot;&gt;AttributeType&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; N
        &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;AttributeName&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; phone
          &lt;span class=&quot;token key atrule&quot;&gt;AttributeType&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; S
      &lt;span class=&quot;token key atrule&quot;&gt;KeySchema&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;token comment&quot;&gt;# the partition key&lt;/span&gt;
        &lt;span class=&quot;token comment&quot;&gt;# https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/bp-partition-key-design.html&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;AttributeName&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; ordertype
          &lt;span class=&quot;token key atrule&quot;&gt;KeyType&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; HASH
        &lt;span class=&quot;token comment&quot;&gt;# the sort key, essentially a timestamp&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;AttributeName&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; idsk
          &lt;span class=&quot;token key atrule&quot;&gt;KeyType&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; RANGE          
      &lt;span class=&quot;token key atrule&quot;&gt;BillingMode&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; PAY_PER_REQUEST
      &lt;span class=&quot;token key atrule&quot;&gt;LocalSecondaryIndexes&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;token comment&quot;&gt;# local secondary index&lt;/span&gt;
        &lt;span class=&quot;token comment&quot;&gt;# user can query order by phone number&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;IndexName&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; lsi&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;phone
          &lt;span class=&quot;token key atrule&quot;&gt;KeySchema&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;AttributeName&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; ordertype
              &lt;span class=&quot;token key atrule&quot;&gt;KeyType&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; HASH
            &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;AttributeName&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; phone
              &lt;span class=&quot;token key atrule&quot;&gt;KeyType&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; RANGE
          &lt;span class=&quot;token key atrule&quot;&gt;Projection&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;token key atrule&quot;&gt;ProjectionType&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; ALL

&lt;span class=&quot;token key atrule&quot;&gt;Outputs&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;token key atrule&quot;&gt;ApiUrl&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token key atrule&quot;&gt;Description&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;API Gateway endpoint URL&quot;&lt;/span&gt;
    &lt;span class=&quot;token key atrule&quot;&gt;Value&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token tag&quot;&gt;!Sub&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;https://${Api}.execute-api.${AWS::Region}.amazonaws.com/&quot;&lt;/span&gt;
  &lt;span class=&quot;token key atrule&quot;&gt;ApiId&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token key atrule&quot;&gt;Description&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; Api id of HttpApi
    &lt;span class=&quot;token key atrule&quot;&gt;Value&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;token key atrule&quot;&gt;Ref&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; Api&lt;/code&gt;&lt;/pre&gt;
</content>
	</entry>
	
	<entry>
		<title>Protecting Replay Attack</title>
		<link href="https://hhow09.github.io/blog/protect_replay_attack/"/>
		<updated>2024-12-22T00:00:00Z</updated>
		<id>https://hhow09.github.io/blog/protect_replay_attack/</id>
		<content type="html">&lt;h2 id=&quot;replay-attack&quot; tabindex=&quot;-1&quot;&gt;Replay Attack &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/protect_replay_attack/#replay-attack&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;blockquote&gt;
&lt;p&gt;An attack in which the Attacker is able to replay previously captured messages (between a legitimate Claimant and a Verifier) to masquerade as that Claimant to the Verifier or vice versa.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;protection-approaches&quot; tabindex=&quot;-1&quot;&gt;Protection Approaches &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/protect_replay_attack/#protection-approaches&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;ol&gt;
&lt;li&gt;IP rate limiting (extra cost)
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://cloud.google.com/armor/docs/rate-limiting-overview&quot;&gt;Google Cloud Armor&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Enterprise solution (extra cost)
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://aws.amazon.com/tw/waf/features/bot-control/&quot;&gt;AWS WAF Bot Control&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;Recaptcha&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;s&gt;API key&lt;/s&gt; (not safe for public client)&lt;/li&gt;
&lt;li&gt;nonce (with authentication)&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&quot;simple-solution-without-extra-cost-cryptographic-nonce&quot; tabindex=&quot;-1&quot;&gt;Simple solution without extra cost: Cryptographic nonce &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/protect_replay_attack/#simple-solution-without-extra-cost-cryptographic-nonce&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;blockquote&gt;
&lt;p&gt;Nonce in cryptography means “number once,” and this arbitrary number is only used one time in a cryptographic communication.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;blockquote&gt;
&lt;p&gt;The nonce helps to prove that the message received was sent by the intended sender and was not intercepted and resent by a bad actor.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;picture&gt;&lt;source type=&quot;image/avif&quot; srcset=&quot;https://hhow09.github.io/img/YcZx0b7Rdw-345.avif 345w&quot;&gt;&lt;source type=&quot;image/webp&quot; srcset=&quot;https://hhow09.github.io/img/YcZx0b7Rdw-345.webp 345w&quot;&gt;&lt;img alt=&quot;Nonce Auth&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; src=&quot;https://hhow09.github.io/img/YcZx0b7Rdw-345.png&quot; width=&quot;345&quot; height=&quot;331&quot;&gt;&lt;/picture&gt;&lt;/p&gt;
&lt;p&gt;Typical client-server communication during a nonce-based authentication process including both a server nonce and a client nonce.&lt;/p&gt;
&lt;h3 id=&quot;how-to-choose-a-nonce&quot; tabindex=&quot;-1&quot;&gt;How to choose a nonce &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/protect_replay_attack/#how-to-choose-a-nonce&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;Timestamp&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;client use timestamp as nonce in the request&lt;/li&gt;
&lt;li&gt;server should verify the timestamp within a certain range&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;beware of client time skew&lt;/strong&gt;
&lt;ul&gt;
&lt;li&gt;user could change the device time, therefore we could use &lt;strong&gt;timestamp returned from server&lt;/strong&gt;.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;random number&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;client generates a random number as nonce&lt;/li&gt;
&lt;li&gt;server checks the nonce is not used before&lt;/li&gt;
&lt;li&gt;cons: &lt;strong&gt;need to store nonce in server&lt;/strong&gt; for some time (e.g. in cache)&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&quot;is-nonce-enough&quot; tabindex=&quot;-1&quot;&gt;Is nonce enough? &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/protect_replay_attack/#is-nonce-enough&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;using nonce without &lt;strong&gt;encryption&lt;/strong&gt; or &lt;strong&gt;authentication&lt;/strong&gt; is easy to be guessed by attacker.&lt;/p&gt;
&lt;h3 id=&quot;encryption-authentication&quot; tabindex=&quot;-1&quot;&gt;Encryption / Authentication &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/protect_replay_attack/#encryption-authentication&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;either way is fine&lt;/li&gt;
&lt;li&gt;for authentication, &lt;a href=&quot;https://www.okta.com/identity-101/hmac/&quot;&gt;HMAC&lt;/a&gt; is a good choice&lt;/li&gt;
&lt;li&gt;for encryption, &lt;a href=&quot;https://en.wikipedia.org/wiki/Public-key_cryptography&quot;&gt;asymmetric encryption&lt;/a&gt; is a good choice &lt;strong&gt;for public client&lt;/strong&gt;.&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;solution-i-used&quot; tabindex=&quot;-1&quot;&gt;Solution I used &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/protect_replay_attack/#solution-i-used&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;ol&gt;
&lt;li&gt;client has public key from server&lt;/li&gt;
&lt;li&gt;client receive &lt;strong&gt;timestamp&lt;/strong&gt; from server as nonce&lt;/li&gt;
&lt;li&gt;client encrypt the nonce with public key and send to server&lt;/li&gt;
&lt;li&gt;server decrypt the nonce with private key and verify the timestamp within a certain range.&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&quot;reference&quot; tabindex=&quot;-1&quot;&gt;Reference &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/protect_replay_attack/#reference&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://www.reddit.com/r/ExperiencedDevs/comments/100iumt/how_to_prevent_the_public_rest_api_endpoints_from/&quot;&gt;Reddit: How to prevent the public REST API endpoints from bot attacks? &lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://www.okta.com/identity-101/nonce/&quot;&gt;What Is a Cryptographic Nonce? Definition and Meaning&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://www.linkedin.com/advice/0/how-do-you-prevent-replay-attacks-when-using-hmac-authentication&quot;&gt;How do you prevent replay attacks when using HMAC for authentication?&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</content>
	</entry>
	
	<entry>
		<title>Session guarantees for weakly consistent replicated data</title>
		<link href="https://hhow09.github.io/blog/session-guarantees-for-weakly-consistent-replicated-data/"/>
		<updated>2024-02-14T00:00:00Z</updated>
		<id>https://hhow09.github.io/blog/session-guarantees-for-weakly-consistent-replicated-data/</id>
		<content type="html">&lt;h2 id=&quot;introduction&quot; tabindex=&quot;-1&quot;&gt;Introduction &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/session-guarantees-for-weakly-consistent-replicated-data/#introduction&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;&lt;strong&gt;Eventual Consistency&lt;/strong&gt; is not enough.&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;The term “eventually” is deliberately vague: in general, there is no limit to how far a replica can fall behind. &lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://hhow09.github.io/blog/session-guarantees-for-weakly-consistent-replicated-data/#fn1&quot; id=&quot;fnref1&quot;&gt;[1]&lt;/a&gt;&lt;/sup&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;blockquote&gt;
&lt;p&gt;Unfortunately, the lack of guarantees concerning the ordering of read and write operations in weakly consistent systems can confuse users and applications, as reported in experiences with Grapevine [21]. A user may read some value for a data item and then later read an older value. Similarly, a user may update some data item based on reading some other data, while others read the updated item without seeing the data on which it is based. &lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://hhow09.github.io/blog/session-guarantees-for-weakly-consistent-replicated-data/#fn2&quot; id=&quot;fnref2&quot;&gt;[2]&lt;/a&gt;&lt;/sup&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;consistency-models&quot; tabindex=&quot;-1&quot;&gt;Consistency Models &lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://hhow09.github.io/blog/session-guarantees-for-weakly-consistent-replicated-data/#fn3&quot; id=&quot;fnref3&quot;&gt;[3]&lt;/a&gt;&lt;/sup&gt; &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/session-guarantees-for-weakly-consistent-replicated-data/#consistency-models&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;&lt;picture&gt;&lt;source type=&quot;image/avif&quot; srcset=&quot;https://hhow09.github.io/img/R6EIySWboD-1590.avif 1590w&quot;&gt;&lt;source type=&quot;image/webp&quot; srcset=&quot;https://hhow09.github.io/img/R6EIySWboD-1590.webp 1590w&quot;&gt;&lt;img alt=&quot;Consistency Models by JEPSEN&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; src=&quot;https://hhow09.github.io/img/R6EIySWboD-1590.png&quot; width=&quot;1590&quot; height=&quot;1595&quot;&gt;&lt;/picture&gt;&lt;/p&gt;
&lt;h2 id=&quot;pram-consistency&quot; tabindex=&quot;-1&quot;&gt;PRAM Consistency &lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://hhow09.github.io/blog/session-guarantees-for-weakly-consistent-replicated-data/#fn3&quot; id=&quot;fnref3:1&quot;&gt;[3:1]&lt;/a&gt;&lt;/sup&gt; &lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://hhow09.github.io/blog/session-guarantees-for-weakly-consistent-replicated-data/#fn4&quot; id=&quot;fnref4&quot;&gt;[4]&lt;/a&gt;&lt;/sup&gt; &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/session-guarantees-for-weakly-consistent-replicated-data/#pram-consistency&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;PRAM stands for Pipeline Random Access Memory.&lt;/li&gt;
&lt;li&gt;PRAM is exactly equivalent to &lt;a href=&quot;https://hhow09.github.io/blog/session-guarantees-for-weakly-consistent-replicated-data/#read-your-writes&quot;&gt;read your writes&lt;/a&gt;, &lt;a href=&quot;https://hhow09.github.io/blog/session-guarantees-for-weakly-consistent-replicated-data/#monotonic-writes&quot;&gt;monotonic writes&lt;/a&gt;, and &lt;a href=&quot;https://hhow09.github.io/blog/session-guarantees-for-weakly-consistent-replicated-data/#monotonic-reads&quot;&gt;monotonic reads&lt;/a&gt;.&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;defition&quot; tabindex=&quot;-1&quot;&gt;Defition &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/session-guarantees-for-weakly-consistent-replicated-data/#defition&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;blockquote&gt;
&lt;p&gt;all processes see write operations issued by a given process in the same order as they were invoked by that process.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;blockquote&gt;
&lt;p&gt;On the other hand, processes may observe writes issued by different processes in different orders.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;notations&quot; tabindex=&quot;-1&quot;&gt;Notations &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/session-guarantees-for-weakly-consistent-replicated-data/#notations&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;ol&gt;
&lt;li&gt;&lt;code&gt;DB(S)&lt;/code&gt;: the current contents of the server&#39;s database.&lt;/li&gt;
&lt;li&gt;&lt;code&gt;DB(S,t)&lt;/code&gt;: the ordered sequence of Writes that have been received by server &lt;code&gt;S&lt;/code&gt; at or before time &lt;code&gt;t&lt;/code&gt;.&lt;/li&gt;
&lt;li&gt;&lt;code&gt;WriteOrder(W1,W2)&lt;/code&gt;: a boolean predicate indicating whether Write &lt;code&gt;W1&lt;/code&gt; should be ordered before Write &lt;code&gt;W2&lt;/code&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&quot;session-guarantees&quot; tabindex=&quot;-1&quot;&gt;Session Guarantees &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/session-guarantees-for-weakly-consistent-replicated-data/#session-guarantees&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;blockquote&gt;
&lt;p&gt;Sessions are not intended to correspond to atomic transactions that ensure atomicity and serializability. Instead, the intent is to present individual applications with a view of the database that is consistent with their own actions, even if they read and write from various, potentially inconsistent servers. We want the results of operations performed in a session to be consistent with the model of a single centralized server, possibly being read and updated concurrently by multiple clients. &lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://hhow09.github.io/blog/session-guarantees-for-weakly-consistent-replicated-data/#fn2&quot; id=&quot;fnref2:1&quot;&gt;[2:1]&lt;/a&gt;&lt;/sup&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&quot;read-your-writes&quot; tabindex=&quot;-1&quot;&gt;Read Your Writes &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/session-guarantees-for-weakly-consistent-replicated-data/#read-your-writes&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;blockquote&gt;
&lt;p&gt;read operations reflect previous writes.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;blockquote&gt;
&lt;p&gt;If Read R follows Write W in a session and R is performed at server S at time t, then W is included in &lt;code&gt;DB(S,t)&lt;/code&gt;.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ul&gt;
&lt;li&gt;this guarantee is limited within a session.&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id=&quot;examples&quot; tabindex=&quot;-1&quot;&gt;Examples &lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://hhow09.github.io/blog/session-guarantees-for-weakly-consistent-replicated-data/#fn2&quot; id=&quot;fnref2:2&quot;&gt;[2:2]&lt;/a&gt;&lt;/sup&gt; &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/session-guarantees-for-weakly-consistent-replicated-data/#examples&quot;&gt;#&lt;/a&gt;&lt;/h4&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;Shortly after changing password, user would occasionally type the new password and receive an &amp;quot;invalid password&amp;quot; response. The &lt;strong&gt;RYW-guarantee&lt;/strong&gt; ensures that the login process will always read the most recent password.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;As a user reads and deletes messages, those messages are removed from the displayed &amp;quot;new mail&amp;quot; folder. If the user stops reading mail and returns sometime later, she should not see deleted messages reappear simply because the mail reader refreshed its display from a different copy of the database.&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&quot;monotonic-reads&quot; tabindex=&quot;-1&quot;&gt;Monotonic Reads &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/session-guarantees-for-weakly-consistent-replicated-data/#monotonic-reads&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;blockquote&gt;
&lt;p&gt;successive reads must reflect a non-decreasing set of writes.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;blockquote&gt;
&lt;p&gt;Namely, if a process has read a certain value v from an object, any successive read operation
will not return any value written before v.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ul&gt;
&lt;li&gt;this guarantee is limited within a session.&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id=&quot;examples-1&quot; tabindex=&quot;-1&quot;&gt;Examples &lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://hhow09.github.io/blog/session-guarantees-for-weakly-consistent-replicated-data/#fn2&quot; id=&quot;fnref2:3&quot;&gt;[2:3]&lt;/a&gt;&lt;/sup&gt; &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/session-guarantees-for-weakly-consistent-replicated-data/#examples-1&quot;&gt;#&lt;/a&gt;&lt;/h4&gt;
&lt;ol&gt;
&lt;li&gt;The user&#39;s calendar program periodically refreshes its display by reading all of today&#39;s calendar appointments from the database. If it accesses servers with inconsistent copies of the database, recently added (or deleted) meetings may appear to come and go. The &lt;strong&gt;MR-guarantee&lt;/strong&gt; can effectively prevent this since it disallows access to copies of the database that are less current than the previously read copy.&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&quot;monotonic-writes&quot; tabindex=&quot;-1&quot;&gt;Monotonic Writes &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/session-guarantees-for-weakly-consistent-replicated-data/#monotonic-writes&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;blockquote&gt;
&lt;p&gt;If Write W1 precedes Write W2 in a session, then, for any server S2, if W2 in &lt;code&gt;DB(S2)&lt;/code&gt; then W1 is also in &lt;code&gt;DB(S2)&lt;/code&gt; and &lt;code&gt;WriteOrder(W1,W2)&lt;/code&gt;.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;blockquote&gt;
&lt;p&gt;If a process performs write w1, then w2, then all processes observe w1 before w2.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ul&gt;
&lt;li&gt;this guarantee affects &lt;strong&gt;globally&lt;/strong&gt;.&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id=&quot;examples-2&quot; tabindex=&quot;-1&quot;&gt;Examples &lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://hhow09.github.io/blog/session-guarantees-for-weakly-consistent-replicated-data/#fn2&quot; id=&quot;fnref2:4&quot;&gt;[2:4]&lt;/a&gt;&lt;/sup&gt; &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/session-guarantees-for-weakly-consistent-replicated-data/#examples-2&quot;&gt;#&lt;/a&gt;&lt;/h4&gt;
&lt;ol&gt;
&lt;li&gt;A text editor when editing replicated files to ensure that if the user saves version N of the file and later saves version N+1 then version N+1 will replace version N at all servers. In particular, it avoids the situation in which version N is written to some server and version N+1 to a different server and the versions get propagated such that version N is applied after N+1.&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&quot;writes-follow-reads&quot; tabindex=&quot;-1&quot;&gt;Writes Follow Reads &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/session-guarantees-for-weakly-consistent-replicated-data/#writes-follow-reads&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;blockquote&gt;
&lt;p&gt;writes are propagated after reads on which they depend.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;blockquote&gt;
&lt;p&gt;if a process reads a value v, which came from a write w1, and later performs write w2, then w2 must be visible after w1. Once you’ve read something, you can’t change that read’s past.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;also known as &lt;strong&gt;session causality&lt;/strong&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;this guarantee affects &lt;strong&gt;globally&lt;/strong&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id=&quot;examples-3&quot; tabindex=&quot;-1&quot;&gt;Examples &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/session-guarantees-for-weakly-consistent-replicated-data/#examples-3&quot;&gt;#&lt;/a&gt;&lt;/h4&gt;
&lt;ol&gt;
&lt;li&gt;User sees reactions (W) to posted articles only if he/she have read the original posting.&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&quot;database-configurations&quot; tabindex=&quot;-1&quot;&gt;Database Configurations &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/session-guarantees-for-weakly-consistent-replicated-data/#database-configurations&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;h3 id=&quot;mongodb&quot; tabindex=&quot;-1&quot;&gt;MongoDB&lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://hhow09.github.io/blog/session-guarantees-for-weakly-consistent-replicated-data/#fn5&quot; id=&quot;fnref5&quot;&gt;[5]&lt;/a&gt;&lt;/sup&gt; &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/session-guarantees-for-weakly-consistent-replicated-data/#mongodb&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th style=&quot;text-align:center&quot;&gt;Read Concern&lt;/th&gt;
&lt;th style=&quot;text-align:center&quot;&gt;Write Concern&lt;/th&gt;
&lt;th style=&quot;text-align:center&quot;&gt;Read own writes&lt;/th&gt;
&lt;th style=&quot;text-align:center&quot;&gt;Monotonic reads&lt;/th&gt;
&lt;th style=&quot;text-align:center&quot;&gt;Monotonic writes&lt;/th&gt;
&lt;th style=&quot;text-align:center&quot;&gt;Writes follow reads&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:center&quot;&gt;&amp;quot;majority&amp;quot;&lt;/td&gt;
&lt;td style=&quot;text-align:center&quot;&gt;&amp;quot;majority&amp;quot;&lt;/td&gt;
&lt;td style=&quot;text-align:center&quot;&gt;✅&lt;/td&gt;
&lt;td style=&quot;text-align:center&quot;&gt;✅&lt;/td&gt;
&lt;td style=&quot;text-align:center&quot;&gt;✅&lt;/td&gt;
&lt;td style=&quot;text-align:center&quot;&gt;✅&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:center&quot;&gt;&amp;quot;majority&amp;quot;&lt;/td&gt;
&lt;td style=&quot;text-align:center&quot;&gt;{ w: 1 }&lt;/td&gt;
&lt;td style=&quot;text-align:center&quot;&gt;&lt;/td&gt;
&lt;td style=&quot;text-align:center&quot;&gt;✅&lt;/td&gt;
&lt;td style=&quot;text-align:center&quot;&gt;&lt;/td&gt;
&lt;td style=&quot;text-align:center&quot;&gt;✅&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:center&quot;&gt;&amp;quot;local&amp;quot;&lt;/td&gt;
&lt;td style=&quot;text-align:center&quot;&gt;{ w: 1 }&lt;/td&gt;
&lt;td style=&quot;text-align:center&quot;&gt;&lt;/td&gt;
&lt;td style=&quot;text-align:center&quot;&gt;&lt;/td&gt;
&lt;td style=&quot;text-align:center&quot;&gt;&lt;/td&gt;
&lt;td style=&quot;text-align:center&quot;&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:center&quot;&gt;&amp;quot;local&amp;quot;&lt;/td&gt;
&lt;td style=&quot;text-align:center&quot;&gt;&amp;quot;majority&amp;quot;&lt;/td&gt;
&lt;td style=&quot;text-align:center&quot;&gt;&lt;/td&gt;
&lt;td style=&quot;text-align:center&quot;&gt;&lt;/td&gt;
&lt;td style=&quot;text-align:center&quot;&gt;✅&lt;/td&gt;
&lt;td style=&quot;text-align:center&quot;&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h4 id=&quot;read-concern-majority&quot; tabindex=&quot;-1&quot;&gt;Read Concern Majority &lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://hhow09.github.io/blog/session-guarantees-for-weakly-consistent-replicated-data/#fn6&quot; id=&quot;fnref6&quot;&gt;[6]&lt;/a&gt;&lt;/sup&gt; &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/session-guarantees-for-weakly-consistent-replicated-data/#read-concern-majority&quot;&gt;#&lt;/a&gt;&lt;/h4&gt;
&lt;blockquote&gt;
&lt;p&gt;Majority does a timestamped read at the stable timestamp (also called the last committed snapshot in the code, for legacy reasons). The data read only reflects the oplog entries that have been replicated to a majority of nodes in the replica set. Any data seen in majority reads cannot roll back in the future. Thus majority reads prevent dirty reads, though they often are stale reads.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;blockquote&gt;
&lt;p&gt;Read concern majority reads do not wait for anything to be committed; they just use different snapshots from local reads. Read concern majority reads usually return as fast as local reads, but sometimes will block. For example, right after startup or rollback when we do not have a committed snapshot, majority reads will be blocked. Also, when some of the secondaries are unavailable or lagging, majority reads could slow down or block.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&quot;postgresql&quot; tabindex=&quot;-1&quot;&gt;PostgreSQL &lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://hhow09.github.io/blog/session-guarantees-for-weakly-consistent-replicated-data/#fn7&quot; id=&quot;fnref7&quot;&gt;[7]&lt;/a&gt;&lt;/sup&gt; &lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://hhow09.github.io/blog/session-guarantees-for-weakly-consistent-replicated-data/#fn8&quot; id=&quot;fnref8&quot;&gt;[8]&lt;/a&gt;&lt;/sup&gt; &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/session-guarantees-for-weakly-consistent-replicated-data/#postgresql&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;blockquote&gt;
&lt;p&gt;PostgreSQL streaming replication is &lt;strong&gt;asynchronous&lt;/strong&gt; by default. If the primary server crashes then some transactions that were committed may not have been replicated to the standby server, causing data loss. The amount of data loss is proportional to the replication delay at the time of failover.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;code&gt;synchronous_commit&lt;/code&gt; specifies how much WAL processing must complete before the database server returns a &lt;code&gt;success&lt;/code&gt; indication to the client.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Valid values are &lt;code&gt;remote_apply&lt;/code&gt;, &lt;code&gt;on&lt;/code&gt; (the default), &lt;code&gt;remote_write&lt;/code&gt;, &lt;code&gt;local&lt;/code&gt;, and &lt;code&gt;off&lt;/code&gt;.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Setting &lt;code&gt;synchronous_commit&lt;/code&gt; to &lt;code&gt;remote_write&lt;/code&gt; will cause each commit to wait for confirmation that the standby has received the commit record and written it out to its own operating system, but not for the data to be flushed to disk on the standby. This setting provides a weaker guarantee of durability than &lt;code&gt;on&lt;/code&gt; does: the standby could lose the data in the event of an operating system crash, though not a PostgreSQL crash. However, it&#39;s a useful setting in practice because it can decrease the response time for the transaction. Data loss could only occur if both the primary and the standby crash and the database of the primary gets corrupted at the same time.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Setting &lt;code&gt;synchronous_commit&lt;/code&gt; to &lt;code&gt;remote_apply&lt;/code&gt; will cause each commit to wait until the current synchronous standbys report that they have replayed the transaction, making it visible to user queries. In simple cases, &lt;strong&gt;this allows for load balancing with causal consistency&lt;/strong&gt;.&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;reference&quot; tabindex=&quot;-1&quot;&gt;Reference &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/session-guarantees-for-weakly-consistent-replicated-data/#reference&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;hr class=&quot;footnotes-sep&quot;&gt;
&lt;section class=&quot;footnotes&quot;&gt;
&lt;ol class=&quot;footnotes-list&quot;&gt;
&lt;li id=&quot;fn1&quot; class=&quot;footnote-item&quot;&gt;&lt;p&gt;Designing Data Intensive Applications Chapter 5: Replication &lt;a href=&quot;https://hhow09.github.io/blog/session-guarantees-for-weakly-consistent-replicated-data/#fnref1&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id=&quot;fn2&quot; class=&quot;footnote-item&quot;&gt;&lt;p&gt;&lt;a href=&quot;https://www.cs.cornell.edu/courses/cs734/2000FA/cached%20papers/SessionGuaranteesPDIS_1.html&quot;&gt;Session Guarantees for Weakly Consistent Replicated Data&lt;/a&gt; &lt;a href=&quot;https://hhow09.github.io/blog/session-guarantees-for-weakly-consistent-replicated-data/#fnref2&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt; &lt;a href=&quot;https://hhow09.github.io/blog/session-guarantees-for-weakly-consistent-replicated-data/#fnref2:1&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt; &lt;a href=&quot;https://hhow09.github.io/blog/session-guarantees-for-weakly-consistent-replicated-data/#fnref2:2&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt; &lt;a href=&quot;https://hhow09.github.io/blog/session-guarantees-for-weakly-consistent-replicated-data/#fnref2:3&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt; &lt;a href=&quot;https://hhow09.github.io/blog/session-guarantees-for-weakly-consistent-replicated-data/#fnref2:4&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id=&quot;fn3&quot; class=&quot;footnote-item&quot;&gt;&lt;p&gt;&lt;a href=&quot;https://jepsen.io/consistency&quot;&gt;JEPSEN - Consistency Models&lt;/a&gt; &lt;a href=&quot;https://hhow09.github.io/blog/session-guarantees-for-weakly-consistent-replicated-data/#fnref3&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt; &lt;a href=&quot;https://hhow09.github.io/blog/session-guarantees-for-weakly-consistent-replicated-data/#fnref3:1&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id=&quot;fn4&quot; class=&quot;footnote-item&quot;&gt;&lt;p&gt;&lt;a href=&quot;https://dl.acm.org/doi/10.1145/2926965&quot;&gt;Consistency in Non-Transactional Distributed Storage Systems&lt;/a&gt; &lt;a href=&quot;https://hhow09.github.io/blog/session-guarantees-for-weakly-consistent-replicated-data/#fnref4&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id=&quot;fn5&quot; class=&quot;footnote-item&quot;&gt;&lt;p&gt;&lt;a href=&quot;https://www.mongodb.com/docs/manual/core/causal-consistency-read-write-concerns/&quot;&gt;MongoDB: Causal Consistency and Read and Write Concerns&lt;/a&gt; &lt;a href=&quot;https://hhow09.github.io/blog/session-guarantees-for-weakly-consistent-replicated-data/#fnref5&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id=&quot;fn6&quot; class=&quot;footnote-item&quot;&gt;&lt;p&gt;&lt;a href=&quot;https://github.com/mongodb/mongo/blob/master/src/mongo/db/repl/README.md#read-concern&quot;&gt;MongoDB: Replication Internals&lt;/a&gt; &lt;a href=&quot;https://hhow09.github.io/blog/session-guarantees-for-weakly-consistent-replicated-data/#fnref6&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id=&quot;fn7&quot; class=&quot;footnote-item&quot;&gt;&lt;p&gt;&lt;a href=&quot;https://www.postgresql.org/docs/current/runtime-config-wal.html#GUC-SYNCHRONOUS-COMMIT&quot;&gt;PostgreSQL synchronous_commit&lt;/a&gt; &lt;a href=&quot;https://hhow09.github.io/blog/session-guarantees-for-weakly-consistent-replicated-data/#fnref7&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id=&quot;fn8&quot; class=&quot;footnote-item&quot;&gt;&lt;p&gt;&lt;a href=&quot;https://www.postgresql.org/docs/11/warm-standby.html#SYNCHRONOUS-REPLICATION&quot;&gt;PostgreSQL: Synchronous Replication&lt;/a&gt; &lt;a href=&quot;https://hhow09.github.io/blog/session-guarantees-for-weakly-consistent-replicated-data/#fnref8&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;/section&gt;
</content>
	</entry>
	
	<entry>
		<title>Distributed Lock with Redis, Redlock</title>
		<link href="https://hhow09.github.io/blog/redlock/"/>
		<updated>2024-01-16T00:00:00Z</updated>
		<id>https://hhow09.github.io/blog/redlock/</id>
		<content type="html">&lt;p&gt;Distributed Lock with Redis and reviews on Redlock algorithm.&lt;/p&gt;
&lt;h2 id=&quot;lock-command-with-single-redis-instance&quot; tabindex=&quot;-1&quot;&gt;Lock Command With Single Redis Instance &lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://hhow09.github.io/blog/redlock/#fn1&quot; id=&quot;fnref1&quot;&gt;[1]&lt;/a&gt;&lt;/sup&gt; &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/redlock/#lock-command-with-single-redis-instance&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;h3 id=&quot;lock&quot; tabindex=&quot;-1&quot;&gt;Lock &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/redlock/#lock&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;pre&gt;&lt;code&gt;SET resource_name my_random_value NX PX 30000
&lt;/code&gt;&lt;/pre&gt;
&lt;h3 id=&quot;unlock&quot; tabindex=&quot;-1&quot;&gt;Unlock &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/redlock/#unlock&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;pre&gt;&lt;code&gt;if redis.call(&amp;quot;get&amp;quot;,KEYS[1]) == my_random_value then
    return redis.call(&amp;quot;del&amp;quot;,KEYS[1])
else
    return 0
end
&lt;/code&gt;&lt;/pre&gt;
&lt;h2 id=&quot;failure-mode&quot; tabindex=&quot;-1&quot;&gt;Failure mode &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/redlock/#failure-mode&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;h3 id=&quot;1-single-instance-redis-down-single-point-of-failure&quot; tabindex=&quot;-1&quot;&gt;1. [Single Instance] Redis down (single point of failure) &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/redlock/#1-single-instance-redis-down-single-point-of-failure&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;Solution: use Replica&lt;/p&gt;
&lt;h3 id=&quot;2-replica-the-leader-crashes-before-the-write-to-the-key-is-transmitted-to-the-replica&quot; tabindex=&quot;-1&quot;&gt;2. [Replica] The Leader crashes before the write to the key is transmitted to the replica. &lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://hhow09.github.io/blog/redlock/#fn2&quot; id=&quot;fnref2&quot;&gt;[2]&lt;/a&gt;&lt;/sup&gt; &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/redlock/#2-replica-the-leader-crashes-before-the-write-to-the-key-is-transmitted-to-the-replica&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;pre class=&quot;mermaid&quot;&gt;sequenceDiagram&amp;#10;    participant Client_A&amp;#10;    participant Client_B&amp;#10;    participant Master&amp;#10;    participant Replica&amp;#10;    note over Client_A, Replica: vv normal case vv&amp;#10;    Client_A -&amp;gt;&amp;gt;+ Master: Acquire Lock&amp;#10;    Master --&amp;gt;&amp;gt;- Client_A: success&amp;#10;    Master -&amp;gt;&amp;gt; Replica: replicate&amp;#10;    Client_A -&amp;gt;&amp;gt;+ Master: UnLock&amp;#10;    Master --&amp;gt;&amp;gt;- Client_A: success&amp;#10;    Master -&amp;gt;&amp;gt; Replica: replicate&amp;#10;    note over Client_A, Replica:  vv Failure case vv&amp;#10;    Client_A -&amp;gt;&amp;gt;+ Master: Acquire Lock&amp;#10;    Master --&amp;gt;&amp;gt;- Client_A: success&amp;#10;    note over Master: crash before replicate&amp;#10;    note over Replica: promoted as Master&amp;#10;    Client_B -&amp;gt;&amp;gt;+ Replica: Acquire Lock&amp;#10;    Replica --&amp;gt;&amp;gt;- Client_B: success&amp;#10;    note over Client_B: SAFETY VIOLATION!&amp;#10;&lt;/pre&gt;
&lt;h4 id=&quot;solution&quot; tabindex=&quot;-1&quot;&gt;Solution &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/redlock/#solution&quot;&gt;#&lt;/a&gt;&lt;/h4&gt;
&lt;p&gt;Consensus algorithm e.g. &lt;a href=&quot;https://hhow09.github.io/blog/redlock/#redlock-algorithm&quot;&gt;Redlock&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;redlock-algorithm&quot; tabindex=&quot;-1&quot;&gt;Redlock Algorithm &lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://hhow09.github.io/blog/redlock/#fn1&quot; id=&quot;fnref1:1&quot;&gt;[1:1]&lt;/a&gt;&lt;/sup&gt; &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/redlock/#redlock-algorithm&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;h3 id=&quot;prerequisite&quot; tabindex=&quot;-1&quot;&gt;Prerequisite &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/redlock/#prerequisite&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;blockquote&gt;
&lt;p&gt;In the distributed version of the algorithm we assume we have N Redis masters. Those nodes are totally independent, so we don’t use replication or any other implicit coordination system.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&quot;overview&quot; tabindex=&quot;-1&quot;&gt;Overview &lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://hhow09.github.io/blog/redlock/#fn3&quot; id=&quot;fnref3&quot;&gt;[3]&lt;/a&gt;&lt;/sup&gt; &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/redlock/#overview&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;blockquote&gt;
&lt;p&gt;The answer is through majority consensus. Since one Redis is not reliable, we form a committee of multiple Redis. If and only if more than half of the committee members agree, the lock will take effect; otherwise, the lock is invalid.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;blockquote&gt;
&lt;p&gt;The members can be single, master-slave, or even clusters, but nevertheless, they are independent of each other, in other words, they are not duplicates of each other, not to mention the same cluster.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&quot;flow&quot; tabindex=&quot;-1&quot;&gt;Flow &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/redlock/#flow&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;&lt;picture&gt;&lt;source type=&quot;image/avif&quot; srcset=&quot;https://hhow09.github.io/img/CBZ_Vol0z6-862.avif 862w&quot;&gt;&lt;source type=&quot;image/webp&quot; srcset=&quot;https://hhow09.github.io/img/CBZ_Vol0z6-862.webp 862w&quot;&gt;&lt;img alt=&quot;Redlock Flow&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; src=&quot;https://hhow09.github.io/img/CBZ_Vol0z6-862.png&quot; width=&quot;862&quot; height=&quot;1118&quot;&gt;&lt;/picture&gt;&lt;/p&gt;
&lt;h3 id=&quot;go-redsync-redsync&quot; tabindex=&quot;-1&quot;&gt;go-redsync/redsync &lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://hhow09.github.io/blog/redlock/#fn4&quot; id=&quot;fnref4&quot;&gt;[4]&lt;/a&gt;&lt;/sup&gt; &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/redlock/#go-redsync-redsync&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;code snippet to acuire lock.&lt;/p&gt;
&lt;pre class=&quot;language-go&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-go&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// https://github.com/go-redsync/redsync/blob/master/mutex.go&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// lockContext locks m. In case it returns an error on failure, &lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// you may retry to acquire the lock by calling this method again.&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;m &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;Mutex&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;lockContext&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ctx context&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Context&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; tries &lt;span class=&quot;token builtin&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;error&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; ctx &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;nil&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
		ctx &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; context&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;Background&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;token comment&quot;&gt;// every lock is &quot;signed&quot; with a random string, so the lock will&lt;/span&gt;
    &lt;span class=&quot;token comment&quot;&gt;// be removed only if it is still the one that was set by the client&lt;/span&gt;
    &lt;span class=&quot;token comment&quot;&gt;// trying to remove it.&lt;/span&gt;
	value&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; err &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; m&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;genValueFunc&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; err &lt;span class=&quot;token operator&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;nil&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; err
	&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

	&lt;span class=&quot;token keyword&quot;&gt;var&lt;/span&gt; timer &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;time&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Timer
	&lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; tries&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;token comment&quot;&gt;// ... timer and retry part&lt;/span&gt;

        &lt;span class=&quot;token comment&quot;&gt;// 1. Get the current time.&lt;/span&gt;
		start &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; time&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;Now&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

        &lt;span class=&quot;token comment&quot;&gt;// 2. … All the steps needed to acquire the lock …&lt;/span&gt;
		n&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; err &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;error&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;token comment&quot;&gt;// timeout factor: when setting the lock in each instance, &lt;/span&gt;
            &lt;span class=&quot;token comment&quot;&gt;// the client uses a timeout which is small compared to the&lt;/span&gt;
            &lt;span class=&quot;token comment&quot;&gt;// total lock auto-release time in order to acquire it.&lt;/span&gt;
			ctx&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; cancel &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; context&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;WithTimeout&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ctx&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; time&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;Duration&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;int64&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;float64&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;m&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;expiry&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;m&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;timeoutFactor&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
			&lt;span class=&quot;token keyword&quot;&gt;defer&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;cancel&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
			&lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; m&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;actOnPoolsAsync&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pool redis&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Pool&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;bool&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;error&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
				&lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; m&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;acquire&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ctx&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; pool&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; value&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
			&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
		&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

        &lt;span class=&quot;token comment&quot;&gt;// 3. Get the current time, again.&lt;/span&gt;
		now &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; time&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;Now&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        
        &lt;span class=&quot;token comment&quot;&gt;// 4. Check if we are already out of time, or if we acquired the lock fast enough.&lt;/span&gt;
		until &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; now&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;Add&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;m&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;expiry &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; now&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;Sub&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;start&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; time&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;Duration&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;int64&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;float64&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;m&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;expiry&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;m&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;driftFactor&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

        &lt;span class=&quot;token comment&quot;&gt;// quorum: len(r.pools)/2 + 1&lt;/span&gt;
        &lt;span class=&quot;token comment&quot;&gt;// As long as the quorum is met, we can assume the lock is acquired.&lt;/span&gt;
		&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; n &lt;span class=&quot;token operator&quot;&gt;&gt;=&lt;/span&gt; m&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;quorum &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; now&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;Before&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;until&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
			m&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;value &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; value
			m&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;until &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; until
			&lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;nil&lt;/span&gt;
		&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

        &lt;span class=&quot;token comment&quot;&gt;// lock not acquired&lt;/span&gt;
        &lt;span class=&quot;token comment&quot;&gt;// unlock previously locked key&lt;/span&gt;
		&lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;error&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
			ctx&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; cancel &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; context&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;WithTimeout&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ctx&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; time&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;Duration&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;int64&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;float64&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;m&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;expiry&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;m&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;timeoutFactor&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
			&lt;span class=&quot;token keyword&quot;&gt;defer&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;cancel&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
			&lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; m&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;actOnPoolsAsync&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pool redis&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Pool&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;bool&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;error&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
				&lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; m&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;release&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ctx&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; pool&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; value&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
			&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
		&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;token comment&quot;&gt;// exceed max retry times&lt;/span&gt;
		&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; m&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;tries&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; err &lt;span class=&quot;token operator&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;nil&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
			&lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; err
		&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

	&lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; ErrFailed
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;noted that at &lt;strong&gt;indefinite network delay or GC pause could happend&lt;/strong&gt; &lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://hhow09.github.io/blog/redlock/#fn4&quot; id=&quot;fnref4:1&quot;&gt;[4:1]&lt;/a&gt;&lt;/sup&gt;, so we need to re-check expiry time at step 3 and 4&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Note that whatever happens between 1 and 3, you can add the network delays you want, the lock will always be considered not valid if too much time elapsed, so Redlock looks completely immune from messages that have unbound delays between processes. It was designed with this goal in mind, and I cannot see how the above race condition could happen. &lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://hhow09.github.io/blog/redlock/#fn5&quot; id=&quot;fnref5&quot;&gt;[5]&lt;/a&gt;&lt;/sup&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;hr&gt;
&lt;h2 id=&quot;review-on-readlock-by-martin-kleppmann&quot; tabindex=&quot;-1&quot;&gt;Review on Readlock by Martin Kleppmann &lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://hhow09.github.io/blog/redlock/#fn1&quot; id=&quot;fnref1:2&quot;&gt;[1:2]&lt;/a&gt;&lt;/sup&gt; &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/redlock/#review-on-readlock-by-martin-kleppmann&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;h3 id=&quot;issue-1-clock-skew&quot; tabindex=&quot;-1&quot;&gt;Issue 1: Clock Skew &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/redlock/#issue-1-clock-skew&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;blockquote&gt;
&lt;p&gt;What happens if a clock on one of the Redis nodes jumps forward?&lt;/p&gt;
&lt;/blockquote&gt;
&lt;blockquote&gt;
&lt;ol&gt;
&lt;li&gt;Client 1 acquires lock on nodes A, B, C. Due to a network issue, D and E cannot be reached.&lt;/li&gt;
&lt;li&gt;The clock on node C jumps forward, causing the lock to expire.&lt;/li&gt;
&lt;li&gt;Client 2 acquires lock on nodes C, D, E. Due to a network issue, A and B cannot be reached.&lt;/li&gt;
&lt;li&gt;Clients 1 and 2 now both believe they hold the lock.&lt;/li&gt;
&lt;/ol&gt;
&lt;/blockquote&gt;
&lt;h4 id=&quot;response-from-antirez&quot; tabindex=&quot;-1&quot;&gt;Response from antirez &lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://hhow09.github.io/blog/redlock/#fn5&quot; id=&quot;fnref5:1&quot;&gt;[5:1]&lt;/a&gt;&lt;/sup&gt; &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/redlock/#response-from-antirez&quot;&gt;#&lt;/a&gt;&lt;/h4&gt;
&lt;blockquote&gt;
&lt;p&gt;Martin says that the clock can randomly jump in a system because of two issues:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;The system administrator manually alters the clock.&lt;/li&gt;
&lt;li&gt;The ntpd daemon changes the clock a lot because it receives an update.&lt;/li&gt;
&lt;/ol&gt;
&lt;/blockquote&gt;
&lt;blockquote&gt;
&lt;p&gt;The above two problems can be avoided by “1” not doing this (otherwise even corrupting a Raft log with “echo foo &amp;gt; /my/raft/log.bin” is a problem), and “2” using an ntpd that does not change the time by jumping directly, but by distributing the change over the course of a larger time span.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&quot;issue-2-long-gc-at-client-process&quot; tabindex=&quot;-1&quot;&gt;Issue 2: Long GC at Client Process &lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://hhow09.github.io/blog/redlock/#fn4&quot; id=&quot;fnref4:2&quot;&gt;[4:2]&lt;/a&gt;&lt;/sup&gt; &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/redlock/#issue-2-long-gc-at-client-process&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;&lt;picture&gt;&lt;source type=&quot;image/avif&quot; srcset=&quot;https://hhow09.github.io/img/rNglXUm5I2-1100.avif 1100w&quot;&gt;&lt;source type=&quot;image/webp&quot; srcset=&quot;https://hhow09.github.io/img/rNglXUm5I2-1100.webp 1100w&quot;&gt;&lt;img alt=&quot;Unsafe Lock&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; src=&quot;https://hhow09.github.io/img/rNglXUm5I2-1100.png&quot; width=&quot;1100&quot; height=&quot;400&quot;&gt;&lt;/picture&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;ol&gt;
&lt;li&gt;Client 1 requests lock on nodes A, B, C, D, E.&lt;/li&gt;
&lt;li&gt;While the responses to client 1 are in flight, client 1 goes into stop-the-world GC.&lt;/li&gt;
&lt;li&gt;Locks expire on all Redis nodes.&lt;/li&gt;
&lt;li&gt;Client 2 acquires lock on nodes A, B, C, D, E.&lt;/li&gt;
&lt;li&gt;Client 1 finishes GC, and receives the responses from Redis nodes indicating that it successfully acquired the lock (they were held in client 1’s kernel network buffers while the process was paused).&lt;/li&gt;
&lt;li&gt;Clients 1 and 2 now both believe they hold the lock.&lt;/li&gt;
&lt;/ol&gt;
&lt;/blockquote&gt;
&lt;h4 id=&quot;reason&quot; tabindex=&quot;-1&quot;&gt;Reason &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/redlock/#reason&quot;&gt;#&lt;/a&gt;&lt;/h4&gt;
&lt;blockquote&gt;
&lt;p&gt;This bug is not theoretical: HBase used to &lt;a href=&quot;http://www.slideshare.net/enissoz/hbase-and-hdfs-understanding-filesystem-usage&quot;&gt;have this problem&lt;/a&gt; [3,4]. Normally, GC pauses are quite short, but “stop-the-world” GC pauses have sometimes been known to last for &lt;a href=&quot;https://blog.cloudera.com/blog/2011/02/avoiding-full-gcs-in-hbase-with-memstore-local-allocation-buffers-part-1/&quot;&gt;several minutes&lt;/a&gt; [5] – certainly long enough for a lease to expire.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h4 id=&quot;response-from-antirez-1&quot; tabindex=&quot;-1&quot;&gt;Response from antirez &lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://hhow09.github.io/blog/redlock/#fn5&quot; id=&quot;fnref5:2&quot;&gt;[5:2]&lt;/a&gt;&lt;/sup&gt; &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/redlock/#response-from-antirez-1&quot;&gt;#&lt;/a&gt;&lt;/h4&gt;
&lt;blockquote&gt;
&lt;p&gt;If you read the Redlock specification, that I hadn&#39;t touched for months, you can see the steps to acquire the lock are:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Get the current time.&lt;/li&gt;
&lt;li&gt;… All the steps needed to acquire the lock …&lt;/li&gt;
&lt;li&gt;Get the current time, again.&lt;/li&gt;
&lt;li&gt;Check if we are already out of time, or if we acquired the lock fast enough.&lt;/li&gt;
&lt;li&gt;Do some work with your lock.&lt;/li&gt;
&lt;/ol&gt;
&lt;/blockquote&gt;
&lt;p&gt;He admitted that if long GC happens between step 3 and 4, it will actually calculate wrong expiration time.&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Let me tell again how this problem is common with &lt;em&gt;all the distributed locks implementations&lt;/em&gt;, and how the token as a solution is both unrealistic and can be used with Redlock as well. &lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://hhow09.github.io/blog/redlock/#fn5&quot; id=&quot;fnref5:3&quot;&gt;[5:3]&lt;/a&gt;&lt;/sup&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&quot;solution-from-martin-fencing-token&quot; tabindex=&quot;-1&quot;&gt;Solution from Martin: Fencing token &lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://hhow09.github.io/blog/redlock/#fn4&quot; id=&quot;fnref4:3&quot;&gt;[4:3]&lt;/a&gt;&lt;/sup&gt; &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/redlock/#solution-from-martin-fencing-token&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;blockquote&gt;
&lt;p&gt;In this context, a fencing token is simply a number that increases (e.g. incremented by the lock service) every time a client acquires the lock.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;blockquote&gt;
&lt;p&gt;Note this requires the storage server to take an active role in checking tokens, and rejecting any writes on which the token has gone backwards.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;picture&gt;&lt;source type=&quot;image/avif&quot; srcset=&quot;https://hhow09.github.io/img/Gux1iLMpYy-1100.avif 1100w&quot;&gt;&lt;source type=&quot;image/webp&quot; srcset=&quot;https://hhow09.github.io/img/Gux1iLMpYy-1100.webp 1100w&quot;&gt;&lt;img alt=&quot;Fencing token&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; src=&quot;https://hhow09.github.io/img/Gux1iLMpYy-1100.png&quot; width=&quot;1100&quot; height=&quot;400&quot;&gt;&lt;/picture&gt;&lt;/p&gt;
&lt;p&gt;In simple word: use monotonic counter to know &amp;quot;the order of different client acquiring same lock&amp;quot;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;However, this leads us to the first big problem with Redlock: it does not have any facility for generating fencing tokens. The algorithm does not produce any number that is guaranteed to increase every time a client acquires a lock.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h4 id=&quot;java-implementation-redisson-fencedlock&quot; tabindex=&quot;-1&quot;&gt;Java Implementation: redisson FencedLock &lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://hhow09.github.io/blog/redlock/#fn6&quot; id=&quot;fnref6&quot;&gt;[6]&lt;/a&gt;&lt;/sup&gt; &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/redlock/#java-implementation-redisson-fencedlock&quot;&gt;#&lt;/a&gt;&lt;/h4&gt;
&lt;blockquote&gt;
&lt;p&gt;This type of lock maintains the fencing token to avoid cases when Client acquired the lock was delayed due to long GC pause or other reason and can&#39;t detect that it doesn&#39;t own the lock anymore. To resolve this issue token is returned by locking methods or getToken() method.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;blockquote&gt;
&lt;p&gt;Token should be checked if it&#39;s greater or equal with the previous one by the service guarded by this lock and reject operation if condition is false.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h5&gt;Example&lt;/h5&gt;
&lt;pre class=&quot;language-java&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;&lt;span class=&quot;token class-name&quot;&gt;RFencedLock&lt;/span&gt; lock &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; redisson&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getFencedLock&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;myLock&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// or wait for lock aquisition up to 100 seconds &lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// and automatically unlock it after 10 seconds&lt;/span&gt;
&lt;span class=&quot;token class-name&quot;&gt;Long&lt;/span&gt; token &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; lock&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;tryLockAndGetToken&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;100&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;TimeUnit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token constant&quot;&gt;SECONDS&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;token &lt;span class=&quot;token operator&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
   &lt;span class=&quot;token keyword&quot;&gt;try&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
     &lt;span class=&quot;token comment&quot;&gt;// check if token &gt;= old token&lt;/span&gt;
     &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;
   &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;finally&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
       lock&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;unlock&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
   &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;h3 id=&quot;the-synchrony-assumptions-of-redlock&quot; tabindex=&quot;-1&quot;&gt;The synchrony assumptions of Redlock &lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://hhow09.github.io/blog/redlock/#fn2&quot; id=&quot;fnref2:1&quot;&gt;[2:1]&lt;/a&gt;&lt;/sup&gt; &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/redlock/#the-synchrony-assumptions-of-redlock&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;blockquote&gt;
&lt;p&gt;These examples show that Redlock works correctly only if you assume a synchronous system model – that is, a system with the following properties:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;bounded network delay (you can guarantee that packets always arrive within some guaranteed maximum delay),&lt;/li&gt;
&lt;li&gt;bounded process pauses (in other words, hard real-time constraints, which you typically only find in car airbag systems and suchlike), and&lt;/li&gt;
&lt;li&gt;bounded clock error (cross your fingers that you don’t get your time from a bad NTP server).&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;blockquote&gt;
&lt;p&gt;Redlock assumes that delays, pauses and drift are all small relative to the time-to-live of a lock;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;blockquote&gt;
&lt;p&gt;if the timing issues become as large as the time-to-live, the algorithm fails.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;conclusion&quot; tabindex=&quot;-1&quot;&gt;Conclusion &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/redlock/#conclusion&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;ol&gt;
&lt;li&gt;Redlock is heavy&lt;/li&gt;
&lt;li&gt;Implement fencing token for consistency.&lt;/li&gt;
&lt;li&gt;Count the clock drift and network delay. e.g. lock watchdog &lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://hhow09.github.io/blog/redlock/#fn6&quot; id=&quot;fnref6:1&quot;&gt;[6:1]&lt;/a&gt;&lt;/sup&gt;, Extending the lock&lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://hhow09.github.io/blog/redlock/#fn1&quot; id=&quot;fnref1:3&quot;&gt;[1:3]&lt;/a&gt;&lt;/sup&gt;&lt;/li&gt;
&lt;li&gt;Don&#39;t alter the system time.&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&quot;reference&quot; tabindex=&quot;-1&quot;&gt;Reference &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/redlock/#reference&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;hr class=&quot;footnotes-sep&quot;&gt;
&lt;section class=&quot;footnotes&quot;&gt;
&lt;ol class=&quot;footnotes-list&quot;&gt;
&lt;li id=&quot;fn1&quot; class=&quot;footnote-item&quot;&gt;&lt;p&gt;&lt;a href=&quot;https://redis.io/docs/manual/patterns/distributed-locks/&quot;&gt;Redis: Distributed Locks with Redis&lt;/a&gt; &lt;a href=&quot;https://hhow09.github.io/blog/redlock/#fnref1&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt; &lt;a href=&quot;https://hhow09.github.io/blog/redlock/#fnref1:1&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt; &lt;a href=&quot;https://hhow09.github.io/blog/redlock/#fnref1:2&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt; &lt;a href=&quot;https://hhow09.github.io/blog/redlock/#fnref1:3&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id=&quot;fn2&quot; class=&quot;footnote-item&quot;&gt;&lt;p&gt;&lt;a href=&quot;https://martin.kleppmann.com/2016/02/08/how-to-do-distributed-locking.html&quot;&gt;Martin Kleppmann: How to do distributed locking&lt;/a&gt; &lt;a href=&quot;https://hhow09.github.io/blog/redlock/#fnref2&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt; &lt;a href=&quot;https://hhow09.github.io/blog/redlock/#fnref2:1&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id=&quot;fn3&quot; class=&quot;footnote-item&quot;&gt;&lt;p&gt;&lt;a href=&quot;https://medium.com/starbugs/explain-redlock-in-depth-dba95c107102&quot;&gt;Explain Redlock in Depth&lt;/a&gt; &lt;a href=&quot;https://hhow09.github.io/blog/redlock/#fnref3&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id=&quot;fn4&quot; class=&quot;footnote-item&quot;&gt;&lt;p&gt;&lt;a href=&quot;https://github.com/go-redsync/redsync&quot;&gt;go-redsync/redsync&lt;/a&gt; &lt;a href=&quot;https://hhow09.github.io/blog/redlock/#fnref4&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt; &lt;a href=&quot;https://hhow09.github.io/blog/redlock/#fnref4:1&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt; &lt;a href=&quot;https://hhow09.github.io/blog/redlock/#fnref4:2&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt; &lt;a href=&quot;https://hhow09.github.io/blog/redlock/#fnref4:3&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id=&quot;fn5&quot; class=&quot;footnote-item&quot;&gt;&lt;p&gt;&lt;a href=&quot;http://antirez.com/news/101&quot;&gt;antirez: Is Redlock safe?&lt;/a&gt; &lt;a href=&quot;https://hhow09.github.io/blog/redlock/#fnref5&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt; &lt;a href=&quot;https://hhow09.github.io/blog/redlock/#fnref5:1&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt; &lt;a href=&quot;https://hhow09.github.io/blog/redlock/#fnref5:2&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt; &lt;a href=&quot;https://hhow09.github.io/blog/redlock/#fnref5:3&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id=&quot;fn6&quot; class=&quot;footnote-item&quot;&gt;&lt;p&gt;&lt;a href=&quot;https://github.com/redisson/redisson/wiki/8.-distributed-locks-and-synchronizers#810-fenced-lock&quot;&gt;redisson: Fenced Lock&lt;/a&gt; &lt;a href=&quot;https://hhow09.github.io/blog/redlock/#fnref6&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt; &lt;a href=&quot;https://hhow09.github.io/blog/redlock/#fnref6:1&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;/section&gt;
</content>
	</entry>
	
	<entry>
		<title>Authorization server for mobile applications</title>
		<link href="https://hhow09.github.io/blog/oauth2-server/"/>
		<updated>2023-12-30T00:00:00Z</updated>
		<id>https://hhow09.github.io/blog/oauth2-server/</id>
		<content type="html">&lt;p&gt;Notes of working on Authorization server for mobile applications.&lt;/p&gt;
&lt;h2 id=&quot;goal&quot; tabindex=&quot;-1&quot;&gt;Goal &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/oauth2-server/#goal&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;Manage user registration and authentication for mobile applications.&lt;/li&gt;
&lt;li&gt;Reduce the development time for application teams.&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;requirement&quot; tabindex=&quot;-1&quot;&gt;Requirement &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/oauth2-server/#requirement&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;Any legitimate user from supported 3rd Identity Provider (IDP) (e.g. Google, Apple) can register/login to application.&lt;/li&gt;
&lt;li&gt;Authorization server should manage the user registration and authentication for multiple applications.&lt;/li&gt;
&lt;li&gt;Authorization server should provide a unified authentication process &lt;strong&gt;for application servers&lt;/strong&gt; given different 3rd party identity providers (e.g. google, apple and others... ).
&lt;ul&gt;
&lt;li&gt;Authorization server should works as a &lt;strong&gt;single identity provider&lt;/strong&gt; for application servers.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Authorization server should provide backoffice interface for managing user account and sessions.&lt;/li&gt;
&lt;li&gt;Authorization server should support &lt;strong&gt;refresh token rotation&lt;/strong&gt;.&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;related-rfcs&quot; tabindex=&quot;-1&quot;&gt;Related RFCs &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/oauth2-server/#related-rfcs&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://datatracker.ietf.org/doc/html/rfc6749&quot;&gt;RFC 6749 OAuth 2.0 Authorization Framework&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://datatracker.ietf.org/doc/html/rfc8252&quot;&gt;RFC 8252 OAuth 2.0 for Native Apps&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://datatracker.ietf.org/doc/html/rfc7662&quot;&gt;RFC 7662 OAuth 2.0 Token Introspection&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;terms&quot; tabindex=&quot;-1&quot;&gt;Terms &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/oauth2-server/#terms&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;h3 id=&quot;client&quot; tabindex=&quot;-1&quot;&gt;Client &lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://hhow09.github.io/blog/oauth2-server/#fn1&quot; id=&quot;fnref1&quot;&gt;[1]&lt;/a&gt;&lt;/sup&gt; &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/oauth2-server/#client&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;blockquote&gt;
&lt;p&gt;An application making protected resource requests on behalf of the resource owner and with its authorization.  The term &amp;quot;client&amp;quot; does not imply any particular implementation characteristics (e.g., whether the application executes on a server, a desktop, or other devices).&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h4 id=&quot;native-application-client&quot; tabindex=&quot;-1&quot;&gt;native application client &lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://hhow09.github.io/blog/oauth2-server/#fn2&quot; id=&quot;fnref2&quot;&gt;[2]&lt;/a&gt;&lt;/sup&gt; &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/oauth2-server/#native-application-client&quot;&gt;#&lt;/a&gt;&lt;/h4&gt;
&lt;blockquote&gt;
&lt;p&gt;A native application is a public client installed and executed on the device used by the resource owner.  Protocol data and credentials are accessible to the resource owner.  It is assumed that any client authentication credentials included in the application can be extracted.  On the other hand, dynamically issued credentials such as access tokens or refresh tokens can receive an acceptable level of protection.  At a minimum, these credentials are protected from hostile servers with which the application may interact.  On some platforms, these credentials might be protected from other applications residing on the same device.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&quot;id-token&quot; tabindex=&quot;-1&quot;&gt;ID Token &lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://hhow09.github.io/blog/oauth2-server/#fn3&quot; id=&quot;fnref3&quot;&gt;[3]&lt;/a&gt;&lt;/sup&gt; &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/oauth2-server/#id-token&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;blockquote&gt;
&lt;p&gt;The ID Token is a security token that contains Claims about the Authentication of an End-User by an Authorization Server when using a Client, and potentially other requested Claims. The ID Token is represented as a &lt;a href=&quot;https://openid.net/specs/openid-connect-core-1_0.html#JWT&quot;&gt;JSON Web Token (JWT)&lt;/a&gt; [JWT].&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://developers.google.com/identity/openid-connect/openid-connect&quot;&gt;Google supports open ID Connect&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://developer.android.com/identity/sign-in/credential-manager-siwg#instantiate-google&quot;&gt;Android: Sign-in with Google&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://openid.net/apple-successfully-implements-openid-connect-with-sign-in-with-apple/&quot;&gt;Apple Successfully Implements OpenID Connect with Sign In with Apple&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;design-choices&quot; tabindex=&quot;-1&quot;&gt;Design choices &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/oauth2-server/#design-choices&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;h3 id=&quot;how-to-identify-the-user&quot; tabindex=&quot;-1&quot;&gt;How to identify the user ? &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/oauth2-server/#how-to-identify-the-user&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;The application need to validate the user&#39;s legitimacy on 3rd party identity provider.&lt;/li&gt;
&lt;li&gt;The application does NOT need to access the resource from user.&lt;/li&gt;
&lt;li&gt;Given the requirements, &lt;strong&gt;ID Token&lt;/strong&gt; is the best choice for the application to identify the user.
&lt;ul&gt;
&lt;li&gt;safer than access token.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;login-flow-design&quot; tabindex=&quot;-1&quot;&gt;Login flow design &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/oauth2-server/#login-flow-design&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;Mobile client can use SDK e.g. &lt;a href=&quot;https://developer.android.com/identity/sign-in/credential-manager-siwg#instantiate-google&quot;&gt;Android: Sign-in with Google&lt;/a&gt; obtain &lt;code&gt;id_token&lt;/code&gt; from IDP.&lt;/li&gt;
&lt;li&gt;After obtaining &lt;code&gt;id_token&lt;/code&gt;, the mobile client can follow &lt;a href=&quot;https://datatracker.ietf.org/doc/html/rfc6749#section-4.4&quot;&gt;OAuth2.0: Client Credentials Grant&lt;/a&gt; to request the access of to its own application server (resource server).&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;login-flow&quot; tabindex=&quot;-1&quot;&gt;Login Flow &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/oauth2-server/#login-flow&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;h3 id=&quot;participants&quot; tabindex=&quot;-1&quot;&gt;Participants &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/oauth2-server/#participants&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;Mobile App (client)&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Application Server (resource server)&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;responsible for business logic&lt;/li&gt;
&lt;li&gt;responsible for validating &lt;code&gt;access_token&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Auth Service&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;responsible for user authentication: validating &lt;code&gt;id_token&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;responsible for user authorization: issue &lt;code&gt;access_token&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;responsible manage user account and sessions for application server&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;3rd Party Auth Service (e.g. Google, Apple)&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;responsible for user authentication: issue &lt;code&gt;id_token&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;flow-chart&quot; tabindex=&quot;-1&quot;&gt;Flow Chart &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/oauth2-server/#flow-chart&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;pre class=&quot;mermaid&quot;&gt;sequenceDiagram&amp;#10;    autonumber&amp;#10;    participant App as Mobile App&amp;#10;    participant S as App Server&amp;#10;    participant AS as Auth Service&amp;#10;    participant 3AS as 3rd Party Auth Service (Google|Apple)&amp;#10;&amp;#10;    rect rgb(191, 223, 255)&amp;#10;        note over App: native app plugin&amp;#10;        App -&amp;gt;&amp;gt;+ 3AS: 3rd party login and authorization&amp;#10;        3AS --&amp;gt;&amp;gt;- App: id_token&amp;#10;    end&amp;#10;&amp;#10;    App -&amp;gt;&amp;gt;+ AS: Login(id_token)&amp;#10;    AS -&amp;gt;&amp;gt;+ 3AS: Validate id_token&amp;#10;    3AS --&amp;gt;&amp;gt;- AS: user info&amp;#10;    Note over AS: Identify the existed account or link to a new account&amp;#10;    Note over AS: Initiate new session for an account&amp;#10;    AS --&amp;gt;&amp;gt;- App: Access Token, Refresh Token&amp;#10;&amp;#10;    App -&amp;gt;&amp;gt; S: Request(access_token)&amp;#10;    Note over S: Validate access_token&amp;#10;    Note over S: Handle request&amp;#10;    S --&amp;gt;&amp;gt; App: response&amp;#10;&lt;/pre&gt;
&lt;h3 id=&quot;notes&quot; tabindex=&quot;-1&quot;&gt;Notes &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/oauth2-server/#notes&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;for step 1 - 2, &lt;a href=&quot;https://datatracker.ietf.org/doc/html/rfc6749#section-1.1&quot;&gt;Roles&lt;/a&gt; in the context of OAuth 2.0&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;mobile App served as &lt;a href=&quot;https://datatracker.ietf.org/doc/html/rfc6749#section-1.1&quot;&gt;client&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;3rd Party Auth Service (Google, Apple) served as &lt;a href=&quot;https://datatracker.ietf.org/doc/html/rfc6749#section-1.1&quot;&gt;authorization server&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;App Server served as &lt;a href=&quot;https://datatracker.ietf.org/doc/html/rfc6749#section-1.1&quot;&gt;resource server&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;details flow for step 1 - 2 &lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://hhow09.github.io/blog/oauth2-server/#fn4&quot; id=&quot;fnref4&quot;&gt;[4]&lt;/a&gt;&lt;/sup&gt;
&lt;picture&gt;&lt;source type=&quot;image/avif&quot; srcset=&quot;https://hhow09.github.io/img/zwKiqiahoB-364.avif 364w&quot;&gt;&lt;source type=&quot;image/webp&quot; srcset=&quot;https://hhow09.github.io/img/zwKiqiahoB-364.webp 364w&quot;&gt;&lt;img alt=&quot;Authorization flow for Installed applications&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; src=&quot;https://hhow09.github.io/img/zwKiqiahoB-364.png&quot; width=&quot;364&quot; height=&quot;377&quot;&gt;&lt;/picture&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;after step 3, &lt;a href=&quot;https://datatracker.ietf.org/doc/html/rfc6749#section-1.1&quot;&gt;Roles&lt;/a&gt; in the context of OAuth 2.0&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;mobile App served as &lt;a href=&quot;https://datatracker.ietf.org/doc/html/rfc6749#section-1.1&quot;&gt;client&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Auth Service served as &lt;a href=&quot;https://datatracker.ietf.org/doc/html/rfc6749#section-1.1&quot;&gt;authorization server&lt;/a&gt;&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;App Server served as &lt;a href=&quot;https://datatracker.ietf.org/doc/html/rfc6749#section-1.1&quot;&gt;resource server&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;step 7: resource server token validation&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;blockquote&gt;
&lt;p&gt;The resource server MUST validate the access token and ensure ... &lt;em&gt;&lt;a href=&quot;https://datatracker.ietf.org/doc/html/rfc6749#section-7&quot;&gt;RFC 6749 7&lt;/a&gt;&lt;/em&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ol&gt;
&lt;li&gt;step 7: how to validate access token ?&lt;/li&gt;
&lt;/ol&gt;
&lt;blockquote&gt;
&lt;p&gt;These include using structured token formats such as JWT or proprietary inter-service communication mechanisms &lt;em&gt;&lt;a href=&quot;https://datatracker.ietf.org/doc/html/rfc7662#section-1&quot;&gt;RFC 7662&lt;/a&gt;&lt;/em&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;refresh-token-rotation&quot; tabindex=&quot;-1&quot;&gt;Refresh Token Rotation &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/oauth2-server/#refresh-token-rotation&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;in another post: &lt;a href=&quot;https://hhow09.github.io/blog/oauth2-refresh-token&quot;&gt;OAuth 2.0 - Refresh Token and Rotation&lt;/a&gt;&lt;/p&gt;
&lt;hr&gt;
&lt;h2 id=&quot;tricky-parts&quot; tabindex=&quot;-1&quot;&gt;Tricky Parts &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/oauth2-server/#tricky-parts&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;h3 id=&quot;client-authentication-for-mobile-apps&quot; tabindex=&quot;-1&quot;&gt;Client authentication for mobile apps &lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://hhow09.github.io/blog/oauth2-server/#fn5&quot; id=&quot;fnref5&quot;&gt;[5]&lt;/a&gt;&lt;/sup&gt; &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/oauth2-server/#client-authentication-for-mobile-apps&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;blockquote&gt;
&lt;p&gt;Secrets that are statically included as part of an app distributed to multiple users should not be treated as confidential secrets, as one user may inspect their copy and learn the shared secret.
Authorization servers that still require a statically included shared secret for native app clients MUST treat the client as a public client&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h4 id=&quot;risk-client-impersonation&quot; tabindex=&quot;-1&quot;&gt;Risk: client impersonation &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/oauth2-server/#risk-client-impersonation&quot;&gt;#&lt;/a&gt;&lt;/h4&gt;
&lt;blockquote&gt;
&lt;p&gt;In short, OAuth client impersonation is when one OAuth client pretends to be another, usually to take advantage of any capabilities that the legitimate client may have that are not granted to other clients.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h4 id=&quot;are-there-any-solutions-for-client-impersonation&quot; tabindex=&quot;-1&quot;&gt;Are there any solutions for client impersonation? &lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://hhow09.github.io/blog/oauth2-server/#fn6&quot; id=&quot;fnref6&quot;&gt;[6]&lt;/a&gt;&lt;/sup&gt; &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/oauth2-server/#are-there-any-solutions-for-client-impersonation&quot;&gt;#&lt;/a&gt;&lt;/h4&gt;
&lt;blockquote&gt;
&lt;p&gt;For mobile apps, there is more hope. Apple has an API known as “App Attestation”, and Google has a similar API called “Google Play Integrity”. Both APIs work similarly, with a few technical differences. At a high level, both of them involve the application making a request to the operating system to sign some data. Then the app includes that signed string in the call it makes to the developer’s API. The API can validate the signature against the public key from Apple and Google to determine its confidence level that the API request is made from a real version of the mobile app.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;reference&quot; tabindex=&quot;-1&quot;&gt;Reference &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/oauth2-server/#reference&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;hr class=&quot;footnotes-sep&quot;&gt;
&lt;section class=&quot;footnotes&quot;&gt;
&lt;ol class=&quot;footnotes-list&quot;&gt;
&lt;li id=&quot;fn1&quot; class=&quot;footnote-item&quot;&gt;&lt;p&gt;&lt;a href=&quot;https://datatracker.ietf.org/doc/html/rfc6749#section-1.1&quot;&gt;RFC 6749 1.1&lt;/a&gt; &lt;a href=&quot;https://hhow09.github.io/blog/oauth2-server/#fnref1&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id=&quot;fn2&quot; class=&quot;footnote-item&quot;&gt;&lt;p&gt;&lt;a href=&quot;https://datatracker.ietf.org/doc/html/rfc6749#section-2.1&quot;&gt;RFC 6749 2.1&lt;/a&gt; &lt;a href=&quot;https://hhow09.github.io/blog/oauth2-server/#fnref2&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id=&quot;fn3&quot; class=&quot;footnote-item&quot;&gt;&lt;p&gt;&lt;a href=&quot;https://openid.net/specs/openid-connect-core-1_0.html#IDToken&quot;&gt;OpenID Connect Core 1.0&lt;/a&gt; &lt;a href=&quot;https://hhow09.github.io/blog/oauth2-server/#fnref3&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id=&quot;fn4&quot; class=&quot;footnote-item&quot;&gt;&lt;p&gt;&lt;a href=&quot;https://developers.google.com/identity/protocols/oauth2#installed&quot;&gt;Google OAuth: Installed applications&lt;/a&gt; &lt;a href=&quot;https://hhow09.github.io/blog/oauth2-server/#fnref4&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id=&quot;fn5&quot; class=&quot;footnote-item&quot;&gt;&lt;p&gt;&lt;a href=&quot;https://datatracker.ietf.org/doc/html/rfc8252#section-8.5&quot;&gt;RFC 8252 8.5: Client Authentication&lt;/a&gt; &lt;a href=&quot;https://hhow09.github.io/blog/oauth2-server/#fnref5&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id=&quot;fn6&quot; class=&quot;footnote-item&quot;&gt;&lt;p&gt;&lt;a href=&quot;https://developer.okta.com/blog/2022/06/01/oauth-public-client-identity#what-is-oauth-client-impersonation&quot;&gt;Okta: The Identity of OAuth Public Clients&lt;/a&gt; &lt;a href=&quot;https://hhow09.github.io/blog/oauth2-server/#fnref6&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;/section&gt;
</content>
	</entry>
	
	<entry>
		<title>Idempotency</title>
		<link href="https://hhow09.github.io/blog/idempotency/"/>
		<updated>2023-12-14T00:00:00Z</updated>
		<id>https://hhow09.github.io/blog/idempotency/</id>
		<content type="html">&lt;h2 id=&quot;definition&quot; tabindex=&quot;-1&quot;&gt;Definition &lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://hhow09.github.io/blog/idempotency/#fn1&quot; id=&quot;fnref1&quot;&gt;[1]&lt;/a&gt;&lt;/sup&gt; &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/idempotency/#definition&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;Definition in &lt;a href=&quot;https://en.wikipedia.org/wiki/Idempotence#Idempotent_functions&quot;&gt;Wikipedia&lt;/a&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Idempotence is the property of certain operations in mathematics and computer science whereby they can be applied multiple times without changing the result beyond the initial application.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;blockquote&gt;
&lt;p&gt;idempotent elements are the functions f: E → E […] such that for all x in E, &lt;code&gt;f(f(x)) = f(x)&lt;/code&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;In computer science, the term idempotence may have a different meaning depending on the context in which it is applied&lt;/p&gt;
&lt;h3 id=&quot;in-http-protocol&quot; tabindex=&quot;-1&quot;&gt;In HTTP protocol &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/idempotency/#in-http-protocol&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;&lt;code&gt;GET&lt;/code&gt;, &lt;code&gt;PUT&lt;/code&gt;, and &lt;code&gt;DELETE&lt;/code&gt; should be implemented in an idempotent manner according to the standard, but &lt;code&gt;POST&lt;/code&gt; doesn&#39;t need to be.&lt;/p&gt;
&lt;h3 id=&quot;in-event-driven-driven-system&quot; tabindex=&quot;-1&quot;&gt;in event driven driven system &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/idempotency/#in-event-driven-driven-system&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;In event stream processing, idempotence refers to the ability of a system to produce the same outcome, even if the same file, event or message is received more than once.&lt;/p&gt;
&lt;h2 id=&quot;why-we-need-idempotency-in-distributed-system&quot; tabindex=&quot;-1&quot;&gt;Why we need idempotency in distributed system ? &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/idempotency/#why-we-need-idempotency-in-distributed-system&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;h3 id=&quot;requests-retry-is-inevitable&quot; tabindex=&quot;-1&quot;&gt;Requests retry is inevitable. &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/idempotency/#requests-retry-is-inevitable&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;h4 id=&quot;failures-happen&quot; tabindex=&quot;-1&quot;&gt;Failures Happen &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/idempotency/#failures-happen&quot;&gt;#&lt;/a&gt;&lt;/h4&gt;
&lt;blockquote&gt;
&lt;p&gt;Clients send requests to servers but might not get a response. It&#39;s impossible for clients to know if the response was lost or the server crashed before processing the request. To make sure its request is processed, the client has to resend the request. &lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://hhow09.github.io/blog/idempotency/#fn2&quot; id=&quot;fnref2&quot;&gt;[2]&lt;/a&gt;&lt;/sup&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;blockquote&gt;
&lt;p&gt;Many kinds of failures become apparent as requests taking longer than usual, and potentially never completing. When a client is waiting longer than usual for a request to complete, it also holds on to the resources it was using for that request for a longer time. When a number of requests hold on to resources for a long time, the server can run out of those resources. These resources can include memory, threads, connections, ephemeral ports, or anything else that is limited. &lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://hhow09.github.io/blog/idempotency/#fn3&quot; id=&quot;fnref3&quot;&gt;[3]&lt;/a&gt;&lt;/sup&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;With idempotency, retry will just produce same side effect.&lt;/p&gt;
&lt;p&gt;E.g. &lt;code&gt;/POST record&lt;/code&gt; 1st time, record inserted and returned. 2nd time, find the result and simply return it again.&lt;/p&gt;
&lt;h3 id=&quot;duplicate-messages-are-inevitable&quot; tabindex=&quot;-1&quot;&gt;Duplicate Messages are Inevitable. &lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://hhow09.github.io/blog/idempotency/#fn4&quot; id=&quot;fnref4&quot;&gt;[4]&lt;/a&gt;&lt;/sup&gt; &lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://hhow09.github.io/blog/idempotency/#fn5&quot; id=&quot;fnref5&quot;&gt;[5]&lt;/a&gt;&lt;/sup&gt; &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/idempotency/#duplicate-messages-are-inevitable&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;blockquote&gt;
&lt;p&gt;I&#39;m coining the phrase &amp;quot;effectively-once&amp;quot; for message processing with at-least-once + idempotent operations. &lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://hhow09.github.io/blog/idempotency/#fn6&quot; id=&quot;fnref6&quot;&gt;[6]&lt;/a&gt;&lt;/sup&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;In event driven system, we talks about duplicate messages in both producer and consumer.&lt;/p&gt;
&lt;p&gt;For producer side, duplicate messages happens when message broker fail to acknowledge due temporary error.&lt;/p&gt;
&lt;p&gt;For consumer side, &lt;code&gt;at-least-once&lt;/code&gt; delivery is the most common setting. Since exactly once delivery comes with much more complexity and configuration and performance hurt.&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;An application typically uses a message broker, such as Apache Kafka or RabbitMQ, that implements at-least once delivery. At-least once delivery ensures that messages will be delivered. It does mean, however, that the message broker can invoke a message handler repeatedly for the same message. You must use the Idempotent Consumer pattern to ensure that your message handlers correctly handle duplicate messages.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;determine-if-the-operation-naturally-idempotent&quot; tabindex=&quot;-1&quot;&gt;Determine if the operation naturally Idempotent ? &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/idempotency/#determine-if-the-operation-naturally-idempotent&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;some business logic naturally has follwing properties could be idempotent by default.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;(1) has unique key known by the client&lt;/li&gt;
&lt;li&gt;(2) state does not need to sync between client and server&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;for-example&quot; tabindex=&quot;-1&quot;&gt;For Example &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/idempotency/#for-example&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;(O) register user with email (as primary key)
&lt;ul&gt;
&lt;li&gt;operation is naturally idempotent&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;withdraw account balance of user
&lt;ul&gt;
&lt;li&gt;(X) &lt;code&gt;withdraw(user_id, amount)&lt;/code&gt; cannot be idempotent because the &lt;strong&gt;current balance&lt;/strong&gt;  is not provided beforehand.&lt;/li&gt;
&lt;li&gt;(O) &lt;code&gt;withdraw(user_id, amount, current_balance)&lt;/code&gt; can be made idempotent using &lt;code&gt;current_balance&lt;/code&gt; as optimistic lock. However, the requester need to retrieve &lt;code&gt;current_balance&lt;/code&gt; in advance.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;the-request-included-an-external-api-call&quot; tabindex=&quot;-1&quot;&gt;The request included an external API call &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/idempotency/#the-request-included-an-external-api-call&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;(O) external API provides idempotent design&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;e.g. &lt;a href=&quot;https://brandur.org/idempotency-keys#rocket-rides-phases&quot;&gt;Rocket Ride&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;(X) sending an email&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;contains non-idempotenet &lt;a href=&quot;https://hhow09.github.io/blog/idempotency/#foreign-state-mutations&quot;&gt;foreign state mutations&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;idempotency-key&quot; tabindex=&quot;-1&quot;&gt;Idempotency key &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/idempotency/#idempotency-key&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;h3 id=&quot;rfc&quot; tabindex=&quot;-1&quot;&gt;RFC &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/idempotency/#rfc&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://datatracker.ietf.org/doc/html/draft-ietf-httpapi-idempotency-key-header-04&quot;&gt;RFC Draft: The Idempotency-Key HTTP Header Field&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;definition-1&quot; tabindex=&quot;-1&quot;&gt;Definition &lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://hhow09.github.io/blog/idempotency/#fn7&quot; id=&quot;fnref7&quot;&gt;[7]&lt;/a&gt;&lt;/sup&gt; &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/idempotency/#definition-1&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;blockquote&gt;
&lt;p&gt;An idempotency key is a unique value that’s generated by a client and sent to an API along with a request. The server stores the key to use for bookkeeping the status of that request on its end. If a request should fail partway through, the client retries with the same idempotency key value, and the server uses it to look up the request’s state and continue from where it left off. The name “idempotency key” &lt;a href=&quot;https://stripe.com/blog/idempotency&quot;&gt;comes from Stripe’s API&lt;/a&gt;.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&quot;key-generation&quot; tabindex=&quot;-1&quot;&gt;Key Generation &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/idempotency/#key-generation&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;The idempotency key that is supplied as part of every POST request MUST be unique and MUST NOT be reused with another request with a different request payload. &lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://hhow09.github.io/blog/idempotency/#fn8&quot; id=&quot;fnref8&quot;&gt;[8]&lt;/a&gt;&lt;/sup&gt;&lt;/li&gt;
&lt;li&gt;Uniqueness of the key MUST be defined by the resource owner and MUST be implemented by the clients of the resource server. &lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://hhow09.github.io/blog/idempotency/#fn8&quot; id=&quot;fnref8:1&quot;&gt;[8:1]&lt;/a&gt;&lt;/sup&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;implementations&quot; tabindex=&quot;-1&quot;&gt;Implementations &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/idempotency/#implementations&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;hr&gt;
&lt;h2 id=&quot;idempotent-middleware&quot; tabindex=&quot;-1&quot;&gt;Idempotent Middleware &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/idempotency/#idempotent-middleware&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;Idempotency middleware allows for fault-tolerant APIs where duplicate requests.&lt;/p&gt;
&lt;p&gt;business logic does not aware of the idempotent key&lt;/p&gt;
&lt;h3 id=&quot;flow&quot; tabindex=&quot;-1&quot;&gt;Flow &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/idempotency/#flow&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;pre class=&quot;mermaid&quot;&gt;sequenceDiagram&amp;#10;    title: idempotent middleware flow;&amp;#10;    actor C as Client;&amp;#10;    participant server;&amp;#10;    participant R as request repo;&amp;#10;    participant LS as lock store;&amp;#10;    &amp;#10;    &amp;#10;    C -&amp;gt;&amp;gt; server: request (idempotent_key)&amp;#10;    note over server: verify key&amp;#10;    note over server: check key expiry&amp;#10;    server -&amp;gt;&amp;gt; R: GET Response&amp;#10;&amp;#10;    alt Not Exist (first pass)&amp;#10;        R --&amp;gt;&amp;gt; server: Not Exist&amp;#10;        server -&amp;gt;&amp;gt;+ LS: lock request&amp;#10;        LS --&amp;gt;&amp;gt;- server: success&amp;#10;        note over server: handle request&amp;#10;        server -&amp;gt;&amp;gt;+ R: SET Response&amp;#10;        R --&amp;gt;&amp;gt; server: Success&amp;#10;        server -&amp;gt;&amp;gt;+ LS: unlock request &amp;#10;        LS --&amp;gt;&amp;gt;- server: success    &amp;#10;        server -&amp;gt;&amp;gt; C: Response    &amp;#10;        R --&amp;gt;&amp;gt; server: Response&amp;#10;        server -&amp;gt;&amp;gt; C: Response&amp;#10;    else Exist&amp;#10;        R --&amp;gt;&amp;gt; server: Response&amp;#10;        server -&amp;gt;&amp;gt; C: Response&amp;#10;    end&amp;#10;&lt;/pre&gt;
&lt;h3 id=&quot;idempotency-fingerprint&quot; tabindex=&quot;-1&quot;&gt;Idempotency Fingerprint &lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://hhow09.github.io/blog/idempotency/#fn9&quot; id=&quot;fnref9&quot;&gt;[9]&lt;/a&gt;&lt;/sup&gt; &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/idempotency/#idempotency-fingerprint&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;blockquote&gt;
&lt;p&gt;An idempotency fingerprint MAY be used in conjunction with an idempotency key to determine the uniqueness of a request.  Such a fingerprint is generated from request payload data by the resource server.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;For Example:&lt;/p&gt;
&lt;pre class=&quot;language-go&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-go&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;fingerPrint&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;r &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;http&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Request&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;byte&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;error&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	key &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; r&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Header&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;Get&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;Idempotency-Key&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
	body&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; err &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; io&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;ReadAll&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;r&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Body&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; err &lt;span class=&quot;token operator&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;nil&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;nil&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; fmt&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;Errorf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;fail to read body, err: %w&quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; err&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;Error&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
	fields &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;map&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;any&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;token string&quot;&gt;&quot;body&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;body&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
		&lt;span class=&quot;token string&quot;&gt;&quot;path&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; r&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;URL&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Path&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
		&lt;span class=&quot;token string&quot;&gt;&quot;key&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;  key&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
	b&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; err &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; json&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;Marshal&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;fields&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; err &lt;span class=&quot;token operator&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;nil&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;nil&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; fmt&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;Errorf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;fail to marshal fields, err: %w&quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; err&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;Error&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
	sum &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; sha1&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;Sum&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;b&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; sum&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;nil&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;h3 id=&quot;key-expiration&quot; tabindex=&quot;-1&quot;&gt;Key Expiration &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/idempotency/#key-expiration&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;Does the server store idempotency keys forever? &lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://hhow09.github.io/blog/idempotency/#fn10&quot; id=&quot;fnref10&quot;&gt;[10]&lt;/a&gt;&lt;/sup&gt;&lt;/p&gt;
&lt;h4 id=&quot;stripe&quot; tabindex=&quot;-1&quot;&gt;Stripe &lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://hhow09.github.io/blog/idempotency/#fn11&quot; id=&quot;fnref11&quot;&gt;[11]&lt;/a&gt;&lt;/sup&gt; &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/idempotency/#stripe&quot;&gt;#&lt;/a&gt;&lt;/h4&gt;
&lt;blockquote&gt;
&lt;p&gt;Clients can safely retry requests that include an idempotency key as long as the second request occurs within 24 hours from when you first receive the key (keys expire out of the system after 24 hours).&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h4 id=&quot;rfc-1&quot; tabindex=&quot;-1&quot;&gt;RFC &lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://hhow09.github.io/blog/idempotency/#fn12&quot; id=&quot;fnref12&quot;&gt;[12]&lt;/a&gt;&lt;/sup&gt; &lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://hhow09.github.io/blog/idempotency/#fn13&quot; id=&quot;fnref13&quot;&gt;[13]&lt;/a&gt;&lt;/sup&gt; &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/idempotency/#rfc-1&quot;&gt;#&lt;/a&gt;&lt;/h4&gt;
&lt;blockquote&gt;
&lt;p&gt;The resource MAY enforce time based idempotency keys, thus, be able to purge or delete a key upon its expiry.  The resource server SHOULD define such expiration policy and publish it in the documentation.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;blockquote&gt;
&lt;p&gt;Resource server MUST publish idempotency related specification.  This specification MUST include expiration related policy if applicable. Server is responsible for managing the lifecycle of the idempotency key.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&quot;frameworks&quot; tabindex=&quot;-1&quot;&gt;Frameworks &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/idempotency/#frameworks&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/gofiber/fiber/blob/master/middleware/idempotency/idempotency.go&quot;&gt;Idempotency middleware for Fiber&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;hr&gt;
&lt;h2 id=&quot;integrate-idempotent-key-into-business-logic&quot; tabindex=&quot;-1&quot;&gt;Integrate Idempotent key into business logic &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/idempotency/#integrate-idempotent-key-into-business-logic&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;the blog post &lt;a href=&quot;https://brandur.org/idempotency-keys#acyclic-state-machine&quot;&gt;Implementing Stripe-like Idempotency Keys in Postgres&lt;/a&gt; provides example content in detail.&lt;/p&gt;
&lt;p&gt;TLDR:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;break up steps into atomic phases&lt;/li&gt;
&lt;li&gt;store the state in each atomic phases along with idempotent key&lt;/li&gt;
&lt;li&gt;when user retry with same idempotent key, fetch the current state and continue the flow.&lt;/li&gt;
&lt;li&gt;the external API call need to be idempotent.&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;concept&quot; tabindex=&quot;-1&quot;&gt;Concept &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/idempotency/#concept&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;h4 id=&quot;foreign-state-mutations&quot; tabindex=&quot;-1&quot;&gt;Foreign state mutations &lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://hhow09.github.io/blog/idempotency/#fn7&quot; id=&quot;fnref7:1&quot;&gt;[7:1]&lt;/a&gt;&lt;/sup&gt; &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/idempotency/#foreign-state-mutations&quot;&gt;#&lt;/a&gt;&lt;/h4&gt;
&lt;blockquote&gt;
&lt;p&gt;To shore up our backend, it’s key to identify where we’re making foreign state mutations; that is, calling out and manipulating data on another system. This might be creating a charge on Stripe, adding a DNS record, or sending an email.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;blockquote&gt;
&lt;p&gt;Some foreign state mutations are idempotent by nature (e.g. adding a DNS record), some are not idempotent but can be made idempotent with the help of an idempotency key (e.g. charge on Stripe, sending an email), and some operations are not idempotent, most often because a foreign service hasn’t designed them that way and doesn’t provide a mechanism like an idempotency key.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h4 id=&quot;atomic-phase&quot; tabindex=&quot;-1&quot;&gt;Atomic phase &lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://hhow09.github.io/blog/idempotency/#fn7&quot; id=&quot;fnref7:2&quot;&gt;[7:2]&lt;/a&gt;&lt;/sup&gt; &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/idempotency/#atomic-phase&quot;&gt;#&lt;/a&gt;&lt;/h4&gt;
&lt;blockquote&gt;
&lt;p&gt;An atomic phase is a set of local state mutations that occur in transactions between foreign state mutations.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;blockquote&gt;
&lt;p&gt;Atomic phases should be safely committed before initiating any foreign state mutation. If the call fails, our local state will still have a record of it happening that we can use to retry the operation.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h4 id=&quot;example-rocket-ride&quot; tabindex=&quot;-1&quot;&gt;Example: Rocket Ride &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/idempotency/#example-rocket-ride&quot;&gt;#&lt;/a&gt;&lt;/h4&gt;
&lt;p&gt;&lt;picture&gt;&lt;source type=&quot;image/avif&quot; srcset=&quot;https://hhow09.github.io/img/N0P3bcUe8p-603.avif 603w&quot;&gt;&lt;source type=&quot;image/webp&quot; srcset=&quot;https://hhow09.github.io/img/N0P3bcUe8p-603.webp 603w&quot;&gt;&lt;img alt=&quot;Atomic Phases&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; src=&quot;https://hhow09.github.io/img/N0P3bcUe8p-603.svg&quot; width=&quot;603&quot; height=&quot;339&quot;&gt;&lt;/picture&gt;&lt;/p&gt;
&lt;h4 id=&quot;example-medusa&quot; tabindex=&quot;-1&quot;&gt;Example: Medusa &lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://hhow09.github.io/blog/idempotency/#fn14&quot; id=&quot;fnref14&quot;&gt;[14]&lt;/a&gt;&lt;/sup&gt; &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/idempotency/#example-medusa&quot;&gt;#&lt;/a&gt;&lt;/h4&gt;
&lt;p&gt;&lt;picture&gt;&lt;source type=&quot;image/avif&quot; srcset=&quot;https://hhow09.github.io/img/9e3nk6Bf1--1474.avif 1474w&quot;&gt;&lt;source type=&quot;image/webp&quot; srcset=&quot;https://hhow09.github.io/img/9e3nk6Bf1--1474.webp 1474w&quot;&gt;&lt;img alt=&quot;Idempotency Key implementation in Expressjs&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; src=&quot;https://hhow09.github.io/img/9e3nk6Bf1--1474.png&quot; width=&quot;1474&quot; height=&quot;988&quot;&gt;&lt;/picture&gt;&lt;/p&gt;
&lt;h3 id=&quot;what-if-external-api-is-not-idempotent&quot; tabindex=&quot;-1&quot;&gt;What if External API is not idempotent &lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://hhow09.github.io/blog/idempotency/#fn7&quot; id=&quot;fnref7:3&quot;&gt;[7:3]&lt;/a&gt;&lt;/sup&gt; &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/idempotency/#what-if-external-api-is-not-idempotent&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;blockquote&gt;
&lt;p&gt;Unfortunately, not every service will make this guarantee. If we try to make a non-idempotent foreign state mutation and we see a failure, we may have to persist this operation as permanently errored. In many cases we won’t know whether it’s safe to retry or not, and &lt;strong&gt;we’ll have to take the conservative route and fail the operation.&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;companies-posts&quot; tabindex=&quot;-1&quot;&gt;Companies Posts &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/idempotency/#companies-posts&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;Airbnb: &lt;a href=&quot;https://medium.com/airbnb-engineering/avoiding-double-payments-in-a-distributed-payments-system-2981f6b070bb&quot;&gt;Avoiding Double Payments in a Distributed Payments System&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;Square: &lt;a href=&quot;https://developer.squareup.com/docs/working-with-apis/idempotency&quot;&gt;Working with APIs: Idempotency&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;Stripe：&lt;a href=&quot;https://stripe.com/docs/api/idempotent_requests&quot;&gt;API Reference: Idempotent Requests&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;reference&quot; tabindex=&quot;-1&quot;&gt;Reference &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/idempotency/#reference&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;hr class=&quot;footnotes-sep&quot;&gt;
&lt;section class=&quot;footnotes&quot;&gt;
&lt;ol class=&quot;footnotes-list&quot;&gt;
&lt;li id=&quot;fn1&quot; class=&quot;footnote-item&quot;&gt;&lt;p&gt;&lt;a href=&quot;https://william-yeh.net/post/2020/03/idempotency-key-test/&quot;&gt;Idempotency Key：原理與實測&lt;/a&gt; &lt;a href=&quot;https://hhow09.github.io/blog/idempotency/#fnref1&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id=&quot;fn2&quot; class=&quot;footnote-item&quot;&gt;&lt;p&gt;&lt;a href=&quot;https://martinfowler.com/articles/patterns-of-distributed-systems/idempotent-receiver.html&quot;&gt;Martin Fowler: Idempotent Receiver&lt;/a&gt; &lt;a href=&quot;https://hhow09.github.io/blog/idempotency/#fnref2&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id=&quot;fn3&quot; class=&quot;footnote-item&quot;&gt;&lt;p&gt;&lt;a href=&quot;https://aws.amazon.com/builders-library/timeouts-retries-and-backoff-with-jitter/&quot;&gt;AWS Timeouts, retries, and backoff with jitter&lt;/a&gt; &lt;a href=&quot;https://hhow09.github.io/blog/idempotency/#fnref3&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id=&quot;fn4&quot; class=&quot;footnote-item&quot;&gt;&lt;p&gt;&lt;a href=&quot;https://microservices.io/post/microservices/patterns/2020/10/16/idempotent-consumer.html&quot;&gt;Microservice Architecture: Idempotent consumer pattern&lt;/a&gt; &lt;a href=&quot;https://hhow09.github.io/blog/idempotency/#fnref4&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id=&quot;fn5&quot; class=&quot;footnote-item&quot;&gt;&lt;p&gt;&lt;a href=&quot;https://nejckorasa.github.io/posts/idempotent-kafka-procesing/#understanding-the-intricacies-of-exactly-once-semantics-in-kafka&quot;&gt;Idempotent Processing with Kafka&lt;/a&gt; &lt;a href=&quot;https://hhow09.github.io/blog/idempotency/#fnref5&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id=&quot;fn6&quot; class=&quot;footnote-item&quot;&gt;&lt;p&gt;&lt;a href=&quot;https://twitter.com/viktorklang/status/789036133434978304&quot;&gt;Viktor Klang&#39;s Twitter&lt;/a&gt; &lt;a href=&quot;https://hhow09.github.io/blog/idempotency/#fnref6&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id=&quot;fn7&quot; class=&quot;footnote-item&quot;&gt;&lt;p&gt;&lt;a href=&quot;https://brandur.org/idempotency-keys&quot;&gt;Implementing Stripe-like Idempotency Keys in Postgres&lt;/a&gt; &lt;a href=&quot;https://hhow09.github.io/blog/idempotency/#fnref7&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt; &lt;a href=&quot;https://hhow09.github.io/blog/idempotency/#fnref7:1&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt; &lt;a href=&quot;https://hhow09.github.io/blog/idempotency/#fnref7:2&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt; &lt;a href=&quot;https://hhow09.github.io/blog/idempotency/#fnref7:3&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id=&quot;fn8&quot; class=&quot;footnote-item&quot;&gt;&lt;p&gt;&lt;a href=&quot;https://datatracker.ietf.org/doc/html/draft-ietf-httpapi-idempotency-key-header-04#section-2.2&quot;&gt;RFC Idempotency-Key 2.2&lt;/a&gt; &lt;a href=&quot;https://hhow09.github.io/blog/idempotency/#fnref8&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt; &lt;a href=&quot;https://hhow09.github.io/blog/idempotency/#fnref8:1&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id=&quot;fn9&quot; class=&quot;footnote-item&quot;&gt;&lt;p&gt;&lt;a href=&quot;https://datatracker.ietf.org/doc/html/draft-ietf-httpapi-idempotency-key-header-04#section-2.4&quot;&gt;RFC Idempotency-Key 2.4&lt;/a&gt; &lt;a href=&quot;https://hhow09.github.io/blog/idempotency/#fnref9&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id=&quot;fn10&quot; class=&quot;footnote-item&quot;&gt;&lt;p&gt;&lt;a href=&quot;https://andrewjdawson2016.medium.com/my-thoughts-on-idempotency-9a2f40a01a7e&quot;&gt;My Thoughts on Idempotency&lt;/a&gt; &lt;a href=&quot;https://hhow09.github.io/blog/idempotency/#fnref10&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id=&quot;fn11&quot; class=&quot;footnote-item&quot;&gt;&lt;p&gt;&lt;a href=&quot;https://stripe.com/docs/error-low-level#post-requests&quot;&gt;Stripe Doc&lt;/a&gt; &lt;a href=&quot;https://hhow09.github.io/blog/idempotency/#fnref11&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id=&quot;fn12&quot; class=&quot;footnote-item&quot;&gt;&lt;p&gt;&lt;a href=&quot;https://datatracker.ietf.org/doc/html/draft-ietf-httpapi-idempotency-key-header-04#section-2.3&quot;&gt;RFC Idempotency-Key 2.3&lt;/a&gt; &lt;a href=&quot;https://hhow09.github.io/blog/idempotency/#fnref12&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id=&quot;fn13&quot; class=&quot;footnote-item&quot;&gt;&lt;p&gt;&lt;a href=&quot;https://datatracker.ietf.org/doc/html/draft-ietf-httpapi-idempotency-key-header-04#section-2.5&quot;&gt;RFC Idempotency-Key 2.5&lt;/a&gt; &lt;a href=&quot;https://hhow09.github.io/blog/idempotency/#fnref13&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id=&quot;fn14&quot; class=&quot;footnote-item&quot;&gt;&lt;p&gt;&lt;a href=&quot;https://medusajs.com/blog/idempotency-nodejs-express-open-source/&quot;&gt;An open-source implementation of idempotency keys in NodeJS with Express&lt;/a&gt; &lt;a href=&quot;https://hhow09.github.io/blog/idempotency/#fnref14&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;/section&gt;
</content>
	</entry>
	
	<entry>
		<title>OAuth 2.0 - Refresh Token and Rotation</title>
		<link href="https://hhow09.github.io/blog/oauth2-refresh-token/"/>
		<updated>2023-12-08T00:00:00Z</updated>
		<id>https://hhow09.github.io/blog/oauth2-refresh-token/</id>
		<content type="html">&lt;h2 id=&quot;specification&quot; tabindex=&quot;-1&quot;&gt;Specification &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/oauth2-refresh-token/#specification&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;Refresh tokens are credentials used to obtain access tokens. &lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://hhow09.github.io/blog/oauth2-refresh-token/#fn1&quot; id=&quot;fnref1&quot;&gt;[1]&lt;/a&gt;&lt;/sup&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;(1) when current access token expires.&lt;/li&gt;
&lt;li&gt;(2) to obtain additional access tokens with identical or narrower scope.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Issuing a refresh token is optional at the discretion of the authorization server. &lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://hhow09.github.io/blog/oauth2-refresh-token/#fn1&quot; id=&quot;fnref1:1&quot;&gt;[1:1]&lt;/a&gt;&lt;/sup&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Refresh tokens MUST be kept confidential in transit and storage, and shared only among the authorization server and the client to whom the refresh tokens were issued. &lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://hhow09.github.io/blog/oauth2-refresh-token/#fn2&quot; id=&quot;fnref2&quot;&gt;[2]&lt;/a&gt;&lt;/sup&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;The authorization server MUST maintain the binding between a refresh token and the client to whom it was issued. &lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://hhow09.github.io/blog/oauth2-refresh-token/#fn2&quot; id=&quot;fnref2:1&quot;&gt;[2:1]&lt;/a&gt;&lt;/sup&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Refresh tokens MUST only be transmitted using TLS &lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://hhow09.github.io/blog/oauth2-refresh-token/#fn2&quot; id=&quot;fnref2:2&quot;&gt;[2:2]&lt;/a&gt;&lt;/sup&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;The authorization server MUST verify the binding between the refresh token and client identity. &lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://hhow09.github.io/blog/oauth2-refresh-token/#fn2&quot; id=&quot;fnref2:3&quot;&gt;[2:3]&lt;/a&gt;&lt;/sup&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;When client authentication is not possible, the authorization server SHOULD deploy other means to detect refresh token abuse. &lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://hhow09.github.io/blog/oauth2-refresh-token/#fn2&quot; id=&quot;fnref2:4&quot;&gt;[2:4]&lt;/a&gt;&lt;/sup&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;e.g. &lt;a href=&quot;https://hhow09.github.io/blog/oauth2-refresh-token/#refresh-token-rotation&quot;&gt;Refresh Token Rotation&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;If a refresh token is compromised and subsequently used by both the attacker and the legitimate client, one of them will present an  invalidated refresh token, which will inform the authorization server of the breach. &lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://hhow09.github.io/blog/oauth2-refresh-token/#fn2&quot; id=&quot;fnref2:5&quot;&gt;[2:5]&lt;/a&gt;&lt;/sup&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;The authorization server MUST ensure that refresh tokens cannot be generated, modified, or guessed to produce valid refresh tokens by unauthorized parties. &lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://hhow09.github.io/blog/oauth2-refresh-token/#fn2&quot; id=&quot;fnref2:6&quot;&gt;[2:6]&lt;/a&gt;&lt;/sup&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;cannot be modified: signing&lt;/li&gt;
&lt;li&gt;cannot be guessed: encryption&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&quot;other-specifications&quot; tabindex=&quot;-1&quot;&gt;Other Specifications &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/oauth2-refresh-token/#other-specifications&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;ol&gt;
&lt;li&gt;OAuth 2.0 Token Revocation &lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://hhow09.github.io/blog/oauth2-refresh-token/#fn3&quot; id=&quot;fnref3&quot;&gt;[3]&lt;/a&gt;&lt;/sup&gt;&lt;/li&gt;
&lt;li&gt;Refresh Token Expiration
&lt;ul&gt;
&lt;li&gt;The refresh token has not been used for six months. &lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://hhow09.github.io/blog/oauth2-refresh-token/#fn4&quot; id=&quot;fnref4&quot;&gt;[4]&lt;/a&gt;&lt;/sup&gt;&lt;/li&gt;
&lt;li&gt;LinkedIn offers programmatic refresh tokens that are valid for a fixed length of time. &lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://hhow09.github.io/blog/oauth2-refresh-token/#fn5&quot; id=&quot;fnref5&quot;&gt;[5]&lt;/a&gt;&lt;/sup&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&quot;refresh-access-token&quot; tabindex=&quot;-1&quot;&gt;Refresh Access Token &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/oauth2-refresh-token/#refresh-access-token&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;h3 id=&quot;why&quot; tabindex=&quot;-1&quot;&gt;Why &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/oauth2-refresh-token/#why&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;access token usually issued for a limited time.&lt;/li&gt;
&lt;li&gt;In the scenario of an expiring access token, your application has two alternatives:
&lt;ul&gt;
&lt;li&gt;Ask the users of your application to re-authenticate each time an access token expires.&lt;/li&gt;
&lt;li&gt;The authorization server automatically issues a new access token once it expires.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;how-to-refreshing-an-access-token&quot; tabindex=&quot;-1&quot;&gt;How to Refreshing an Access Token ? &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/oauth2-refresh-token/#how-to-refreshing-an-access-token&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;h4 id=&quot;client-request&quot; tabindex=&quot;-1&quot;&gt;Client Request &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/oauth2-refresh-token/#client-request&quot;&gt;#&lt;/a&gt;&lt;/h4&gt;
&lt;pre&gt;&lt;code&gt;     POST /token HTTP/1.1
     Host: server.example.com
     Authorization: Basic czZCaGRSa3F0MzpnWDFmQmF0M2JW
     Content-Type: application/x-www-form-urlencoded
     grant_type=refresh_token&amp;amp;refresh_token=tGzv3JOkF0XG5Qx2TlKWIA
&lt;/code&gt;&lt;/pre&gt;
&lt;h4 id=&quot;auth-server&quot; tabindex=&quot;-1&quot;&gt;Auth Server &lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://hhow09.github.io/blog/oauth2-refresh-token/#fn6&quot; id=&quot;fnref6&quot;&gt;[6]&lt;/a&gt;&lt;/sup&gt; &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/oauth2-refresh-token/#auth-server&quot;&gt;#&lt;/a&gt;&lt;/h4&gt;
&lt;ol&gt;
&lt;li&gt;MUST authenticate the client if client authentication is included&lt;/li&gt;
&lt;li&gt;MUST validate the refresh token.&lt;/li&gt;
&lt;li&gt;IF valid and authorized, the authorization server issues an access token&lt;/li&gt;
&lt;li&gt;The authorization server MAY issue a new refresh token, in which case the client MUST discard the old refresh token and replace it with the new refresh token.&lt;/li&gt;
&lt;li&gt;The authorization server MAY revoke the old refresh token after issuing a new refresh token to the client.&lt;/li&gt;
&lt;li&gt;If a new refresh token is issued, the refresh token scope MUST be identical to that of the refresh token included by the client in the request.&lt;/li&gt;
&lt;/ol&gt;
&lt;h4 id=&quot;flow&quot; tabindex=&quot;-1&quot;&gt;Flow &lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://hhow09.github.io/blog/oauth2-refresh-token/#fn7&quot; id=&quot;fnref7&quot;&gt;[7]&lt;/a&gt;&lt;/sup&gt; &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/oauth2-refresh-token/#flow&quot;&gt;#&lt;/a&gt;&lt;/h4&gt;
&lt;pre&gt;&lt;code&gt;  +--------+                                           +---------------+
  |        |--(A)------- Authorization Grant ---------&amp;gt;|               |
  |        |                                           |               |
  |        |&amp;lt;-(B)----------- Access Token -------------|               |
  |        |               &amp;amp; Refresh Token             |               |
  |        |                                           |               |
  |        |                            +----------+   |               |
  |        |--(C)---- Access Token ----&amp;gt;|          |   |               |
  |        |                            |          |   |               |
  |        |&amp;lt;-(D)- Protected Resource --| Resource |   | Authorization |
  | Client |                            |  Server  |   |     Server    |
  |        |--(E)---- Access Token ----&amp;gt;|          |   |               |
  |        |                            |          |   |               |
  |        |&amp;lt;-(F)- Invalid Token Error -|          |   |               |
  |        |                            +----------+   |               |
  |        |                                           |               |
  |        |--(G)----------- Refresh Token -----------&amp;gt;|               |
  |        |                                           |               |
  |        |&amp;lt;-(H)----------- Access Token -------------|               |
  +--------+           &amp;amp; Optional Refresh Token        +---------------+

               Figure 2: Refreshing an Expired Access Token
&lt;/code&gt;&lt;/pre&gt;
&lt;h2 id=&quot;refresh-token-rotation&quot; tabindex=&quot;-1&quot;&gt;Refresh Token Rotation &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/oauth2-refresh-token/#refresh-token-rotation&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;ol&gt;
&lt;li&gt;Refresh token rotation is intended to automatically detect and prevent attempts to use the same refresh token in parallel from different apps/devices. This happens if a token gets stolen from the client and is subsequently used by both the attacker and the legitimate client. &lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://hhow09.github.io/blog/oauth2-refresh-token/#fn8&quot; id=&quot;fnref8&quot;&gt;[8]&lt;/a&gt;&lt;/sup&gt;&lt;/li&gt;
&lt;li&gt;The basic idea is to change the refresh token value with every refresh request in order to detect attempts to obtain access tokens using old refresh tokens. &lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://hhow09.github.io/blog/oauth2-refresh-token/#fn8&quot; id=&quot;fnref8:1&quot;&gt;[8:1]&lt;/a&gt;&lt;/sup&gt;&lt;/li&gt;
&lt;li&gt;It&#39;s a way to prevent token reuse according to &lt;a href=&quot;https://hhow09.github.io/blog/oauth2-refresh-token/#specification&quot;&gt;Specification 7&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&quot;implementatino-notes&quot; tabindex=&quot;-1&quot;&gt;Implementatino Notes &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/oauth2-refresh-token/#implementatino-notes&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;ol&gt;
&lt;li&gt;In accessing data storage layer, (1) New Refresh Token and (2) Invalidate Refresh Token should be atomic.&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://developer.okta.com/docs/guides/refresh-tokens/main/#refresh-token-rotation&quot;&gt;Okta: Refresh token rotation&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://auth0.com/docs/secure/tokens/refresh-tokens/refresh-token-rotation&quot;&gt;Auth0: Refresh Token Rotation&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&quot;refresh-token-reuse-detection&quot; tabindex=&quot;-1&quot;&gt;Refresh token reuse detection &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/oauth2-refresh-token/#refresh-token-reuse-detection&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;ol&gt;
&lt;li&gt;If a previously used refresh token is used again with the token request, the authorization server automatically detects the attempted reuse of the refresh token. &lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://hhow09.github.io/blog/oauth2-refresh-token/#fn9&quot; id=&quot;fnref9&quot;&gt;[9]&lt;/a&gt;&lt;/sup&gt;&lt;/li&gt;
&lt;li&gt;As a result, Okta immediately invalidates the most recently issued refresh token and all access tokens issued since the user authenticated. This protects your application from token compromise and replay attacks.&lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://hhow09.github.io/blog/oauth2-refresh-token/#fn9&quot; id=&quot;fnref9:1&quot;&gt;[9:1]&lt;/a&gt;&lt;/sup&gt;
&lt;ul&gt;
&lt;li&gt;Since the authorization server cannot determine whether the attacker or the legitimate client is trying to access, in case of such an access attempt the valid refresh token and the access authorization associated with it are both revoked. &lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://hhow09.github.io/blog/oauth2-refresh-token/#fn8&quot; id=&quot;fnref8:2&quot;&gt;[8:2]&lt;/a&gt;&lt;/sup&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&quot;reuse-scenario&quot; tabindex=&quot;-1&quot;&gt;Reuse Scenario &lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://hhow09.github.io/blog/oauth2-refresh-token/#fn10&quot; id=&quot;fnref10&quot;&gt;[10]&lt;/a&gt;&lt;/sup&gt; &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/oauth2-refresh-token/#reuse-scenario&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;&lt;picture&gt;&lt;source type=&quot;image/avif&quot; srcset=&quot;https://hhow09.github.io/img/1-cV09DgQ2-2999.avif 2999w&quot;&gt;&lt;source type=&quot;image/webp&quot; srcset=&quot;https://hhow09.github.io/img/1-cV09DgQ2-2999.webp 2999w&quot;&gt;&lt;img alt=&quot;Scenario 1: Refresh Token Reuse&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; src=&quot;https://hhow09.github.io/img/1-cV09DgQ2-2999.png&quot; width=&quot;2999&quot; height=&quot;1687&quot;&gt;&lt;/picture&gt;&lt;/p&gt;
&lt;p&gt;&lt;picture&gt;&lt;source type=&quot;image/avif&quot; srcset=&quot;https://hhow09.github.io/img/KIbZ25k-l1-2999.avif 2999w&quot;&gt;&lt;source type=&quot;image/webp&quot; srcset=&quot;https://hhow09.github.io/img/KIbZ25k-l1-2999.webp 2999w&quot;&gt;&lt;img alt=&quot;Scenario 2: Refresh Token Reuse&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; src=&quot;https://hhow09.github.io/img/KIbZ25k-l1-2999.png&quot; width=&quot;2999&quot; height=&quot;1687&quot;&gt;&lt;/picture&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;In these scenarios, the reuse of a refresh token triggers all kinds of alarms with the authorization server. Refresh token reuse likely means that a second party is trying to use a stolen refresh token. In response to this reuse, the authorization server immediately revokes the reused refresh token, along with all descendant tokens. Concretely, all refresh tokens that have ever been derived from the reused refresh token become invalid.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&quot;issue-client-can-retry-v-s-replay-attack&quot; tabindex=&quot;-1&quot;&gt;Issue: Client Can Retry v.s. Replay attack &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/oauth2-refresh-token/#issue-client-can-retry-v-s-replay-attack&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;Token reuse detection can sometimes impact the user experience. For example, when users with poor network connections access apps, new tokens issued by Okta might not reach the client app. As a result, the client might want to reuse the refresh token to get new tokens. &lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://hhow09.github.io/blog/oauth2-refresh-token/#fn11&quot; id=&quot;fnref11&quot;&gt;[11]&lt;/a&gt;&lt;/sup&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;According to &lt;a href=&quot;https://hhow09.github.io/blog/oauth2-refresh-token/#specification&quot;&gt;Specification 8&lt;/a&gt;, Refresh token reuse detection should be implemented for preventing &lt;a href=&quot;https://auth0.com/docs/secure/security-guidance/prevent-threats#replay-attacks&quot;&gt;replay attack&lt;/a&gt;.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Without enforcing sender-constraint, it’s impossible for the authorization server to know which actor is legitimate or malicious in the event of a replay attack. &lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://hhow09.github.io/blog/oauth2-refresh-token/#fn12&quot; id=&quot;fnref12&quot;&gt;[12]&lt;/a&gt;&lt;/sup&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;If retry is allowed, it means somehow security is sacrificed in some degree.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Related discussion: &lt;a href=&quot;https://github.com/ory/hydra/issues/1831&quot;&gt;ory/hydra: Refresh tokens need a grace period to deal with network errors and similar issues #1831&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;h4 id=&quot;solution-from-okta-grace-period&quot; tabindex=&quot;-1&quot;&gt;Solution from Okta: Grace period &lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://hhow09.github.io/blog/oauth2-refresh-token/#fn11&quot; id=&quot;fnref11:1&quot;&gt;[11:1]&lt;/a&gt;&lt;/sup&gt; &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/oauth2-refresh-token/#solution-from-okta-grace-period&quot;&gt;#&lt;/a&gt;&lt;/h4&gt;
&lt;ul&gt;
&lt;li&gt;Okta offers a grace period when you configure refresh token rotation. After the refresh token is rotated, the previous token remains valid for the configured amount of time to allow clients to get the new token.&lt;/li&gt;
&lt;li&gt;The default number of seconds for the Grace period for token rotation is set to &lt;strong&gt;30&lt;/strong&gt; seconds. You can change the value to any number from 0-60 seconds. After the refresh token is rotated, the previous token remains valid for this amount of time to allow clients to get the new token.&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id=&quot;solution-from-auth0-grace-period&quot; tabindex=&quot;-1&quot;&gt;Solution from Auth0: Grace period &lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://hhow09.github.io/blog/oauth2-refresh-token/#fn13&quot; id=&quot;fnref13&quot;&gt;[13]&lt;/a&gt;&lt;/sup&gt; &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/oauth2-refresh-token/#solution-from-auth0-grace-period&quot;&gt;#&lt;/a&gt;&lt;/h4&gt;
&lt;ul&gt;
&lt;li&gt;Enter Reuse Interval (in seconds) for the refresh token to account for leeway time between request and response before triggering automatic reuse detection. This interval helps to avoid concurrency issues when exchanging the rotating refresh token multiple times within a given timeframe. During the leeway window the breach detection features don&#39;t apply and a new rotating refresh token is issued. Only the previous token can be reused; if the second-to-last one is exchanged, breach detection will be triggered.&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id=&quot;solution-from-ory-fosite-grace-period&quot; tabindex=&quot;-1&quot;&gt;Solution from ory/fosite: Grace period &lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://hhow09.github.io/blog/oauth2-refresh-token/#fn14&quot; id=&quot;fnref14&quot;&gt;[14]&lt;/a&gt;&lt;/sup&gt; &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/oauth2-refresh-token/#solution-from-ory-fosite-grace-period&quot;&gt;#&lt;/a&gt;&lt;/h4&gt;
&lt;pre class=&quot;language-go&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-go&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// https://github.com/ory/fosite/blob/869a37ce486cb0ca921449319e1048004b2f1bd8/handler/oauth2/flow_refresh.go#L144&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;c &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;RefreshTokenGrantHandler&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;PopulateTokenEndpointResponse&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ctx context&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Context&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; requester fosite&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;AccessRequester&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; responder fosite&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;AccessResponder&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;err &lt;span class=&quot;token builtin&quot;&gt;error&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token comment&quot;&gt;// ...&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; err &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; c&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;TokenRevocationStorage&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;RevokeRefreshTokenMaybeGracePeriod&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ctx&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; ts&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;GetID&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; signature&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; err &lt;span class=&quot;token operator&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;nil&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; err
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token comment&quot;&gt;// ...&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;ul&gt;
&lt;li&gt;PR on storage implimentation: &lt;a href=&quot;https://github.com/ory/hydra/pull/2827&quot;&gt;feat: Refresh token expiration window #2827&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id=&quot;solution-2-revokaion-on-use&quot; tabindex=&quot;-1&quot;&gt;Solution 2: Revokaion-On-Use &lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://hhow09.github.io/blog/oauth2-refresh-token/#fn15&quot; id=&quot;fnref15&quot;&gt;[15]&lt;/a&gt;&lt;/sup&gt; &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/oauth2-refresh-token/#solution-2-revokaion-on-use&quot;&gt;#&lt;/a&gt;&lt;/h4&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;Allow client retry with same refresh token&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Keep track of (1) one parent toke (RT1) and (2) a pool of child tokens.&lt;/li&gt;
&lt;li&gt;parent token means the latest token&#39;s&lt;/li&gt;
&lt;li&gt;child token means the retry-results of same parent. But &lt;strong&gt;we don&#39;t know if they actually successfully recieved by client&lt;/strong&gt;.&lt;/li&gt;
&lt;li&gt;parent token (RT1) could generate multiple child refresh tokens and access tokens in pairs ((RT2, AT2), (RT2-1, AT2-1)...). Keep track of them.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Invalidate other refresh tokens AFTER (1) one of sibling refresh token or (2) the corresponding &lt;code&gt;access_token&lt;/code&gt; once used.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Once &lt;code&gt;AT2-1&lt;/code&gt; is used, (1) sibling (RT2, AT2), (RT2-2, AT2)... should be revoked
&lt;ul&gt;
&lt;li&gt;because it ensures client already received one of the retries.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Once &lt;code&gt;RT2-1&lt;/code&gt; is used (in next refresh), (1) sibling (RT2, AT2), (RT2-2, AT2)... should be revoked (2) (RT3, AT3) should be generated (3) &lt;code&gt;RT2-1&lt;/code&gt; should considered used and become parent.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Concurrent token READ (token introspection) and WRITE (refresh token) should be handled carefully.&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&quot;open-source-oauth-server&quot; tabindex=&quot;-1&quot;&gt;Open Source OAuth Server &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/oauth2-refresh-token/#open-source-oauth-server&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/ory/fosite.git&quot;&gt;https://github.com/ory/fosite.git&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/supertokens/supertokens-core&quot;&gt;https://github.com/supertokens/supertokens-core&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/keycloak/keycloak/blob/main/services/src/main/java/org/keycloak/jose/jws/DefaultTokenManager.java&quot;&gt;https://github.com/keycloak/keycloak/blob/main/services/src/main/java/org/keycloak/jose/jws/DefaultTokenManager.java&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;reference&quot; tabindex=&quot;-1&quot;&gt;Reference &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/oauth2-refresh-token/#reference&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;hr class=&quot;footnotes-sep&quot;&gt;
&lt;section class=&quot;footnotes&quot;&gt;
&lt;ol class=&quot;footnotes-list&quot;&gt;
&lt;li id=&quot;fn1&quot; class=&quot;footnote-item&quot;&gt;&lt;p&gt;&lt;a href=&quot;https://datatracker.ietf.org/doc/html/rfc6749#section-1.5&quot;&gt;RFC 6749 1.5: Refresh Token&lt;/a&gt; &lt;a href=&quot;https://hhow09.github.io/blog/oauth2-refresh-token/#fnref1&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt; &lt;a href=&quot;https://hhow09.github.io/blog/oauth2-refresh-token/#fnref1:1&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id=&quot;fn2&quot; class=&quot;footnote-item&quot;&gt;&lt;p&gt;&lt;a href=&quot;https://datatracker.ietf.org/doc/html/rfc6749#section-10.4&quot;&gt;RFC 6749 10.4: Refresh Tokens&lt;/a&gt; &lt;a href=&quot;https://hhow09.github.io/blog/oauth2-refresh-token/#fnref2&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt; &lt;a href=&quot;https://hhow09.github.io/blog/oauth2-refresh-token/#fnref2:1&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt; &lt;a href=&quot;https://hhow09.github.io/blog/oauth2-refresh-token/#fnref2:2&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt; &lt;a href=&quot;https://hhow09.github.io/blog/oauth2-refresh-token/#fnref2:3&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt; &lt;a href=&quot;https://hhow09.github.io/blog/oauth2-refresh-token/#fnref2:4&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt; &lt;a href=&quot;https://hhow09.github.io/blog/oauth2-refresh-token/#fnref2:5&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt; &lt;a href=&quot;https://hhow09.github.io/blog/oauth2-refresh-token/#fnref2:6&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id=&quot;fn3&quot; class=&quot;footnote-item&quot;&gt;&lt;p&gt;&lt;a href=&quot;https://datatracker.ietf.org/doc/html/rfc7009&quot;&gt;RFC 7009: OAuth 2.0 Token Revocation&lt;/a&gt; &lt;a href=&quot;https://hhow09.github.io/blog/oauth2-refresh-token/#fnref3&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id=&quot;fn4&quot; class=&quot;footnote-item&quot;&gt;&lt;p&gt;&lt;a href=&quot;https://developers.google.com/identity/protocols/oauth2?hl=en#5.-refresh-the-access-token,-if-necessary&quot;&gt;Google OAuth&lt;/a&gt; &lt;a href=&quot;https://hhow09.github.io/blog/oauth2-refresh-token/#fnref4&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id=&quot;fn5&quot; class=&quot;footnote-item&quot;&gt;&lt;p&gt;&lt;a href=&quot;https://learn.microsoft.com/en-us/linkedin/shared/authentication/programmatic-refresh-tokens&quot;&gt;Google Refresh Tokens with OAuth 2.0&lt;/a&gt; &lt;a href=&quot;https://hhow09.github.io/blog/oauth2-refresh-token/#fnref5&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id=&quot;fn6&quot; class=&quot;footnote-item&quot;&gt;&lt;p&gt;&lt;a href=&quot;https://datatracker.ietf.org/doc/html/rfc6749#section-6&quot;&gt;RFC 6749 6: Refreshing an Access Token&lt;/a&gt; &lt;a href=&quot;https://hhow09.github.io/blog/oauth2-refresh-token/#fnref6&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id=&quot;fn7&quot; class=&quot;footnote-item&quot;&gt;&lt;p&gt;&lt;a href=&quot;https://datatracker.ietf.org/doc/html/rfc6749#section-1.5&quot;&gt;RFC 6749 1.5: Refresh Token&lt;/a&gt; &lt;a href=&quot;https://hhow09.github.io/blog/oauth2-refresh-token/#fnref7&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id=&quot;fn8&quot; class=&quot;footnote-item&quot;&gt;&lt;p&gt;&lt;a href=&quot;https://datatracker.ietf.org/doc/html/rfc6819#section-5.2.2.3&quot;&gt;RFC 6819 5.2.2.3: Refresh Token Rotation&lt;/a&gt; &lt;a href=&quot;https://hhow09.github.io/blog/oauth2-refresh-token/#fnref8&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt; &lt;a href=&quot;https://hhow09.github.io/blog/oauth2-refresh-token/#fnref8:1&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt; &lt;a href=&quot;https://hhow09.github.io/blog/oauth2-refresh-token/#fnref8:2&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id=&quot;fn9&quot; class=&quot;footnote-item&quot;&gt;&lt;p&gt;&lt;a href=&quot;https://developer.okta.com/docs/guides/refresh-tokens/main/#set-up-your-application&quot;&gt;Okta: Refresh token reuse detection&lt;/a&gt; &lt;a href=&quot;https://hhow09.github.io/blog/oauth2-refresh-token/#fnref9&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt; &lt;a href=&quot;https://hhow09.github.io/blog/oauth2-refresh-token/#fnref9:1&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id=&quot;fn10&quot; class=&quot;footnote-item&quot;&gt;&lt;p&gt;&lt;a href=&quot;https://www.pingidentity.com/en/resources/blog/post/refresh-token-rotation-spa.html&quot;&gt;A Critical Analysis of Refresh Token Rotation in Single-page Applications&lt;/a&gt; &lt;a href=&quot;https://hhow09.github.io/blog/oauth2-refresh-token/#fnref10&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id=&quot;fn11&quot; class=&quot;footnote-item&quot;&gt;&lt;p&gt;&lt;a href=&quot;https://developer.okta.com/docs/guides/refresh-tokens/main/#grace-period-for-token-rotation&quot;&gt;Okta: Grace period for token rotation&lt;/a&gt; &lt;a href=&quot;https://hhow09.github.io/blog/oauth2-refresh-token/#fnref11&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt; &lt;a href=&quot;https://hhow09.github.io/blog/oauth2-refresh-token/#fnref11:1&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id=&quot;fn12&quot; class=&quot;footnote-item&quot;&gt;&lt;p&gt;&lt;a href=&quot;https://auth0.com/docs/secure/tokens/refresh-tokens/refresh-token-rotation&quot;&gt;Auth0: Refresh Token Rotation&lt;/a&gt; &lt;a href=&quot;https://hhow09.github.io/blog/oauth2-refresh-token/#fnref12&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id=&quot;fn13&quot; class=&quot;footnote-item&quot;&gt;&lt;p&gt;&lt;a href=&quot;https://auth0.com/docs/secure/tokens/refresh-tokens/configure-refresh-token-rotation&quot;&gt;Auth0: Configure Refresh Token Rotation&lt;/a&gt; &lt;a href=&quot;https://hhow09.github.io/blog/oauth2-refresh-token/#fnref13&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id=&quot;fn14&quot; class=&quot;footnote-item&quot;&gt;&lt;p&gt;&lt;a href=&quot;https://github.com/ory/fosite&quot;&gt;ory/fosite&lt;/a&gt; &lt;a href=&quot;https://hhow09.github.io/blog/oauth2-refresh-token/#fnref14&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id=&quot;fn15&quot; class=&quot;footnote-item&quot;&gt;&lt;p&gt;&lt;a href=&quot;https://devforum.zoom.us/t/how-to-protect-against-losing-refresh-token-response/10375/1&quot;&gt;How to protect against losing &lt;code&gt;refresh_token&lt;/code&gt; response?&lt;/a&gt; &lt;a href=&quot;https://hhow09.github.io/blog/oauth2-refresh-token/#fnref15&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;/section&gt;
</content>
	</entry>
	
	<entry>
		<title>Dremel: A Decade of Interactive SQL Analysis at Web Scale</title>
		<link href="https://hhow09.github.io/blog/paper-dremel/"/>
		<updated>2023-06-10T00:00:00Z</updated>
		<id>https://hhow09.github.io/blog/paper-dremel/</id>
		<content type="html">&lt;p&gt;Paper: &lt;a href=&quot;https://15721.courses.cs.cmu.edu/spring2023/papers/19-bigquery/p3461-melnik.pdf&quot;&gt;Dremel: A Decade of Interactive SQL Analysis at Web Scale&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;introduction&quot; tabindex=&quot;-1&quot;&gt;Introduction &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/paper-dremel/#introduction&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;the main ideas we highlight in this paper are:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;SQL: simple SQL query to analyze nested data&lt;/li&gt;
&lt;li&gt;Disaggregated compute and storage: decouples compute from storage&lt;/li&gt;
&lt;li&gt;In situ analysis: different compute engines can operate on same piece of data&lt;/li&gt;
&lt;li&gt;Serverless computing: fully managed internal service&lt;/li&gt;
&lt;li&gt;Columnar storage&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&quot;embracing-sql&quot; tabindex=&quot;-1&quot;&gt;Embracing SQL &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/paper-dremel/#embracing-sql&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;Because SQL doesn’t scale, GFS and MapReduce became the standard ways to store and process huge datasets. However writing analysis jobs on these systems is difficult and complex. Dremel was one of the first systems to &lt;strong&gt;reintroduce SQL for Big
Data analysis&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;In Google, nearly all data passed between applications or stored on disk was in &lt;a href=&quot;https://protobuf.dev/&quot;&gt;Protocol Buffers&lt;/a&gt;. Dremel&#39;s critical innovations includes &lt;strong&gt;first-class support for structured data&lt;/strong&gt;. Dremel made it easy to query that hierarchical data with SQL.&lt;/p&gt;
&lt;h2 id=&quot;disaggregated-storage&quot; tabindex=&quot;-1&quot;&gt;Disaggregated storage &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/paper-dremel/#disaggregated-storage&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;Dremel started with shared-nothing servers and computation is coupled with storage.&lt;/p&gt;
&lt;p&gt;In 2009, Dremel was migrated to &lt;a href=&quot;https://cloud.google.com/blog/products/bigquery/bigquery-under-the-hood&quot;&gt;Borg (cluster management)&lt;/a&gt; and replicated storage. It accommodate the growing query workload and improve the utilization of the service. However &lt;strong&gt;storage and processing are still coupled&lt;/strong&gt;. Which means&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;all algorithms needed to be replication-aware&lt;/li&gt;
&lt;li&gt;resizing server also need to &lt;strong&gt;move data&lt;/strong&gt; around.&lt;/li&gt;
&lt;li&gt;Resources can only be accessed by Dremel.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Later Dremel was migrated from local disk to GFS. Performance was initially degraded. After lots of fine-tuning,  disaggregated storage outperformed the local-disk based system. There are several advantages:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;improved SLOs and robustness of Dremel because GFS is fully-managed service.&lt;/li&gt;
&lt;li&gt;No more need to load from GFS onto Dremel server’s local disks.&lt;/li&gt;
&lt;li&gt;No need to resize our clusters in order to load new data.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Another notch of scalability and robustness was gained once Google’s file system was migrated from GFS (single-master model) to &lt;a href=&quot;https://cloud.google.com/blog/products/bigquery/bigquery-under-the-hood&quot;&gt;Colossus (distributed multi-master model)&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;&lt;picture&gt;&lt;source type=&quot;image/avif&quot; srcset=&quot;https://hhow09.github.io/img/ZNSywBCsI0-990.avif 990w&quot;&gt;&lt;source type=&quot;image/webp&quot; srcset=&quot;https://hhow09.github.io/img/ZNSywBCsI0-990.webp 990w&quot;&gt;&lt;img alt=&quot;Figure 1: Disaggregated storage, memory, and compute&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; src=&quot;https://hhow09.github.io/img/ZNSywBCsI0-990.png&quot; width=&quot;990&quot; height=&quot;512&quot;&gt;&lt;/picture&gt;&lt;/p&gt;
&lt;h2 id=&quot;disaggregated-memory&quot; tabindex=&quot;-1&quot;&gt;Disaggregated memory &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/paper-dremel/#disaggregated-memory&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;Dremel added support for &lt;strong&gt;distributed joins&lt;/strong&gt; with &lt;strong&gt;shuffle&lt;/strong&gt; utilizing &lt;strong&gt;local RAM and disk&lt;/strong&gt; to store sorted intermediate results. However there is bottleneck in scalability and multi-tenancy due to the  coupling between the compute nodes intermediate shuffle storage.&lt;/p&gt;
&lt;p&gt;In 2014, Dremel shuffle migrated to a &lt;a href=&quot;https://cloud.google.com/blog/products/bigquery/in-memory-query-execution-in-google-bigquery&quot;&gt;new shuffle infrastructure&lt;/a&gt;. Shuffle data were stored in a distributed transient storage system. Improved peformance in-terms of latency and larger shuffle and service cost was observed.&lt;/p&gt;
&lt;p&gt;&lt;picture&gt;&lt;source type=&quot;image/avif&quot; srcset=&quot;https://hhow09.github.io/img/7rg3rOR0mF-1164.avif 1164w&quot;&gt;&lt;source type=&quot;image/webp&quot; srcset=&quot;https://hhow09.github.io/img/7rg3rOR0mF-1164.webp 1164w&quot;&gt;&lt;img alt=&quot;Disaggregated in-memory shuffle&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; src=&quot;https://hhow09.github.io/img/7rg3rOR0mF-1164.png&quot; width=&quot;1164&quot; height=&quot;1012&quot;&gt;&lt;/picture&gt;&lt;/p&gt;
&lt;h2 id=&quot;observations&quot; tabindex=&quot;-1&quot;&gt;Observations &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/paper-dremel/#observations&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;Disaggregation proved to be a major trend in data management.&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Economies of scale&lt;/li&gt;
&lt;li&gt;Universality&lt;/li&gt;
&lt;li&gt;Higher-level APIs:  Storage access is far removed from the early block I/O APIs.&lt;/li&gt;
&lt;li&gt;Value-added repackaging&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&quot;in-situ-data-analysis&quot; tabindex=&quot;-1&quot;&gt;In Situ Data Analysis &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/paper-dremel/#in-situ-data-analysis&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;The data management community finds itself today in the middle of a transition from classical data warehouses to a &lt;strong&gt;datalake-oriented architecture&lt;/strong&gt; for analytics. The trend includes:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;consuming data from a variety of data sources&lt;/li&gt;
&lt;li&gt;eliminating traditional ETL-based data ingestion from an OLTP system to a data warehouse&lt;/li&gt;
&lt;li&gt;enabling a variety of compute engines to operate on the data.&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&quot;dremel-s-evolution-to-in-situ-analysis&quot; tabindex=&quot;-1&quot;&gt;Dremel’s evolution to in situ analysis &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/paper-dremel/#dremel-s-evolution-to-in-situ-analysis&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;Dremel’s initial design in 2006 was reminiscent of traditional DBMSs:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;explicit data loading was required.&lt;/li&gt;
&lt;li&gt;the data was stored in a proprietary format.&lt;/li&gt;
&lt;li&gt;inaccessible to other tools.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;As part of migrating Dremel to GFS, Dremel open the &lt;strong&gt;storage format&lt;/strong&gt; (as a library) within Google which has 2 distinguising properties: &lt;strong&gt;columnar&lt;/strong&gt;, &lt;strong&gt;self-dsecribing&lt;/strong&gt;. The &lt;strong&gt;self-dsecribing&lt;/strong&gt; feature enables interoperation between custom data transformation tools and SQL-based analytics.  MapReduce jobs could run on columnar data, write out columnar results, and those results could be immediately queried via Dremel. Users no longer had to load data into their data warehouse, any file they had in the GFS could effectively be queryable.&lt;/p&gt;
&lt;p&gt;In situ approach was evolved in two complementary directions:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;adding file formats beyond original columnar format.&lt;/li&gt;
&lt;li&gt;expanding the universe of joinable data ( e.g. BigTable, Cloud Storage, Google Drive ).&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&quot;drawbacks-of-in-situ-analysis&quot; tabindex=&quot;-1&quot;&gt;Drawbacks of in situ analysis &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/paper-dremel/#drawbacks-of-in-situ-analysis&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;ol&gt;
&lt;li&gt;users do not always want to or have the capability to manage their own data safely and securely&lt;/li&gt;
&lt;li&gt;in situ analysis means there is no opportunity to either optimize storage layout or compute statistics in the general case.&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&quot;serverless-computing&quot; tabindex=&quot;-1&quot;&gt;Serverless Computing &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/paper-dremel/#serverless-computing&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;h3 id=&quot;serverless-roots&quot; tabindex=&quot;-1&quot;&gt;Serverless roots &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/paper-dremel/#serverless-roots&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;Most traditional DBMS and data-warehouse were deployed on dedicated servers.&lt;/li&gt;
&lt;li&gt;MapReduce and Hadoop uses virtual machines but are still single-tenant.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Three core ideas in Dremel which enable serverless analytics:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Disaggregation of compute, storage and memory&lt;/li&gt;
&lt;li&gt;Fault Tolerance and Restartability
&lt;ul&gt;
&lt;li&gt;each subtask are deterministic and repeatable&lt;/li&gt;
&lt;li&gt;task dispatcher may need to dispatching multiple copies of the same task to alleviate unresponsive workers.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Virtual Scheduling Units
&lt;ul&gt;
&lt;li&gt;Dremel scheduling logic was designed to work with abstract units of compute and memory
called slots&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&quot;evolution-of-serverless-architecture&quot; tabindex=&quot;-1&quot;&gt;Evolution of serverless architecture &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/paper-dremel/#evolution-of-serverless-architecture&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;Dremel continued to evolve its serverless capabilities, making them one of the key characteristics of Google BigQuery today.&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;Centralized Scheduling&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;The scheduler uses the entire cluster state to make scheduling decisions which enables better utilization and isolation. (Figure 3)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;picture&gt;&lt;source type=&quot;image/avif&quot; srcset=&quot;https://hhow09.github.io/img/JY2-2bu-Gn-917.avif 917w&quot;&gt;&lt;source type=&quot;image/webp&quot; srcset=&quot;https://hhow09.github.io/img/JY2-2bu-Gn-917.webp 917w&quot;&gt;&lt;img alt=&quot;System architecture and execution inside a server
node&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; src=&quot;https://hhow09.github.io/img/JY2-2bu-Gn-917.png&quot; width=&quot;917&quot; height=&quot;636&quot;&gt;&lt;/picture&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Shuffle Persistence Layer&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;allow decoupling scheduling and execution of different stages of the query.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Flexible Execution DAGs&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;query coordinator builds the query plan (tree) and send to the workers&lt;/li&gt;
&lt;li&gt;Workers from the leaf stage read from the storage layer and write to the shuffle persistence layer.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;picture&gt;&lt;source type=&quot;image/avif&quot; srcset=&quot;https://hhow09.github.io/img/t7gCl1YkGY-708.avif 708w&quot;&gt;&lt;source type=&quot;image/webp&quot; srcset=&quot;https://hhow09.github.io/img/t7gCl1YkGY-708.webp 708w&quot;&gt;&lt;img alt=&quot;Shuffle-based execution plan&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; src=&quot;https://hhow09.github.io/img/t7gCl1YkGY-708.png&quot; width=&quot;708&quot; height=&quot;526&quot;&gt;&lt;/picture&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Dynamic Query Execution&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;query execution plan can dynamically change during runtime based on the statistics collected during query execution.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&quot;columar-storage-for-nested-data&quot; tabindex=&quot;-1&quot;&gt;Columar Storage For Nested Data &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/paper-dremel/#columar-storage-for-nested-data&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;The main design decision behind &lt;strong&gt;repetition and definition levels encoding&lt;/strong&gt; was to encode all structure information within the column itself, so it can be accessed without reading ancestor fields.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;repetition level: specifies for repeated values whether each ancestor record is appended into or starts a new value&lt;/li&gt;
&lt;li&gt;definition level: specifies which ancestor records are absent when an optional field is absent.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;In 2014, migration of the storage to an improved columnar format, &lt;a href=&quot;https://cloud.google.com/blog/products/bigquery/inside-capacitor-bigquerys-next-generation-columnar-storage-format&quot;&gt;Capacitor&lt;/a&gt;.&lt;/p&gt;
&lt;h2 id=&quot;embedded-evaluation&quot; tabindex=&quot;-1&quot;&gt;Embedded evaluation &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/paper-dremel/#embedded-evaluation&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;&lt;strong&gt;Capacitor&lt;/strong&gt; uses a number of techniques to make filtering efficient&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Partition and predicate pruning
&lt;ul&gt;
&lt;li&gt;Various statistics are maintained about the values in each column. They are used both to eliminate partitions that are guaranteed to not contain any matching rows, and to simplify the filter by removing tautologies&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Vectorization: &lt;a href=&quot;https://15721.courses.cs.cmu.edu/spring2019/papers/10-compression/abadi-sigmod2006.pdf&quot;&gt;Bit-Vector Encoding&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;Skip-indexes
&lt;ul&gt;
&lt;li&gt;Capacitor combines column values into segments, which are compressed individually.&lt;/li&gt;
&lt;li&gt;The column header contains an index with offsets pointing to the beginning of each segment.&lt;/li&gt;
&lt;li&gt;When the filter is very selective, Capacitor uses this index to skip segments that have no hits, avoiding their decompression.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Predicate reordering
&lt;ul&gt;
&lt;li&gt;Capacitor uses a number of heuristics to make filter reordering decisions, which take into account dictionary usage, unique value cardinality,&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&quot;row-reordering&quot; tabindex=&quot;-1&quot;&gt;Row reordering &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/paper-dremel/#row-reordering&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;run-length encodings (RLE) in particular is very sensitive to &lt;strong&gt;row ordering&lt;/strong&gt;.&lt;/li&gt;
&lt;li&gt;Usually, row order in the table does not have significance, so Capacitor is free to permute rows to improve RLE effectiveness.&lt;/li&gt;
&lt;li&gt;Capacitor’s row reordering algorithm uses sampling and heuristics to build an approximate model.&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;interactive-query-latency-over-big-data&quot; tabindex=&quot;-1&quot;&gt;Interactive Query Latency Over Big Data &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/paper-dremel/#interactive-query-latency-over-big-data&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;latency-reducing techniques implemented in Dremel:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;Stand-by server pool&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Speculative execution&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;small, fine-grained task&lt;/li&gt;
&lt;li&gt;duplicate tasks to prevent slow worker&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Multi-level execution trees&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Column-oriented schema representation&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Balancing CPU and IO with lightweight compression&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Approximate results&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Dremel uses one-pass algorithms that work well with the multi-level execution tree architecture.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Query latency tier&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;The dispatcher needed to be able to preempt the processing of parts of a query to allow a new user’s query to be processed.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Reuse of file operations&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;bottleneck for achieving low latency as thousands of Dremel workers send requests to the file system master(s) for metadata and to the chunk servers for open and read operations.&lt;/li&gt;
&lt;li&gt;The most important one: reuse metadata obtained from the file system by fetching it in a batch at the root server and passing it through the execution tree to the leaf servers for data reads.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Guaranteed capacity&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;a customer could reserve some capacity and use that capacity only for latency-sensitive workloads.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Adaptive query scaling&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&quot;reference&quot; tabindex=&quot;-1&quot;&gt;Reference &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/paper-dremel/#reference&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://15721.courses.cs.cmu.edu/spring2023/papers/19-bigquery/p3461-melnik.pdf&quot;&gt;Dremel: A Decade of Interactive SQL Analysis at Web Scale&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://cloud.google.com/blog/products/bigquery/bigquery-under-the-hood&quot;&gt;BigQuery under the hood&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://cloud.google.com/blog/products/bigquery/in-memory-query-execution-in-google-bigquery&quot;&gt;In-memory query execution in Google BigQuery&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://cloud.google.com/blog/products/bigquery/inside-capacitor-bigquerys-next-generation-columnar-storage-format&quot;&gt;Inside Capacitor, BigQuery’s next-generation columnar storage format&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</content>
	</entry>
	
	<entry>
		<title>Distributed ID Generation Solutions</title>
		<link href="https://hhow09.github.io/blog/distributed-id-generation/"/>
		<updated>2023-05-02T00:00:00Z</updated>
		<id>https://hhow09.github.io/blog/distributed-id-generation/</id>
		<content type="html">&lt;p&gt;Using auto-increment primary keys from traditional databases as ID for distributed systems can be inefficient and vulnerable to being predicted and analyzed.&lt;/p&gt;
&lt;p&gt;Nowadays, distributed systems require unique global identifiers; it is an essential task in distributed computing with growing internet usage.&lt;/p&gt;
&lt;h2 id=&quot;requirement&quot; tabindex=&quot;-1&quot;&gt;Requirement &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/distributed-id-generation/#requirement&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;h3 id=&quot;functional-requirement&quot; tabindex=&quot;-1&quot;&gt;Functional Requirement &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/distributed-id-generation/#functional-requirement&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;id should be globally unique&lt;/li&gt;
&lt;li&gt;low latency&lt;/li&gt;
&lt;li&gt;each node can generate id independently&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;nice-to-have-features&quot; tabindex=&quot;-1&quot;&gt;Nice to have features &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/distributed-id-generation/#nice-to-have-features&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;monotonicity (sortable by time)&lt;/li&gt;
&lt;li&gt;unpredictable&lt;/li&gt;
&lt;li&gt;high availability. Since an ID generator is a mission-critical system, it must be highly available.&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;popular-solutions&quot; tabindex=&quot;-1&quot;&gt;Popular Solutions &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/distributed-id-generation/#popular-solutions&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;ol&gt;
&lt;li&gt;UUID V4&lt;/li&gt;
&lt;li&gt;Nano ID&lt;/li&gt;
&lt;li&gt;ULID&lt;/li&gt;
&lt;li&gt;KSUID&lt;/li&gt;
&lt;li&gt;Mongdb objectID&lt;/li&gt;
&lt;li&gt;Snowflake ID&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&quot;overview&quot; tabindex=&quot;-1&quot;&gt;Overview &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/distributed-id-generation/#overview&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;Designing a distributed ID generation scheme can be divided into two steps&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Generate the binary ID, usually selected from pseudo-random numbers, time, and node ID.&lt;/li&gt;
&lt;li&gt;Convert the binary ID into a human-readable and easily transmittable string text.&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&quot;binary-id-generation&quot; tabindex=&quot;-1&quot;&gt;Binary ID Generation &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/distributed-id-generation/#binary-id-generation&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;h3 id=&quot;1-prng-pseudo-random-number-generator&quot; tabindex=&quot;-1&quot;&gt;1. PRNG (pseudo random number generator) &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/distributed-id-generation/#1-prng-pseudo-random-number-generator&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;ol&gt;
&lt;li&gt;UUID v4 (128 bit)&lt;/li&gt;
&lt;li&gt;Nano ID (no standard length)&lt;/li&gt;
&lt;/ol&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th style=&quot;text-align:center&quot;&gt;&lt;/th&gt;
&lt;th&gt;random number (bits)&lt;/th&gt;
&lt;th&gt;total (bits)&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:center&quot;&gt;UUID v4&lt;/td&gt;
&lt;td&gt;122&lt;/td&gt;
&lt;td&gt;128&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:center&quot;&gt;Nano ID&lt;/td&gt;
&lt;td&gt;126&lt;/td&gt;
&lt;td&gt;126&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h4 id=&quot;uuid-2&quot; tabindex=&quot;-1&quot;&gt;UUID &lt;a href=&quot;https://hhow09.github.io/blog/distributed-id-generation/#reference&quot;&gt;[2]&lt;/a&gt; &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/distributed-id-generation/#uuid-2&quot;&gt;#&lt;/a&gt;&lt;/h4&gt;
&lt;blockquote&gt;
&lt;p&gt;UUIDv4 consists of 128 bits, which are typically represented as 32 hexadecimal characters in the following format: xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx, where the digit &amp;quot;4&amp;quot; in the third group signifies the version (i.e., UUIDv4) and the digit &amp;quot;y&amp;quot; in the fourth group specifies the variant.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h4 id=&quot;pros&quot; tabindex=&quot;-1&quot;&gt;Pros &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/distributed-id-generation/#pros&quot;&gt;#&lt;/a&gt;&lt;/h4&gt;
&lt;ul&gt;
&lt;li&gt;Generating UUID is simple. No coordination between servers is needed so there will not be any synchronization issues.&lt;/li&gt;
&lt;li&gt;The system is easy to scale because each web server is responsible for generating IDs they consume. ID generator can easily scale with web servers.&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id=&quot;cons&quot; tabindex=&quot;-1&quot;&gt;Cons &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/distributed-id-generation/#cons&quot;&gt;#&lt;/a&gt;&lt;/h4&gt;
&lt;ul&gt;
&lt;li&gt;IDs are 128 bits long, but our requirement is 64 bits.&lt;/li&gt;
&lt;li&gt;IDs do not go up with time.&lt;/li&gt;
&lt;li&gt;IDs could be non-numeric.&lt;/li&gt;
&lt;/ul&gt;
&lt;h5&gt;Chance of duplicate ID&lt;/h5&gt;
&lt;blockquote&gt;
&lt;p&gt;With the sheer number of possible combinations (2^128), it would be almost impossible to generate a duplicate unless you are generating trillions of IDs every second, for many years.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h4 id=&quot;nano-id-3&quot; tabindex=&quot;-1&quot;&gt;Nano ID &lt;a href=&quot;https://hhow09.github.io/blog/distributed-id-generation/#reference&quot;&gt;[3]&lt;/a&gt; &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/distributed-id-generation/#nano-id-3&quot;&gt;#&lt;/a&gt;&lt;/h4&gt;
&lt;blockquote&gt;
&lt;p&gt;A tiny, secure, URL-friendly, unique string ID generator.
Small. 130 bytes (minified and gzipped). No dependencies. Size Limit controls the size.
Safe. It uses hardware random generator. Can be used in clusters.
Short IDs. It uses a larger alphabet than UUID (A-Za-z0-9_-). So ID size was reduced from 36 to 21 symbols.
Portable. Nano ID was ported to 20 programming languages.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&quot;2-timestamp-prng&quot; tabindex=&quot;-1&quot;&gt;2. Timestamp + PRNG &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/distributed-id-generation/#2-timestamp-prng&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th style=&quot;text-align:center&quot;&gt;&lt;/th&gt;
&lt;th&gt;timestamp (bits)&lt;/th&gt;
&lt;th&gt;random number (bits)&lt;/th&gt;
&lt;th&gt;total (bits)&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:center&quot;&gt;ULID&lt;/td&gt;
&lt;td&gt;48&lt;/td&gt;
&lt;td&gt;80&lt;/td&gt;
&lt;td&gt;128&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:center&quot;&gt;KSUID&lt;/td&gt;
&lt;td&gt;32&lt;/td&gt;
&lt;td&gt;128&lt;/td&gt;
&lt;td&gt;160&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h4 id=&quot;ulid-4&quot; tabindex=&quot;-1&quot;&gt;ULID &lt;a href=&quot;https://hhow09.github.io/blog/distributed-id-generation/#reference&quot;&gt;[4]&lt;/a&gt; &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/distributed-id-generation/#ulid-4&quot;&gt;#&lt;/a&gt;&lt;/h4&gt;
&lt;ul&gt;
&lt;li&gt;128-bit compatibility with UUID&lt;/li&gt;
&lt;li&gt;Lexicographically sortable!
&lt;ul&gt;
&lt;li&gt;timestamp: UNIX-time in milliseconds&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;No special characters (URL safe)&lt;/li&gt;
&lt;li&gt;Monotonic sort order (correctly detects and handles the same millisecond)&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id=&quot;ksuid-4&quot; tabindex=&quot;-1&quot;&gt;KSUID &lt;a href=&quot;https://hhow09.github.io/blog/distributed-id-generation/#reference&quot;&gt;[4]&lt;/a&gt; &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/distributed-id-generation/#ksuid-4&quot;&gt;#&lt;/a&gt;&lt;/h4&gt;
&lt;blockquote&gt;
&lt;p&gt;There are numerous methods for generating unique identifiers, so why KSUID?&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Naturally ordered by generation time&lt;/li&gt;
&lt;li&gt;Collision-free, coordination-free, dependency-free&lt;/li&gt;
&lt;li&gt;Highly portable representations&lt;/li&gt;
&lt;/ol&gt;
&lt;/blockquote&gt;
&lt;h3 id=&quot;3-timestamp-node-id-monotonic-counter&quot; tabindex=&quot;-1&quot;&gt;3. Timestamp + Node ID + Monotonic Counter &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/distributed-id-generation/#3-timestamp-node-id-monotonic-counter&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th style=&quot;text-align:center&quot;&gt;&lt;/th&gt;
&lt;th&gt;timestamp (bits)&lt;/th&gt;
&lt;th&gt;Node Id (bits)&lt;/th&gt;
&lt;th&gt;Process Id (bits)&lt;/th&gt;
&lt;th&gt;Counter (bits)&lt;/th&gt;
&lt;th&gt;total (bits)&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:center&quot;&gt;Snowflake ID&lt;/td&gt;
&lt;td&gt;41&lt;/td&gt;
&lt;td&gt;10&lt;/td&gt;
&lt;td&gt;-&lt;/td&gt;
&lt;td&gt;12&lt;/td&gt;
&lt;td&gt;64&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:center&quot;&gt;MongoDB ObjectID&lt;/td&gt;
&lt;td&gt;32&lt;/td&gt;
&lt;td&gt;24&lt;/td&gt;
&lt;td&gt;16&lt;/td&gt;
&lt;td&gt;24&lt;/td&gt;
&lt;td&gt;96&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;ul&gt;
&lt;li&gt;id is unique across different node and process&lt;/li&gt;
&lt;li&gt;counter ensure the uniqueness on same process of same node&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id=&quot;security-concern&quot; tabindex=&quot;-1&quot;&gt;Security Concern &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/distributed-id-generation/#security-concern&quot;&gt;#&lt;/a&gt;&lt;/h4&gt;
&lt;ul&gt;
&lt;li&gt;since the structure of id, the entropy of id is quite small, which means &lt;a href=&quot;https://github.com/andresriancho/mongo-objectid-predict&quot;&gt;easy to predict&lt;/a&gt;.&lt;/li&gt;
&lt;li&gt;It is dangerous through &lt;a href=&quot;https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/05-Authorization_Testing/04-Testing_for_Insecure_Direct_Object_References&quot;&gt;IDOR&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id=&quot;snowflake-id-6&quot; tabindex=&quot;-1&quot;&gt;Snowflake ID &lt;a href=&quot;https://hhow09.github.io/blog/distributed-id-generation/#reference&quot;&gt;[6]&lt;/a&gt; &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/distributed-id-generation/#snowflake-id-6&quot;&gt;#&lt;/a&gt;&lt;/h4&gt;
&lt;ul&gt;
&lt;li&gt;timestamp: Epoch in milliseconds precision
&lt;ul&gt;
&lt;li&gt;That gives us &lt;strong&gt;69&lt;/strong&gt; years with respect to a &lt;strong&gt;custom epoch&lt;/strong&gt;.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Node ID: 10 bits, this gives us 1024 nodes/machines.&lt;/li&gt;
&lt;li&gt;Local counter: 12 bits, The counter’s max value would be 4095.&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id=&quot;mongodb-objectid-7&quot; tabindex=&quot;-1&quot;&gt;MongoDB ObjectID &lt;a href=&quot;https://hhow09.github.io/blog/distributed-id-generation/#reference&quot;&gt;[7]&lt;/a&gt; &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/distributed-id-generation/#mongodb-objectid-7&quot;&gt;#&lt;/a&gt;&lt;/h4&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;The object ID is generated by the MongoDB driver instead of the database.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;The 12-byte ObjectId consists of:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;A 4-byte timestamp, representing the ObjectId&#39;s creation, measured in seconds since the Unix epoch.&lt;/li&gt;
&lt;li&gt;A 5-byte random value generated once per process. This random value is unique to the machine and process.&lt;/li&gt;
&lt;li&gt;A 3-byte incrementing counter, initialized to a random value.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;types-of-data-source&quot; tabindex=&quot;-1&quot;&gt;Types of data source &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/distributed-id-generation/#types-of-data-source&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;h3 id=&quot;pseudo-random-number&quot; tabindex=&quot;-1&quot;&gt;Pseudo random number &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/distributed-id-generation/#pseudo-random-number&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;h4 id=&quot;packages&quot; tabindex=&quot;-1&quot;&gt;Packages &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/distributed-id-generation/#packages&quot;&gt;#&lt;/a&gt;&lt;/h4&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://pkg.go.dev/crypto/rand&quot;&gt;crypto/rand&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://pkg.go.dev/math/rand&quot;&gt;math/rand&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id=&quot;considerations&quot; tabindex=&quot;-1&quot;&gt;Considerations &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/distributed-id-generation/#considerations&quot;&gt;#&lt;/a&gt;&lt;/h4&gt;
&lt;ul&gt;
&lt;li&gt;collisoin: longer bits gives lower chance of collision&lt;/li&gt;
&lt;li&gt;unpredictability: use &lt;code&gt;crypto/rand&lt;/code&gt; to lower unpredictability&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;reference&quot; tabindex=&quot;-1&quot;&gt;Reference &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/distributed-id-generation/#reference&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;ol&gt;
&lt;li&gt;&lt;a href=&quot;https://catcat.cc/post/2020-09-19/&quot;&gt;6 个流行的分布式 ID 方案之间的对决&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://datatracker.ietf.org/doc/html/rfc4122&quot;&gt;UUID&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/ai/nanoid&quot;&gt;Nano ID&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/ulid/spec&quot;&gt;ULID&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/segmentio/ksuid&quot;&gt;KSUID&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/bwmarrin/snowflake&quot;&gt;Snowflake ID&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://www.mongodb.com/docs/manual/reference/method/ObjectId/&quot;&gt;MongoDB ObjectID&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
</content>
	</entry>
	
	<entry>
		<title>JavaScript/TypeScript Development Notes</title>
		<link href="https://hhow09.github.io/blog/js-dev-notes/"/>
		<updated>2022-06-19T00:00:00Z</updated>
		<id>https://hhow09.github.io/blog/js-dev-notes/</id>
		<content type="html">&lt;p&gt;Some notes and gotchas I met in JS/TS development.&lt;/p&gt;
&lt;h2 id=&quot;trace-call-stack&quot; tabindex=&quot;-1&quot;&gt;Trace Call Stack &lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://hhow09.github.io/blog/js-dev-notes/#fn1&quot; id=&quot;fnref1&quot;&gt;[1]&lt;/a&gt;&lt;/sup&gt; &lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://hhow09.github.io/blog/js-dev-notes/#fn2&quot; id=&quot;fnref2&quot;&gt;[2]&lt;/a&gt;&lt;/sup&gt; &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/js-dev-notes/#trace-call-stack&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;pre class=&quot;language-javascript&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;foo&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;bar&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;bar&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;baz&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;baz&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Error&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;stack&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token function&quot;&gt;foo&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;hr&gt;
&lt;h2 id=&quot;console-log-an-object-is-pass-by-reference&quot; tabindex=&quot;-1&quot;&gt;&lt;code&gt;console.log&lt;/code&gt; an Object is pass by reference &lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://hhow09.github.io/blog/js-dev-notes/#fn3&quot; id=&quot;fnref3&quot;&gt;[3]&lt;/a&gt;&lt;/sup&gt; &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/js-dev-notes/#console-log-an-object-is-pass-by-reference&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;object is pass by reference&lt;/li&gt;
&lt;li&gt;object may have changed when log shows&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;solution&quot; tabindex=&quot;-1&quot;&gt;Solution &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/js-dev-notes/#solution&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;Don&#39;t use &lt;code&gt;console.log(obj)&lt;/code&gt;, use &lt;code&gt;console.log(JSON.parse(JSON.stringify(obj)))&lt;/code&gt; instead.&lt;/li&gt;
&lt;li&gt;This way you are sure you are seeing the value of obj at the moment you log it. Otherwise, many browsers provide a live view that constantly updates as values change. This may not be what you want.&lt;/li&gt;
&lt;li&gt;Or just use &lt;a href=&quot;https://code.visualstudio.com/docs/debugtest/debugging&quot;&gt;Debugger&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;hr&gt;
&lt;h2 id=&quot;deep-copy-v-s-shallow-copy&quot; tabindex=&quot;-1&quot;&gt;Deep Copy v.s. Shallow Copy &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/js-dev-notes/#deep-copy-v-s-shallow-copy&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;h4 id=&quot;shallow-copy&quot; tabindex=&quot;-1&quot;&gt;Shallow Copy &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/js-dev-notes/#shallow-copy&quot;&gt;#&lt;/a&gt;&lt;/h4&gt;
&lt;ol&gt;
&lt;li&gt;&lt;a href=&quot;https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/slice&quot;&gt;Array.prototype.slice()&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/assign&quot;&gt;Object.assign({}, obj)&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Spread_syntax&quot;&gt;Spread Syntax: A2 = {...A1}&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;h4 id=&quot;deep-copy&quot; tabindex=&quot;-1&quot;&gt;Deep Copy &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/js-dev-notes/#deep-copy&quot;&gt;#&lt;/a&gt;&lt;/h4&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;&lt;code&gt;JSON.parse(JSON.stringify(object))&lt;/code&gt;.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;If you do not use &lt;code&gt;circular reference&lt;/code&gt;, &lt;code&gt;Dates&lt;/code&gt;, &lt;code&gt;functions&lt;/code&gt;, &lt;code&gt;undefined&lt;/code&gt;, &lt;code&gt;Infinity&lt;/code&gt;, &lt;code&gt;RegExps&lt;/code&gt;, &lt;code&gt;Maps&lt;/code&gt;, &lt;code&gt;Sets&lt;/code&gt;, &lt;code&gt;Blobs&lt;/code&gt;, &lt;code&gt;FileLists&lt;/code&gt;, &lt;code&gt;ImageDatas&lt;/code&gt;, &lt;code&gt;sparse Arrays&lt;/code&gt;, &lt;code&gt;Typed Arrays&lt;/code&gt; or other complex types within your object, it is a very simple one liner to deep clone an object.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;with library: &lt;a href=&quot;https://lodash.com/docs#cloneDeep&quot;&gt;lodash - cloneDeep&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;hr&gt;
&lt;h2 id=&quot;initializing-2d-array-with-array-fill&quot; tabindex=&quot;-1&quot;&gt;Initializing 2D array with &lt;a href=&quot;https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/fill&quot;&gt;Array.fill&lt;/a&gt; &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/js-dev-notes/#initializing-2d-array-with-array-fill&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;if the filled value is Object, Array or function (pass by reference), they will reference to the same object.&lt;/li&gt;
&lt;/ul&gt;
&lt;pre class=&quot;language-javascript&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// filled each row with `same reference` of `new Array(4).fill(1)`.&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; list &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Array&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;fill&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Array&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;fill&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// filled each row with `different reference` of `new Array(4).fill(1)`.&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; list2 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Array&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;fill&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;map&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Array&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;fill&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

list&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
list2&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;list&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// false&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;//[&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;//  [ 1, 1, 2, 1 ],&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;//  [ 1, 1, 2, 1 ],&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;//  [ 1, 1, 2, 1 ]&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;//]&lt;/span&gt;
console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;list2&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// correct&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;//[&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;//  [ 1, 1, 1, 1 ],&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;//  [ 1, 1, 2, 1 ],&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;//  [ 1, 1, 1, 1 ]&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;//]&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;hr&gt;
&lt;h2 id=&quot;manipulate-with-floating-point-number&quot; tabindex=&quot;-1&quot;&gt;Manipulate with floating-point number &lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://hhow09.github.io/blog/js-dev-notes/#fn4&quot; id=&quot;fnref4&quot;&gt;[4]&lt;/a&gt;&lt;/sup&gt; &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/js-dev-notes/#manipulate-with-floating-point-number&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;pre class=&quot;language-javascript&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token number&quot;&gt;0.1&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0.2&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;===&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0.3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// false&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;numbersCloseEnoughToEqual&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;n1&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; n2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; Math&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;abs&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;n1 &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; n2&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; Number&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token constant&quot;&gt;EPSILON&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token function&quot;&gt;numbersCloseEnoughToEqual&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0.1&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0.2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0.3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;ul&gt;
&lt;li&gt;Don&#39;t calculate by yourself. rely on a library like &lt;a href=&quot;https://mikemcl.github.io/decimal.js/&quot;&gt;decimal.js&lt;/a&gt; or &lt;a href=&quot;https://github.com/MikeMcl/big.js#readme&quot;&gt;big.js&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;hr&gt;
&lt;h2 id=&quot;fetching-query-param&quot; tabindex=&quot;-1&quot;&gt;Fetching - Query Param &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/js-dev-notes/#fetching-query-param&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;Don&#39;t use string literal to build query param.
&lt;ul&gt;
&lt;li&gt;Otherwise empty space or &lt;code&gt;%00&lt;/code&gt; (turn into null) in param will definitely backfire you.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Use &lt;a href=&quot;https://developer.mozilla.org/en-US/docs/Web/API/URLSearchParams/URLSearchParams&quot;&gt;URLSearchParams&lt;/a&gt; to build query param.&lt;/li&gt;
&lt;li&gt;Use library like &lt;a href=&quot;https://www.npmjs.com/package/qs&quot;&gt;qs&lt;/a&gt; to build complex/nested query params.&lt;/li&gt;
&lt;/ul&gt;
&lt;hr&gt;
&lt;h2 id=&quot;key-order-of-object-keys-obj&quot; tabindex=&quot;-1&quot;&gt;Key order of &lt;code&gt;Object.keys(obj)&lt;/code&gt;? &lt;sup class=&quot;footnote-ref&quot;&gt;&lt;a href=&quot;https://hhow09.github.io/blog/js-dev-notes/#fn5&quot; id=&quot;fnref5&quot;&gt;[5]&lt;/a&gt;&lt;/sup&gt; &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/js-dev-notes/#key-order-of-object-keys-obj&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;h4 id=&quot;es5&quot; tabindex=&quot;-1&quot;&gt;ES5 &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/js-dev-notes/#es5&quot;&gt;#&lt;/a&gt;&lt;/h4&gt;
&lt;ul&gt;
&lt;li&gt;depend on browser&lt;/li&gt;
&lt;li&gt;ref: &lt;a href=&quot;https://262.ecma-international.org/5.1/#sec-15.2.3.14&quot;&gt;ECMA 5.0 Object.keys (O)&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;blockquote&gt;
&lt;ol start=&quot;5&quot;&gt;
&lt;li&gt;For each own enumerable property of O whose name String is P&lt;/li&gt;
&lt;/ol&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;Call the [[DefineOwnProperty]] internal method of array with arguments ToString(index), the PropertyDescriptor {[[Value]]: P, [[Writable]]: true, [[Enumerable]]: true, [[Configurable]]: true}, and false.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Increment index by 1.&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;If an implementation defines a specific order of enumeration for the for-in statement, that same enumeration order must be used in step 5 of this algorithm.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h4 id=&quot;es6&quot; tabindex=&quot;-1&quot;&gt;ES6: &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/js-dev-notes/#es6&quot;&gt;#&lt;/a&gt;&lt;/h4&gt;
&lt;ul&gt;
&lt;li&gt;depend on &lt;a href=&quot;https://262.ecma-international.org/6.0/#sec-ordinary-object-internal-methods-and-internal-slots-ownpropertykeys&quot;&gt;&lt;code&gt;OwnPropertyKeys&lt;/code&gt;&lt;/a&gt; method
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;Reflect.ownKeys&lt;/code&gt; also depend on &lt;code&gt;OwnPropertyKeys&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Order of &lt;a href=&quot;https://262.ecma-international.org/6.0/#sec-ordinary-object-internal-methods-and-internal-slots-ownpropertykeys&quot;&gt;&lt;code&gt;OwnPropertyKeys&lt;/code&gt;&lt;/a&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;integers&lt;/code&gt;: in numeric order&lt;/li&gt;
&lt;li&gt;&lt;code&gt;strings&lt;/code&gt;: in chronological order&lt;/li&gt;
&lt;li&gt;&lt;code&gt;Symbols&lt;/code&gt;: in chronological order&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;ref: &lt;a href=&quot;https://262.ecma-international.org/6.0/#sec-object.keys&quot;&gt;ECMA 6.0 Object.keys ( O )&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;pre class=&quot;language-javascript&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; obj &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;integer: 2&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token literal-property property&quot;&gt;foo&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;string: foo&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token string-property property&quot;&gt;&quot;01&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;string: 01&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;integer: 1&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;Symbol&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;first&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;symbol: first&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

obj&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;0&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;integer: 0&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
obj&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;Symbol&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;last&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;symbol: last&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
obj&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;veryLast&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;string: very last&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;Reflect&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;ownKeys&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;obj&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;// [ &quot;0&quot;, &quot;1&quot;, &quot;2&quot;, &quot;foo&quot;, &quot;01&quot;, &quot;veryLast&quot;, Symbol(first), Symbol(last) ]&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;hr&gt;
&lt;h2 id=&quot;remove-duplicate-element-in-array&quot; tabindex=&quot;-1&quot;&gt;Remove Duplicate Element in Array &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/js-dev-notes/#remove-duplicate-element-in-array&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;pre class=&quot;language-javascript&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; chars &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;A&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;B&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;A&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;C&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;B&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; uniqueChars &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; chars&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;filter&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;c&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; index&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; chars&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;indexOf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;c&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;===&lt;/span&gt; index&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;//[ &#39;A&#39;, &#39;B&#39;, &#39;C&#39; ]&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;h2 id=&quot;dom-element&quot; tabindex=&quot;-1&quot;&gt;DOM Element &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/js-dev-notes/#dom-element&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;h3 id=&quot;dom-element-is-a-special-object&quot; tabindex=&quot;-1&quot;&gt;DOM Element is a special object &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/js-dev-notes/#dom-element-is-a-special-object&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;pre class=&quot;language-javascript&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;var&lt;/span&gt; a &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; document&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;createElement&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;div&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;typeof&lt;/span&gt; a&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// &quot;object&quot;&lt;/span&gt;
&lt;span class=&quot;token class-name&quot;&gt;Object&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;prototype&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;toString&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;call&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;a&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// &quot;[object HTMLDivElement]&quot;&lt;/span&gt;
a&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;tagName&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// &quot;DIV&quot;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;ul&gt;
&lt;li&gt;Cannot call some built-in methods such as &lt;code&gt;toString()&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;Cannot be overwritten / override some properties such as &lt;code&gt;this&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;dom-element-will-produce-global-variable&quot; tabindex=&quot;-1&quot;&gt;DOM Element will produce global variable &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/js-dev-notes/#dom-element-will-produce-global-variable&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;be careful for duplicate naming.&lt;/p&gt;
&lt;pre class=&quot;language-html&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-html&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;div&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation attr-equals&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;foo&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;div&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&quot;language-javascript&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;foo&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// HTML Element&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;h2 id=&quot;using-await-inside-setinterval-is-pointless&quot; tabindex=&quot;-1&quot;&gt;using &lt;code&gt;await&lt;/code&gt; inside &lt;code&gt;setInterval&lt;/code&gt; is pointless &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/js-dev-notes/#using-await-inside-setinterval-is-pointless&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;since interval won&#39;t wait for &lt;code&gt;await&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;pre class=&quot;language-javascript&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;async&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;getData&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;fetch&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;url...&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; timer &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;setInterval&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;await&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;getData&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;above code can change into&lt;/p&gt;
&lt;pre class=&quot;language-javascript&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;async&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;getData&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;fetch&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;https://google.com&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;async&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;sleep&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;ms&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;await&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Promise&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;resolve&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;setTimeout&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;resolve&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; ms&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;periodicGetData&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Promise&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;async&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;resolve&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; reject&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;some_condition&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token function&quot;&gt;resolve&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; res &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;await&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;getData&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;res &lt;span class=&quot;token keyword&quot;&gt;instanceof&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Error&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token function&quot;&gt;reject&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;res&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;res&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; res&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;await&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;sleep&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;periodicGetData&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;periodicGetData&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;hr&gt;
&lt;h2 id=&quot;reference&quot; tabindex=&quot;-1&quot;&gt;Reference &lt;a class=&quot;header-anchor&quot; href=&quot;https://hhow09.github.io/blog/js-dev-notes/#reference&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;hr class=&quot;footnotes-sep&quot;&gt;
&lt;section class=&quot;footnotes&quot;&gt;
&lt;ol class=&quot;footnotes-list&quot;&gt;
&lt;li id=&quot;fn1&quot; class=&quot;footnote-item&quot;&gt;&lt;p&gt;&lt;a href=&quot;https://v8.dev/docs/stack-trace-api&quot;&gt;V8: Stack Trace API&lt;/a&gt; &lt;a href=&quot;https://hhow09.github.io/blog/js-dev-notes/#fnref1&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id=&quot;fn2&quot; class=&quot;footnote-item&quot;&gt;&lt;p&gt;&lt;a href=&quot;https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Error/stack&quot;&gt;MDN: Error.prototype.stack&lt;/a&gt; &lt;a href=&quot;https://hhow09.github.io/blog/js-dev-notes/#fnref2&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id=&quot;fn3&quot; class=&quot;footnote-item&quot;&gt;&lt;p&gt;&lt;a href=&quot;https://developer.mozilla.org/en-US/docs/Web/API/Console/log#logging_objects&quot;&gt;MDN: Logging objects&lt;/a&gt; &lt;a href=&quot;https://hhow09.github.io/blog/js-dev-notes/#fnref3&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id=&quot;fn4&quot; class=&quot;footnote-item&quot;&gt;&lt;p&gt;&lt;a href=&quot;https://github.com/getify/You-Dont-Know-JS&quot;&gt;You Don&#39;t Know JS&lt;/a&gt; &lt;a href=&quot;https://hhow09.github.io/blog/js-dev-notes/#fnref4&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id=&quot;fn5&quot; class=&quot;footnote-item&quot;&gt;&lt;p&gt;&lt;a href=&quot;https://www.stefanjudis.com/today-i-learned/property-order-is-predictable-in-javascript-objects-since-es2015/&quot;&gt;Property order is predictable in JavaScript objects since ES2015&lt;/a&gt; &lt;a href=&quot;https://hhow09.github.io/blog/js-dev-notes/#fnref5&quot; class=&quot;footnote-backref&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;/section&gt;
</content>
	</entry>
</feed>
